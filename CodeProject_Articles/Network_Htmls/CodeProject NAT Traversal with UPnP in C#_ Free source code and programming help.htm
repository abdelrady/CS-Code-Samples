<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!-- saved from url=(0054)http://www.codeproject.com/KB/IP/upnpnattraversal.aspx -->
<HTML><HEAD><TITLE>CodeProject: NAT Traversal with UPnP in C#. Free source code and programming help</TITLE>
<SCRIPT language=javascript src=""></SCRIPT>

<META http-equiv=Content-Type content="text/html; charset=utf-8">
<META 
content="NAT Traversal with UPnP in C#, without any libraries ; Author: harold aptroot; Section: Internet / Network; Chapter: Web Development" 
name=Description>
<META 
content=".NET 2.0, C# 1.0, C# 2.0, C# 3.0, C#, .NET, Dev, Intermediate,Internet / Network,Web Development,Free source code, tutorials" 
name=Keywords>
<META content="The Code Project" name=Author>
<META content=General name=Rating>
<META content="index, follow" name=Robots>
<META content="1 days" name=Revisit-After><LINK 
title="CodeProject Latest articles - All topics" 
href="http://www.codeproject.com/webservices/articlerss.aspx?cat=1" 
type=application/rss+xml rel=alternate><LINK 
title="CodeProject Latest articles - MFC / C++" 
href="http://www.codeproject.com/webservices/articlerss.aspx?cat=2" 
type=application/rss+xml rel=alternate><LINK 
title="CodeProject Latest articles - C#" 
href="http://www.codeproject.com/webservices/articlerss.aspx?cat=3" 
type=application/rss+xml rel=alternate><LINK 
title="CodeProject Latest articles - ASP.NET" 
href="http://www.codeproject.com/webservices/articlerss.aspx?cat=4" 
type=application/rss+xml rel=alternate><LINK 
title="CodeProject Latest articles - .NET" 
href="http://www.codeproject.com/webservices/articlerss.aspx?cat=5" 
type=application/rss+xml rel=alternate><LINK 
title="CodeProject Latest articles - VB.NET" 
href="http://www.codeproject.com/webservices/articlerss.aspx?cat=6" 
type=application/rss+xml rel=alternate><LINK title="CodeProject Lounge Postings" 
href="http://www.codeproject.com/webservices/LoungeRSS.aspx" 
type=application/rss+xml rel=alternate><LINK title=CodeProject 
href="http://www.codeproject.com/info/OpenSearch.xml" 
type=application/opensearchdescription+xml rel=search><LINK 
href="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/CodeProject.css" 
type=text/css rel=stylesheet><LINK 
href="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/ForumClassic.css" 
type=text/css rel=stylesheet>
<SCRIPT type=text/javascript>
  var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</SCRIPT>

<SCRIPT type=text/javascript>
   var pageTracker = _gat._getTracker("UA-1735123-1");
   pageTracker._setDomainName("www.codeproject.com");
   pageTracker._setSessionTimeout("1200"); // 20 mins
   pageTracker._initData();
   pageTracker._trackPageview();
</SCRIPT>

<SCRIPT language=Javascript 
src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/oncopy.js" 
type=text/javascript></SCRIPT>

<SCRIPT language=Javascript 
src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/jxs.js" 
type=text/javascript></SCRIPT>

<SCRIPT language=Javascript 
src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/bookmark.js" 
type=text/javascript></SCRIPT>

<SCRIPT language=Javascript 
src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/rateitem.js" 
type=text/javascript></SCRIPT>

<SCRIPT language=Javascript type=text/javascript>//<![CDATA[
function ToggleMenu(itemName)
{
	var elm = document.getElementById(itemName);
	var i,others = document.getElementById('SectionMenu');
	for(i=0; i < others.childNodes.length; i++)
	{
		var other = others.childNodes[i];
		if ((other.className == 'MenuSectionBlock') && (other != elm))
			other.style.display='none';
	}
	if (elm.style.display == 'block') elm.style.display='none';
	else elm.style.display='block';
	return false;
}

//]]></SCRIPT>

<SCRIPT language=Javascript 
src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/addto.js" 
type=text/javascript></SCRIPT>

<SCRIPT language=Javascript type=text/javascript>//<![CDATA[
function MarkAns(MemberID,MsgID,QID) {
 document.write(unescape("%3Cdiv class=\"CallOut\"%3E"));
 document.write("Was this a good answer to your question? ");
 document.write(unescape("%3Ca href=\"#xx" + MsgID.toString() + "xx\" "));
 document.write("onclick=\"RateMsg("+MemberID.toString()+", "+MsgID.toString()+",6,"+QID.toString()+");\"");
 document.write(unescape("%3E"));
 document.write(unescape("%3Cimg height=\"20\" width=\"20\" src=\"/script/Forums/Images/good.png\" alt=\"correct\" border=\"0\" align=\"absmiddle\" /%3E Yes%3C/a%3E"));
 document.write(unescape("%3Ca href=\"#xx" + MsgID.toString() + "xx\" "));
 document.write("onclick=\"RateMsg("+MemberID.toString()+","+MsgID.toString()+",7,"+QID.toString()+");\"");
 document.write(unescape("%3E"));
 document.write(unescape("%3Cimg height=\"20\" width=\"20\" src=\"/script/Forums/Images/bad.png\" alt=\"correct\" style=\"margin-left:10px\" border=\"0\" align=\"absmiddle\" /%3E No%3C/a%3E"));
 document.write(unescape("%3C/div%3E"));
}
function MsgVFrm(MemberID,MsgID,GB,gp,bp,mt){
 if(!GB)document.write("Rate this message: ");
 document.write(unescape("%3Ca href=\"#xx" + MsgID.toString() + "xx\" onclick=\"RateMsg(" + MemberID.toString() + ", " + MsgID.toString() + ","));document.write((GB?"5":"1")+unescape(",0);\"%3E"));
 if(GB) document.write(unescape("%3Cimg height=\"20\" width=\"20\" src=\"/script/Forums/Images/good.png\" alt=\"good\" border=\"0\" align=\"absmiddle\" /%3E "+gp+" "+mt+"%3C/a%3E "));
 else document.write(unescape("%3Cimg height=\"14\" width=\"14\" src=\"/script/Forums/Images/thumbs_down.gif\" alt=\"vote 1\" border=\"0\" align=\"middle\" /%3E%3C/a%3E "));
 if(GB)document.write(" &nbsp;"); else for(var i=1; i<=5;i++)
  document.write(unescape("%3Ca class=\"Frm_MHL\" href=\"#xx" + MsgID.toString() + "xx\" title=\"vote this message a " + i.toString() + "\" onclick=\"RateMsg(" + MemberID.toString() + ", " + MsgID.toString() + ", " + i.toString() + ",0)\"%3E%3Cb%3E" + i.toString() + "%3C/b%3E%3C/a%3E "));
 document.write(unescape("%3Ca href=\"#xx" + MsgID.toString() + "xx\" onclick=\"RateMsg(" + MemberID.toString() + ", " + MsgID.toString() + ","));document.write((GB?"1":"5")+unescape(",0);\"%3E"));
 if(GB)document.write(unescape("%3Cimg height=\"20\" width=\"20\" src=\"/script/Forums/Images/bad.png\" alt=\"bad\" border=\"0\" align=\"absmiddle\" /%3E "+bp+" "+mt+"%3C/a%3E"));
 else document.write(unescape("%3Cimg height=\"14\" width=\"14\" src=\"/script/Forums/Images/thumbs_up.gif\" border=\"0\" alt=\"vote 5\" align=\"middle\" /%3E%3C/a%3E "));
 if(GB)document.write(" &nbsp;&nbsp; "); else document.write(unescape("%3Cbr /%3E")); document.writeln(unescape("[%3Ca href='#xx") + MsgID.toString() +"xx' title='Report as Abuse' onclick='return ReportMsg(" + MemberID.toString());
 document.writeln(", " + MsgID.toString() + unescape(",-2)'%3EReport Message%3C/a%3E]"));
}

function ReportMsg(userid, msgid, score) {
 if (confirm("Are you sure you want to report this message?"))
  return RateMsg(userid, msgid, score, 0);
 else return false;
}
function RateMsg(memberid, msgid, score, questionId) {
 var req = new ActiveXObject("MSXML2.XMLHTTP");
 req.onreadystatechange = function() {
  if (req.readyState == 4){
   if (req.status == 200){
    var respText = req.responseText;
    var re = new RegExp(unescape("\%3Cdiv\%3E([^\%3C]*)\%3C/div\%3E"), "g");
    var match = re.exec(respText);
    voteStatus.innerHTML = unescape("%3Cb%3E") + (match&&match[1])?match[1]:"An error occured" + unescape("%3C/b%3E");
   } else
    voteStatus.innerHTML = unescape("%3Cb style='color:red'%3EFailed!") + req.statusText + unescape("%3C/b%3E");
  }
 }
 var voteStatus = document.getElementById("MVF" + msgid);
 if (!voteStatus) return;
 voteStatus.innerHTML = unescape("%3Cb style='color:green'%3EVoting...%3C/b%3E");
 var strAction = "/script/Forums/Vote.aspx?js=1&fmid="+memberid.toString()+"&select="+msgid.toString()+"&score="+score.toString()+"&qid="+questionId.toString();
 req.open("GET", strAction, true);
 req.send(null);
  return false;
}
//]]></SCRIPT>

<SCRIPT language=Javascript type=text/javascript>//<![CDATA[
var Selected = "-1";

function SwitchMessage(e, msgId)
{
  if (!msgId) {
    if(!e)e=window.event;
    var target=e.target?e.target:e.srcElement;
    while(target&&target.id!='DynMessLink')target=target.parentNode;
    if(!target||target.id!='DynMessLink')return;
    msgId=target.name;
  }
  if(Selected&&Selected!=""){
    var body=eval("document.getElementById('F" + Selected + "_h1')");
    if(body) body.style.display = 'none';
    var head=eval("document.getElementById('F" + Selected + "_h0')");
    if(head) head.className = head.className.replace("Sel", "UnSel");
  }
  if(Selected==msgId.toString())
    Selected="";
  else {
    Selected=msgId.toString();
    var body=eval("document.getElementById('F" + Selected + "_h1')");
    if(body){
      if(body.style.display=='none') body.style.display='';
      else body.style.display = 'none';
    }
    var head=eval("document.getElementById('F" + Selected + "_h0')");
    if (head) 
      head.className = head.className.replace("UnSel", "Sel");
    if(body&&head&&body.style.display!='none'){
      document.body.scrollTop = getRealPos(head, "Top") - document.body.clientHeight/10;
      EnsureMessageVisible(Selected, true);
    }
  }
  if (e){if(e.preventDefault)e.preventDefault;else e.returnValue=false;}
  return false;
}

//]]></SCRIPT>

<SCRIPT language=Javascript 
src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/ShortCuts.js" 
type=text/javascript></SCRIPT>
<LINK 
href="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/ForumClassicIE6.css" 
type=text/css rel=stylesheet><LINK href="/favicon.ico" type=image/ico 
rel=icon><LINK href="/favicon.ico" type=image/ico rel="shortcut icon">
<META content="MSHTML 6.00.2900.2180" name=GENERATOR></HEAD>
<BODY>
<TABLE id=ctl00_AT cellSpacing=0 cellPadding=0 border=0>
  <TBODY>
  <TR vAlign=top>
    <TD colSpan=2>
      <TABLE cellSpacing=0 cellPadding=0 border=0>
        <TBODY>
        <TR>
          <TD class=HeaderLogo><A href="http://www.codeproject.com/"><IMG 
            id=ctl00_Logo 
            style="BORDER-TOP-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; WIDTH: 225px; HEIGHT: 90px; BORDER-RIGHT-WIDTH: 0px" 
            alt="The Code Project" 
            src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/logo225x90.gif"></A></TD>
          <TD class=HeaderBanner align=right width="100%">
            <SCRIPT type=text/javascript>document.write(unescape("%3ca%20href%3d%22http%3a%2f%2fwww.codeproject.com%2fRedir.aspx%3fadid%3d7194%26way%3dban%22%20target%3d%22_blank%22%20rel%3d%22nofollow%22%3e%3cimg%20src%3d%22http%3a%2f%2fwww.codeproject.com%2fscript%2fAdm%2fServeImg.aspx%3fFile%3d%252fscript%252fAdm%252fimages%252fappdev_cp.sp07.72890.gif%26C%3dFalse%26adid%3d7194%22%20alt%3d%22%22%20border%3d%220%22%20width%3d%22728%22%20height%3d%2290%22%3e%3c%2fa%3e"));</SCRIPT>
          </TD></TR>
        <TR>
          <TD colSpan=2>
            <TABLE class=MemberNavBar cellSpacing=0 cellPadding=5 
              width="100%"><TBODY>
              <TR>
                <TD class=SmallText style="FONT-WEIGHT: bold">5,386,863 
                  members and growing! (14,830 online)</TD>
                <TD align=right>
                  <DIV class=MemberNavBarText 
                  id=ctl00_MemberMenu_LoggedOnOptions><A 
                  id=ctl00_MemberMenu_MyProfile 
                  href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=2959938">Abdelrady_FCIS</A> 
                  | <A id=ctl00_MemberMenu_MySettings 
                  href="http://www.codeproject.com/script/Membership/Modify.aspx">My 
                  Settings</A> | <A id=ctl00_MemberMenu_MyCodeProject 
                  href="http://www.codeproject.com/script/Membership/MyCodeProject.aspx"><B>My 
                  CodeProject</B></A> | <A id=ctl00_MemberMenu_MyBookmarks 
                  href="http://www.codeproject.com/script/Bookmarks/List.aspx?obtid=2"><IMG 
                  height=16 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/fave.gif" 
                  width=16 align=absMiddle border=0> My Bookmarks</A> | <A 
                  id=ctl00_MemberMenu_MyArticles 
                  href="http://www.codeproject.com/script/Articles/MemberArticles.aspx?amid=2959938">My 
                  Articles</A> | <A id=ctl00_MemberMenu_Signout 
                  href="http://www.codeproject.com/script/Membership/LogOff.aspx?rp=%2fKB%2fIP%2fupnpnattraversal.aspx">Sign 
                  out</A> </DIV></TD></TR></TBODY></TABLE></TD></TR>
        <TR>
          <TD colSpan=2>
            <TABLE class=SiteNavBar id=tblSiteToolbar cellSpacing=0 
            cellPadding=0>
              <TBODY>
              <TR>
                <TD noWrap><A href="http://www.codeproject.com/">Home</A></TD>
                <TD>&nbsp; </TD>
                <TD style="FONT-WEIGHT: normal" noWrap align=right>Current 
                  Site:</TD>
                <TD class=SelCat noWrap><A 
                  href="http://www.codeproject.com/">C++ / .NET</A></TD>
                <TD noWrap><A href="http://java.codeproject.com/">Java</A></TD>
                <TD noWrap><A href="http://sql.codeproject.com/">SQL</A></TD>
                <TD noWrap><A href="http://lamp.codeproject.com/">Linux / 
                  Unix</A></TD>
                <TD width="100%">&nbsp;</TD>
                <TD id=ctl00_TopNavBar_RightMenus>
                  <DIV id=MenuPos 
                  style="WIDTH: 380px; POSITION: relative; TOP: 1px; HEIGHT: 22px">
                  <TABLE 
                  style="BORDER-TOP-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; HEIGHT: 20px; BORDER-RIGHT-WIDTH: 0px" 
                  cellSpacing=0 cellPadding=0 width=380>
                    <TBODY>
                    <TR vAlign=center>
                      <TD 
                      style="BORDER-TOP-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px" 
                      noWrap><A 
                        href="http://www.codeproject.com/info/FAQ.aspx">Help!</A></TD>
                      <TD 
                      style="BORDER-TOP-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px" 
                      noWrap><A 
                        href="http://www.codeproject.com/script/Articles/Latest.aspx">Articles</A></TD>
                      <TD 
                      style="BORDER-TOP-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px" 
                      noWrap><A 
                        href="http://www.codeproject.com/script/Forums/List.aspx">Message 
                        Boards</A></TD>
                      <TD 
                      style="BORDER-TOP-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px" 
                      noWrap><A 
                        href="http://www.codeproject.com/script/Jobs/List.aspx">Job 
                        Board</A></TD>
                      <TD 
                      style="BORDER-TOP-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px" 
                      noWrap><A 
                        href="http://www.codeproject.com/Lounge.aspx">Lounge</A></TD></TR></TBODY></TABLE></DIV></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
  <TR>
    <TD vAlign=top colSpan=2><A name=_top></A>
      <TABLE class=ArticleUneditedHeader id=ctl00_ArticleTopHeader_HeaderTable 
      cellSpacing=0 cellPadding=3 width="100%" border=0>
        <TBODY>
        <TR vAlign=top>
          <TD class=SmallText><A id=ctl00_ArticleTopHeader_ChapterLink 
            href="http://www.codeproject.com/script/Content/Chapter.aspx?chptId=2">Web 
            Development</A> » <A id=ctl00_ArticleTopHeader_SectionLink 
            href="http://www.codeproject.com/KB/IP/">Internet / Network</A> » <A 
            id=ctl00_ArticleTopHeader_SubsectionLink 
            href="http://www.codeproject.com/KB/IP/index.aspx?#Internet / Network - Internet &amp; Network">Internet 
            &amp; Network</A> <SPAN class=ArticleIntermediate 
            id=ctl00_ArticleTopHeader_SkillLevel>&nbsp;&nbsp;&nbsp; 
            Intermediate</SPAN> <SPAN class=SmallText 
            id=ctl00_ArticleTopHeader_LicenceTerms 
            style="MARGIN-LEFT: 40px">License: <A 
            href="http://creativecommons.org/licenses/publicdomain/">A Public 
            Domain dedication</A></SPAN> <BR><BR>
            <H1><SPAN class=ArticleTopTitle 
            id=ctl00_ArticleTopHeader_ArticleTitle>NAT Traversal with UPnP in 
            C#</SPAN></H1><B>By <A 
            href="http://www.codeproject.com/script/Articles/MemberArticles.aspx?amid=4475648">harold 
            aptroot</A></B><BR><BR><SPAN class=ArticleTopDescr 
            id=ctl00_ArticleTopHeader_ArticleDescr>NAT Traversal with UPnP in 
            C#, without any libraries </SPAN></TD>
          <TD class=SmallText style="WIDTH: 210px"><SPAN 
            id=ctl00_ArticleTopHeader_ArticleAttributes>C# (C# 1.0, C# 2.0, C# 
            3.0, C#), .NET (.NET, .NET 2.0), Dev</SPAN><BR><BR><SPAN 
            style="WIDTH: 14ex">Posted</SPAN>: <B>21 Jul 2008</B><BR><SPAN 
            style="WIDTH: 14ex">Updated</SPAN>: <B>21 Jul 2008</B> <BR><SPAN 
            style="WIDTH: 14ex">Views</SPAN>: <B>3,061</B><BR><SPAN 
            style="WIDTH: 14ex">Bookmarked</SPAN>: <B>28 times</B><BR></TD></TR>
        <TR>
          <TD colSpan=2>
            <TABLE width="100%">
              <TBODY>
              <TR>
                <TD>
                  <DIV id=ctl00_ArticleTopHeader_UneditedDiv><B>Note: <A 
                  id=ctl00_ArticleTopHeader_UneditedLnk 
                  href="http://www.codeproject.com/script/Articles/Unedited.aspx">This 
                  is an unedited reader contribution</A></B> </DIV></TD>
                <TD class=SmallText style="WHITE-SPACE: nowrap" 
              align=right></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
  <TR vAlign=top>
    <TD class=LHNavBar id=ctl00_LeftNavCell>
      <DIV class=FeatureBlockHeader>Announcements</DIV>
      <DIV class="FeatureBlockContent RHFeatureBar" 
      style="PADDING-RIGHT: 0px; PADDING-LEFT: 0px; PADDING-BOTTOM: 0px; MARGIN: 0px; PADDING-TOP: 0px">
      <TABLE cellPadding=2>
        <TBODY>
        <TR vAlign=center>
          <TD><IMG height=10 alt=Comp 
            src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/startrek.gif" 
            width=24></TD>
          <TD><A 
            href="http://www.codeproject.com/script/Awards/Competition.aspx?cid=274">Summer 
            Code Competition!</A></TD></TR>
        <TR vAlign=center>
          <TD><IMG height=24 alt=Comp 
            src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/info_24.png" 
            width=24></TD>
          <TD><A 
            href="http://www.codeproject.com/script/Awards/Competition.aspx?cid=270">New 
            thawte <BR>Scavenger Hunt!</A></TD></TR>
        <TR vAlign=center>
          <TD><IMG height=24 alt=Comp 
            src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/info_24.png" 
            width=24 align=middle></TD>
          <TD><A id=ctl00_Announcements_CompLink 
            href="http://www.codeproject.com/Feature/ArticleCompetition/">Monthly 
            Competition</A></TD></TR></TBODY></TABLE></DIV>
      <DIV class=FeatureBlockHeader style="MARGIN-TOP: 7px">Want a new 
Job?</DIV>
      <DIV class="FeatureBlockContent RHFeatureBar">
      <UL class=InfoList>
        <LI><A 
        href="http://www.codeproject.com/script/Jobs/View.aspx?jid=132">ASP.NET/AJAX 
        Web Game Developer: 37 Signals Environment</A> at Hive7 in United States
        <LI><A 
        href="http://www.codeproject.com/script/Jobs/View.aspx?jid=77">ASP.NET 
        C# VB.NET SQL Developer</A> at High Power Consulting, Inc. in United 
        States
        <LI><A 
        href="http://www.codeproject.com/script/Jobs/View.aspx?jid=22">Product 
        Planner, Visual Studio</A> at Microsoft in United States
        <LI><A href="http://www.codeproject.com/script/Jobs/List.aspx">View 
        Latest Jobs...</A></LI></UL></DIV>
      <DIV id=SectionMenu>
      <DIV class=MenuCat>Chapters</DIV>
      <DIV class=MenuChapter><A onclick="return ToggleMenu('Chapter1');" 
      href="http://www.codeproject.com/script/Content/Chapter.aspx?chptId=1">Desktop 
      Development</A></DIV>
      <DIV class=MenuSectionBlock id=Chapter1 style="DISPLAY: none">
      <DIV class=MI id=Section1><A 
      href="http://www.codeproject.com/KB/buttons/">Button Controls</A></DIV>
      <DIV class=MI id=Section15><A 
      href="http://www.codeproject.com/KB/clipboard/">Clipboard</A></DIV>
      <DIV class=MI id=Section2><A 
      href="http://www.codeproject.com/KB/combobox/">Combo &amp; List 
      Boxes</A></DIV>
      <DIV class=MI id=Section67><A 
      href="http://www.codeproject.com/KB/dialog/">Dialogs and Windows</A></DIV>
      <DIV class=MI id=Section107><A 
      href="http://www.codeproject.com/KB/gadgets/">Desktop Gadgets</A></DIV>
      <DIV class=MI id=Section16><A 
      href="http://www.codeproject.com/KB/docview/">Document / View</A></DIV>
      <DIV class=MI id=Section4><A 
      href="http://www.codeproject.com/KB/edit/">Edit Controls</A></DIV>
      <DIV class=MI id=Section17><A 
      href="http://www.codeproject.com/KB/files/">Files and Folders</A></DIV>
      <DIV class=MI id=Section3><A 
      href="http://www.codeproject.com/KB/grid/">Grid &amp; Data 
      Controls</A></DIV>
      <DIV class=MI id=Section5><A 
      href="http://www.codeproject.com/KB/list/">List Controls</A></DIV>
      <DIV class=MI id=Section6><A 
      href="http://www.codeproject.com/KB/menus/">Menus</A></DIV>
      <DIV class=MI id=Section14><A 
      href="http://www.codeproject.com/KB/miscctrl/">Miscellaneous</A></DIV>
      <DIV class=MI id=Section18><A 
      href="http://www.codeproject.com/KB/printing/">Printing</A></DIV>
      <DIV class=MI id=Section95><A 
      href="http://www.codeproject.com/KB/progress/">Progress Controls</A></DIV>
      <DIV class=MI id=Section11><A 
      href="http://www.codeproject.com/KB/selection/">Selection 
      Controls</A></DIV>
      <DIV class=MI id=Section19><A 
      href="http://www.codeproject.com/KB/shell/">Shell and IE 
      programming</A></DIV>
      <DIV class=MI id=Section68><A 
      href="http://www.codeproject.com/KB/smart/">Smart Client</A></DIV>
      <DIV class=MI id=Section8><A 
      href="http://www.codeproject.com/KB/splitter/">Splitter Windows</A></DIV>
      <DIV class=MI id=Section9><A 
      href="http://www.codeproject.com/KB/static/">Static &amp; Panel 
      Controls</A></DIV>
      <DIV class=MI id=Section10><A 
      href="http://www.codeproject.com/KB/statusbar/">Status Bar</A></DIV>
      <DIV class=MI id=Section7><A 
      href="http://www.codeproject.com/KB/tabs/">Tabs &amp; Property 
      Pages</A></DIV>
      <DIV class=MI id=Section12><A 
      href="http://www.codeproject.com/KB/toolbars/">Toolbars &amp; Docking 
      windows</A></DIV>
      <DIV class=MI id=Section13><A 
      href="http://www.codeproject.com/KB/tree/">Tree Controls</A></DIV></DIV>
      <DIV class=MenuChapter><A onclick="return ToggleMenu('Chapter2');" 
      href="http://www.codeproject.com/script/Content/Chapter.aspx?chptId=2">Web 
      Development</A></DIV>
      <DIV class=MenuSectionBlock id=Chapter2>
      <DIV class=MI id=Section70><A 
      href="http://www.codeproject.com/KB/ajax/">Ajax and Atlas</A></DIV>
      <DIV class=MI id=Section27><A 
      href="http://www.codeproject.com/KB/applications/">Applications &amp; 
      Tools</A></DIV>
      <DIV class=MI id=Section85><A 
      href="http://www.codeproject.com/KB/asp/">ASP</A></DIV>
      <DIV class=MI id=Section89><A 
      href="http://www.codeproject.com/KB/aspnet/">ASP.NET</A></DIV>
      <DIV class=MI id=Section28><A 
      href="http://www.codeproject.com/KB/webforms/">ASP.NET Controls</A></DIV>
      <DIV class=MI id=Section38><A 
      href="http://www.codeproject.com/KB/ATL-Server/">ATL Server</A></DIV>
      <DIV class=MI id=Section29><A 
      href="http://www.codeproject.com/KB/web-cache/">Caching</A></DIV>
      <DIV class=MI id=Section91><A 
      href="http://www.codeproject.com/KB/web-image/">Charts, Graphs and 
      Images</A></DIV>
      <DIV class=MI id=Section25><A 
      href="http://www.codeproject.com/KB/scripting/">Client side 
      scripting</A></DIV>
      <DIV class=MI id=Section30><A 
      href="http://www.codeproject.com/KB/custom-controls/">Custom 
      Controls</A></DIV>
      <DIV class=MI id=Section23><A 
      href="http://www.codeproject.com/KB/HTML/">HTML / CSS</A></DIV>
      <DIV class=MIS id=Section22><A 
      href="http://www.codeproject.com/KB/IP/">Internet / Network</A></DIV>
      <DIV class=MI id=Section24><A 
      href="http://www.codeproject.com/KB/ISAPI/">ISAPI</A></DIV>
      <DIV class=MI id=Section33><A 
      href="http://www.codeproject.com/KB/server-management/">Site &amp; Server 
      Management</A></DIV>
      <DIV class=MI id=Section34><A 
      href="http://www.codeproject.com/KB/session/">Session State</A></DIV>
      <DIV class=MI id=Section113><A 
      href="http://www.codeproject.com/KB/silverlight/">Silverlight</A></DIV>
      <DIV class=MI id=Section36><A 
      href="http://www.codeproject.com/KB/trace/">Trace and Logs</A></DIV>
      <DIV class=MI id=Section31><A 
      href="http://www.codeproject.com/KB/user-controls/">User 
Controls</A></DIV>
      <DIV class=MI id=Section37><A 
      href="http://www.codeproject.com/KB/validation/">Validation</A></DIV>
      <DIV class=MI id=Section35><A 
      href="http://www.codeproject.com/KB/viewstate/">View State</A></DIV>
      <DIV class=MI id=Section26><A 
      href="http://www.codeproject.com/KB/WAP/">WAP / WML</A></DIV>
      <DIV class=MI id=Section32><A 
      href="http://www.codeproject.com/KB/web-security/">Web Security</A></DIV>
      <DIV class=MI id=Section20><A 
      href="http://www.codeproject.com/KB/webservices/">Web 
      Services</A></DIV></DIV>
      <DIV class=MenuChapter><A onclick="return ToggleMenu('Chapter9');" 
      href="http://www.codeproject.com/script/Content/Chapter.aspx?chptId=9">Enterprise 
      Systems</A></DIV>
      <DIV class=MenuSectionBlock id=Chapter9 style="DISPLAY: none">
      <DIV class=MI id=Section98><A 
      href="http://www.codeproject.com/KB/MCMS/">Content Management 
      Server</A></DIV>
      <DIV class=MI id=Section99><A 
      href="http://www.codeproject.com/KB/biztalk/">Microsoft BizTalk 
      Server</A></DIV>
      <DIV class=MI id=Section102><A 
      href="http://www.codeproject.com/KB/exchange/">Microsoft 
Exchange</A></DIV>
      <DIV class=MI id=Section90><A 
      href="http://www.codeproject.com/KB/office/">Office Development</A></DIV>
      <DIV class=MI id=Section101><A 
      href="http://www.codeproject.com/KB/sharepoint/">SharePoint 
      Server</A></DIV></DIV>
      <DIV class=MenuChapter><A onclick="return ToggleMenu('Chapter3');" 
      href="http://www.codeproject.com/script/Content/Chapter.aspx?chptId=3">Multimedia</A></DIV>
      <DIV class=MenuSectionBlock id=Chapter3 style="DISPLAY: none">
      <DIV class=MI id=Section42><A 
      href="http://www.codeproject.com/KB/audio-video/">Audio and 
Video</A></DIV>
      <DIV class=MI id=Section44><A 
      href="http://www.codeproject.com/KB/directx/">DirectX</A></DIV>
      <DIV class=MI id=Section46><A 
      href="http://www.codeproject.com/KB/GDI/">GDI</A></DIV>
      <DIV class=MI id=Section47><A 
      href="http://www.codeproject.com/KB/GDI-plus/">GDI+</A></DIV>
      <DIV class=MI id=Section43><A 
      href="http://www.codeproject.com/KB/graphics/">General Graphics</A></DIV>
      <DIV class=MI id=Section45><A 
      href="http://www.codeproject.com/KB/openGL/">OpenGL</A></DIV></DIV>
      <DIV class=MenuChapter><A onclick="return ToggleMenu('Chapter4');" 
      href="http://www.codeproject.com/script/Content/Chapter.aspx?chptId=4">Database</A></DIV>
      <DIV class=MenuSectionBlock id=Chapter4 style="DISPLAY: none">
      <DIV class=MI id=Section66><A 
      href="http://www.codeproject.com/KB/database/">Database</A></DIV>
      <DIV class=MI id=Section100><A 
      href="http://www.codeproject.com/KB/reporting-services/">SQL Reporting 
      Services</A></DIV></DIV>
      <DIV class=MenuChapter><A onclick="return ToggleMenu('Chapter8');" 
      href="http://www.codeproject.com/script/Content/Chapter.aspx?chptId=8">Platforms, 
      Frameworks &amp; Libraries</A></DIV>
      <DIV class=MenuSectionBlock id=Chapter8 style="DISPLAY: none">
      <DIV class=MI id=Section83><A 
      href="http://www.codeproject.com/KB/atl/">ATL</A></DIV>
      <DIV class=MI id=Section117><A 
      href="http://www.codeproject.com/KB/MFC/">MFC</A></DIV>
      <DIV class=MI id=Section88><A 
      href="http://www.codeproject.com/KB/stl/">STL</A></DIV>
      <DIV class=MI id=Section84><A 
      href="http://www.codeproject.com/KB/wtl/">WTL</A></DIV>
      <DIV class=MI id=Section49><A 
      href="http://www.codeproject.com/KB/COM/">COM / COM+</A></DIV>
      <DIV class=MI id=Section76><A 
      href="http://www.codeproject.com/KB/dotnet/">.NET Framework</A></DIV>
      <DIV class=MI id=Section92><A 
      href="http://www.codeproject.com/KB/winsdk/">Win32/64 SDK &amp; 
      OS</A></DIV>
      <DIV class=MI id=Section108><A 
      href="http://www.codeproject.com/KB/vista/">Vista API</A></DIV>
      <DIV class=MI id=Section110><A 
      href="http://www.codeproject.com/KB/vista-security/">Vista 
      Security</A></DIV>
      <DIV class=MI id=Section82><A 
      href="http://www.codeproject.com/KB/cross-platform/">Cross 
      Platform</A></DIV>
      <DIV class=MI id=Section69><A 
      href="http://www.codeproject.com/KB/game/">Game Development</A></DIV>
      <DIV class=MI id=Section73><A 
      href="http://www.codeproject.com/KB/mobile/">Mobile Development</A></DIV>
      <DIV class=MI id=Section106><A 
      href="http://www.codeproject.com/KB/WC/">Windows CardSpace</A></DIV>
      <DIV class=MI id=Section103><A 
      href="http://www.codeproject.com/KB/WCF/">Windows Communication 
      Foundation</A></DIV>
      <DIV class=MI id=Section104><A 
      href="http://www.codeproject.com/KB/WPF/">Windows Presentation 
      Foundation</A></DIV>
      <DIV class=MI id=Section105><A 
      href="http://www.codeproject.com/KB/WF/">Windows Workflow 
      Foundation</A></DIV>
      <DIV class=MI id=Section119><A 
      href="http://www.codeproject.com/KB/library/">Libraries</A></DIV>
      <DIV class=MI id=Section122><A 
      href="http://www.codeproject.com/KB/powershell/">Windows 
      Powershell</A></DIV>
      <DIV class=MI id=Section123><A 
      href="http://www.codeproject.com/KB/linq/">LINQ</A></DIV></DIV>
      <DIV class=MenuChapter><A onclick="return ToggleMenu('Chapter5');" 
      href="http://www.codeproject.com/script/Content/Chapter.aspx?chptId=5">Languages</A></DIV>
      <DIV class=MenuSectionBlock id=Chapter5 style="DISPLAY: none">
      <DIV class=MI id=Section71><A href="http://www.codeproject.com/KB/cpp/">C 
      / C++ Language</A></DIV>
      <DIV class=MI id=Section72><A 
      href="http://www.codeproject.com/KB/mcpp/">C++ / CLI</A></DIV>
      <DIV class=MI id=Section93><A 
      href="http://www.codeproject.com/KB/cs/">C#</A></DIV>
      <DIV class=MI id=Section78><A 
      href="http://www.codeproject.com/KB/msil/">MSIL</A></DIV>
      <DIV class=MI id=Section86><A 
      href="http://www.codeproject.com/KB/vbscript/">VBScript</A></DIV>
      <DIV class=MI id=Section87><A 
      href="http://www.codeproject.com/KB/vb/">VB.NET</A></DIV>
      <DIV class=MI id=Section115><A 
      href="http://www.codeproject.com/KB/vb-interop/">VB6 Interop</A></DIV>
      <DIV class=MI id=Section77><A 
      href="http://www.codeproject.com/KB/net-languages/">Other .NET 
      Languages</A></DIV>
      <DIV class=MI id=Section21><A 
      href="http://www.codeproject.com/KB/XML/">XML</A></DIV>
      <DIV class=MI id=Section96><A 
      href="http://www.codeproject.com/KB/java/">Java</A></DIV></DIV>
      <DIV class=MenuChapter><A onclick="return ToggleMenu('Chapter6');" 
      href="http://www.codeproject.com/script/Content/Chapter.aspx?chptId=6">General 
      Programming</A></DIV>
      <DIV class=MenuSectionBlock id=Chapter6 style="DISPLAY: none">
      <DIV class=MI id=Section57><A 
      href="http://www.codeproject.com/KB/recipes/">Algorithms &amp; 
      Recipes</A></DIV>
      <DIV class=MI id=Section64><A 
      href="http://www.codeproject.com/KB/bugs/">Bugs &amp; 
Workarounds</A></DIV>
      <DIV class=MI id=Section79><A 
      href="http://www.codeproject.com/KB/collections/">Collections</A></DIV>
      <DIV class=MI id=Section56><A 
      href="http://www.codeproject.com/KB/security/">Cryptography &amp; 
      Security</A></DIV>
      <DIV class=MI id=Section50><A 
      href="http://www.codeproject.com/KB/datetime/">Date and Time</A></DIV>
      <DIV class=MI id=Section52><A 
      href="http://www.codeproject.com/KB/DLL/">DLLs &amp; Assemblies</A></DIV>
      <DIV class=MI id=Section80><A 
      href="http://www.codeproject.com/KB/exception/">Exception 
      Handling</A></DIV>
      <DIV class=MI id=Section81><A 
      href="http://www.codeproject.com/KB/locale/">Localisation</A></DIV>
      <DIV class=MI id=Section53><A 
      href="http://www.codeproject.com/KB/macros/">Macros and Add-ins</A></DIV>
      <DIV class=MI id=Section54><A 
      href="http://www.codeproject.com/KB/tips/">Programming Tips</A></DIV>
      <DIV class=MI id=Section55><A 
      href="http://www.codeproject.com/KB/string/">String handling</A></DIV>
      <DIV class=MI id=Section58><A 
      href="http://www.codeproject.com/KB/threads/">Threads, Processes &amp; 
      IPC</A></DIV>
      <DIV class=MI id=Section59><A 
      href="http://www.codeproject.com/KB/winhelp/">WinHelp / 
      HTMLHelp</A></DIV></DIV>
      <DIV class=MenuChapter><A onclick="return ToggleMenu('Chapter10');" 
      href="http://www.codeproject.com/script/Content/Chapter.aspx?chptId=10">Graphics 
      / Design</A></DIV>
      <DIV class=MenuSectionBlock id=Chapter10 style="DISPLAY: none">
      <DIV class=MI id=Section40><A 
      href="http://www.codeproject.com/KB/expression/">Expression</A></DIV>
      <DIV class=MI id=Section114><A 
      href="http://www.codeproject.com/KB/usability/">Usability</A></DIV></DIV>
      <DIV class=MenuChapter><A onclick="return ToggleMenu('Chapter11');" 
      href="http://www.codeproject.com/script/Content/Chapter.aspx?chptId=11">Development 
      Lifecycle</A></DIV>
      <DIV class=MenuSectionBlock id=Chapter11 style="DISPLAY: none">
      <DIV class=MI id=Section51><A 
      href="http://www.codeproject.com/KB/debug/">Debug Tips</A></DIV>
      <DIV class=MI id=Section39><A 
      href="http://www.codeproject.com/KB/architecture/">Design and 
      Architecture</A></DIV>
      <DIV class=MI id=Section112><A 
      href="http://www.codeproject.com/KB/install/">Installation</A></DIV>
      <DIV class=MI id=Section41><A 
      href="http://www.codeproject.com/KB/work/">Work Issues</A></DIV>
      <DIV class=MI id=Section126><A 
      href="http://www.codeproject.com/KB/codegen/">Code 
      Generation</A></DIV></DIV>
      <DIV class=MenuChapter><A onclick="return ToggleMenu('Chapter7');" 
      href="http://www.codeproject.com/script/Content/Chapter.aspx?chptId=7">General 
      Reading</A></DIV>
      <DIV class=MenuSectionBlock id=Chapter7 style="DISPLAY: none">
      <DIV class=MI id=Section60><A 
      href="http://www.codeproject.com/KB/books/">Book Chapters</A></DIV>
      <DIV class=MI id=Section61><A 
      href="http://www.codeproject.com/KB/book-reviews/">Book Reviews</A></DIV>
      <DIV class=MI id=Section109><A 
      href="http://www.codeproject.com/KB/hardware-review/">Hardware 
      Reviews</A></DIV>
      <DIV class=MI id=Section63><A 
      href="http://www.codeproject.com/KB/interviews/">Interviews</A></DIV>
      <DIV class=MI id=Section62><A 
      href="http://www.codeproject.com/KB/scrapbook/">Scrapbook</A></DIV>
      <DIV class=MI id=Section48><A 
      href="http://www.codeproject.com/KB/system/">Hardware &amp; 
      System</A></DIV></DIV>
      <DIV class=MenuChapter><A onclick="return ToggleMenu('Chapter12');" 
      href="http://www.codeproject.com/script/Content/Chapter.aspx?chptId=12">Third 
      Party Products</A></DIV>
      <DIV class=MenuSectionBlock id=Chapter12 style="DISPLAY: none">
      <DIV class=MI id=Section65><A 
      href="http://www.codeproject.com/KB/showcase/">Product Showcase</A></DIV>
      <DIV class=MI id=Section124><A 
      href="http://www.codeproject.com/KB/solution-center/">Solution 
      Center</A></DIV></DIV></DIV><BR>
      <DIV class=MenuCat>Services</DIV>
      <DIV class=MenuChapter><A 
      href="http://www.codeproject.com/script/Jobs/List.aspx">Job 
Board</A></DIV>
      <DIV class=MenuChapter><A 
      href="http://www.codeproject.com/Services/coffee.aspx">Code Project 
      Coffee</A></DIV>
      <DIV class=MenuChapter><A 
      href="http://www.codeproject.com/Services/TradePub.aspx">Free 
      Magazines</A></DIV><BR>
      <DIV class=MenuCat>Feature Zones</DIV>
      <DIV class=MenuChapter><A 
      href="http://www.codeproject.com/kb/Showcase/">Product Showcase</A></DIV>
      <DIV class=MenuChapter><A href="http://www.codeproject.com/Zones/IBM">IBM 
      DeveloperWorks</A></DIV>
      <DIV class=MenuChapter><A 
      href="http://www.codeproject.com/Zones/WhitePapers">WhitePapers / 
      Webcasts</A></DIV>
      <DIV class=MenuChapter><A 
      href="http://www.codeproject.com/Zones/QuestSQL">Quest SQL Zone</A></DIV>
      <DIV class=MenuChapter><A 
      href="http://www.codeproject.com/Zones/Acresso">InstallShield 
      2009</A></DIV><BR>
      <DIV style="MARGIN-BOTTOM: 10px; TEXT-ALIGN: center">
      <SCRIPT type=text/javascript>document.write(unescape("%3ca%20href%3d%22http%3a%2f%2fwww.codeproject.com%2fRedir.aspx%3fadid%3d5302%26way%3dban%22%20target%3d%22_blank%22%20rel%3d%22nofollow%22%3e%3cimg%20src%3d%22http%3a%2f%2fwww.codeproject.com%2fscript%2fAdm%2fServeImg.aspx%3fFile%3d%252fscript%252fadmentor%252fimages%252fIBMdeveloperWorks_150x80.gif%26C%3dFalse%26adid%3d5302%22%20alt%3d%22%22%20border%3d%220%22%20width%3d%22150%22%20height%3d%2280%22%3e%3c%2fa%3e"));</SCRIPT>
      </DIV><IFRAME 
      src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/ServeHTML.htm" 
      frameBorder=0 width=160 scrolling=no height=600></IFRAME></TD>
    <TD class=ArticlePane vAlign=top>
      <TABLE class=SearchHeaderBar cellSpacing=0 width="100%">
        <TBODY>
        <TR>
          <TD style="WIDTH: 60%; WHITE-SPACE: nowrap" vAlign=center 
            align=right><FORM style="MARGIN: 0px" name=Search 
            action=/info/search.aspx method=get><B>Search &nbsp;</B> <INPUT 
            class=SmallText style="WIDTH: 200px" name=artkw> <SELECT 
            class=SmallText style="FONT-WEIGHT: bold" name=sbo> <OPTION 
              value=kw selected>Articles</OPTION> <OPTION 
              value=fm>Messages</OPTION> <OPTION value=s>Jobs</OPTION></SELECT> <INPUT class=SmallText style="FONT-WEIGHT: bold" type=submit value=" Go! "> 
            &nbsp; </FORM></TD>
          <TD class=TinyText style="WHITE-SPACE: nowrap"><A 
            href="http://www.codeproject.com/info/search.aspx">Advanced 
            Search</A><BR><A 
            href="http://www.codeproject.com/script/Content/SiteMap.aspx">Sitemap</A> 
            | <A id=ctl00_SearchBarCtrl_AddToIESearchLnk 
            title="Add The Code Project to your IE search Providers" 
            onclick="window.external.AddSearchProvider('http://www.codeproject.com/info/OpenSearch.xml');return false;" 
            href="http://www.codeproject.com/">Add to IE Search</A> 
        </TD></TR></TBODY></TABLE><SPAN id=ctl00_ResultMessage></SPAN>
      <DIV id=ctl00_ArtDiv>
      <TABLE cellSpacing=0 cellPadding=0 width="100%" border=0>
        <TBODY>
        <TR vAlign=top>
          <TD vAlign=top>
            <TABLE>
              <TBODY></TBODY></TABLE>
            <DIV class=SmallText><IMG style="VERTICAL-ALIGN: middle" height=16 
            alt=print 
            src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/print.gif" 
            width=16> <A id=ctl00_ArticleHeaderLinks_PrintLnk 
            href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?display=Print">Print</A> 
            &nbsp; <IMG style="VERTICAL-ALIGN: middle" height=16 
            alt="Broken Article?" 
            src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/report.gif" 
            width=16> <A id=ctl00_ArticleHeaderLinks_BrokenLnk 
            href="http://www.codeproject.com/script/Articles/Report.aspx?aid=27992">Report 
            Article</A> &nbsp; <IMG style="VERTICAL-ALIGN: middle" alt=Watch 
            src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/watchon.png"> 
            <A class="" id=bmw_27992,2 onclick="return watchMe(27992, 2);" 
            href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=27992&amp;obtid=2&amp;bma=AddWatch" 
            name=ajaxBookmarkWatchLink>Watch</A> <SPAN class=TinyText 
            style="VISIBILITY: hidden"></SPAN><SPAN 
            id=ctl00_ArticleHeaderLinks_ArticleBmkWatch_Message></SPAN>&nbsp; 
            <IMG style="VERTICAL-ALIGN: middle" height=16 alt=Bookmark 
            src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/link.png" 
            width=16> <A class="" id=bm_27992,2 
            onclick="return bookmarkMe(27992, 2);" 
            href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=27992&amp;obtid=2&amp;bma=AddBookmark" 
            name=ajaxBookmarkLink>Bookmark</A> <SPAN class=TinyText 
            style="VISIBILITY: hidden"></SPAN><SPAN 
            id=ctl00_ArticleHeaderLinks_ArticleBmk_Message></SPAN>&nbsp; <IMG 
            style="VERTICAL-ALIGN: middle" height=16 alt=Discuss 
            src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/discuss.gif" 
            width=15> <A 
            href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx#_comments">Discuss</A> 
            &nbsp; <IMG style="VERTICAL-ALIGN: middle" height=16 
            alt="Recommend Article" 
            src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/mail.gif" 
            width=16>&nbsp;<A id=ctl00_ArticleHeaderLinks_Recommend 
            href="http://www.codeproject.com/script/common/TellFriend.aspx?obtid=2&amp;obid=27992">Send&nbsp;to&nbsp;a&nbsp;friend</A> 
            </DIV></TD>
          <TD style="WIDTH: 100px; WHITE-SPACE: nowrap; TEXT-ALIGN: right">
            <TABLE id=CurRat>
              <TBODY>
              <TR>
                <TD>
                  <TABLE>
                    <TBODY>
                    <TR>
                      <TD class=SmallText id=ctl00_ArticleRating_VL 
                      style="WHITE-SPACE: nowrap" align=right><SPAN 
                        id=ctl00_ArticleRating_VoteLabel>9 votes for this 
                        Article.</SPAN></TD>
                      <TD>
                        <TABLE cellSpacing=0 cellPadding=0 border=1>
                          <TBODY>
                          <TR>
                            <TD width=20 bgColor=white height=7><IMG height=7 
                              src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/red.gif" 
                              width=20 align=center border=0></TD>
                            <TD width=20 bgColor=white height=7><IMG height=7 
                              src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/red.gif" 
                              width=20 align=center border=0></TD>
                            <TD width=20 bgColor=white height=7><IMG height=7 
                              src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/red.gif" 
                              width=20 align=center border=0></TD>
                            <TD width=20 bgColor=white height=7><IMG height=7 
                              src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/red.gif" 
                              width=20 align=center border=0></TD>
                            <TD noWrap width=20 bgColor=white height=7><IMG 
                              height=7 
                              src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/red.gif" 
                              width=4 align=center 
                      border=0></TD></TR></TBODY></TABLE></TD></TR>
                    <TR id=ctl00_ArticleRating_PopularityRow>
                      <TD class=SmallText align=right colSpan=2><A 
                        id=ctl00_ArticleRating_PopularityLnk 
                        title="Calculated as rating x Log10(# votes)" 
                        href="http://www.codeproject.com/script/Articles/TopArticles.aspx?ta_so=1">Popularity: 
                        4.01</A> <SPAN 
                        id=ctl00_ArticleRating_PopularityLbl></SPAN><SPAN 
                        id=ratingVal>Rating: <B>4.20</B> out of 
                    5</SPAN></TD></TR></TBODY></TABLE></TD>
                <TD>
                  <DIV>
                  <TABLE class=HistTable 
                  title="Voting Distribution. Recent data only">
                    <TBODY>
                    <TR>
                      <TD><IMG title="1 vote, 11.1%" height=3 
                        alt="1 vote, 11.1%" 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/pollcol.gif" 
                        width=10 border=0><BR>1</TD>
                      <TD><IMG title="0 votes, 0.0%" height=1 
                        alt="0 votes, 0.0%" src="" width=10 border=0><BR>2</TD>
                      <TD><IMG title="0 votes, 0.0%" height=1 
                        alt="0 votes, 0.0%" src="" width=10 border=0><BR>3</TD>
                      <TD><IMG title="2 votes, 22.2%" height=6 
                        alt="2 votes, 22.2%" 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/pollcol.gif" 
                        width=10 border=0><BR>4</TD>
                      <TD><IMG title="6 votes, 66.7%" height=20 
                        alt="6 votes, 66.7%" 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/pollcol.gif" 
                        width=10 
              border=0><BR>5</TD></TD></TR></TBODY></TABLE></DIV></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE>
      <DIV class=SmallText id=ctl00_UneditedRow 
      style="PADDING-RIGHT: 5px; BORDER-TOP: #ff9900 1px dashed; PADDING-LEFT: 5px; PADDING-BOTTOM: 5px; MARGIN: 5px; PADDING-TOP: 5px; BORDER-BOTTOM: #ff9900 1px dashed"><B>Note:</B> 
      This is an unedited contribution. If this article is inappropriate, needs 
      attention or copies someone else's work without reference then please <A 
      id=ctl00_ReportProblem 
      href="http://www.codeproject.com/script/Articles/Report.aspx?aid=27992">Report 
      This Article</A> </DIV><SPAN id=intelliTXT>
      <DIV id=contentdiv><!-- Main Page Contents Start --><!-- Article Starts -->
      <UL class=Download>
        <LI><A 
        href="http://www.codeproject.com/KB/IP/upnpnattraversal/NATUPnP.zip"></A><A 
        href="http://www.codeproject.com/KB/IP/upnpnattraversal/NATUPnP.zip">Download 
        NATUPnP.zip - 3.89 KB </A></LI></UL>
      <H2>Introduction</H2>
      <P>In writing network code, NAT can be a real problem. For most 
      applications, requiring the user to add port forwarding rules to their 
      router is not a good idea, or even unacceptable, because often users are 
      not allowed to change the settings of their router or do not know how to 
      do so.</P>
      <P>Fortunately, there are ways to automate the process of adding port 
      forwarding rules. UPnP is one of the ways, to my knowledge the most 
      commonly used way.</P>
      <P>An other major problem with networking programs is that they appear to 
      have no reliable way of finding the external IP address of the computer it 
      is running on. UPnP partly solves this, but it is of course not completely 
      reliable (not all routers support it, and routers that do may have UPnP 
      turned off for security reasons).</P>
      <P>If you ever tried to use existing UPnP libraries you may have found 
      that most of them simply do not work, or do not cover the NAT aspects of 
      it. This prompted me to write my own, very small, UPnP library that 
      <EM>only</EM> covers the NAT aspects, and not even fully at that - only 
      UPnP device discovery, basic port forwarding and retrieving the external 
      IP address. However, for many networking programs, this is all that is 
      needed. </P>
      <H2>Using the code </H2>
      <P>In the source code you will find a public class NAT, containing the 
      following public methods:</P>
      <UL>
        <LI>static string Discover() 
        <LI>static IPAddress GetExternalIP()
        <LI>static void ForwardPort(int port, ProtocolType protocol, string 
        description)
        <LI>static void DeleteForwardingRule(int port, ProtocolType protocol)
        <LI>static XmlDocument GetPortMappingEntry(int index)</LI></UL>
      <P>Please note that these methods do not check for any errors and will 
      fail if there is no UPnP device or if the first UPnP device to reply to 
      the broadcasted discovery message is not a NAT device. Before 
      GetExternalIP or ForwardPort will work, Discover has to be called. 
      Discover can take several seconds, possibly minutes in some cases, so for 
      any GUI application it is advisable to place the call on a separate 
      thread. </P>
      <P>To forward a port, the simplest way, code like this will 
      suffice:<BR></P><PRE lang=cs>        UPnP.NAT.Discover();
        UPnP.NAT.ForwardPort(<SPAN class=code-digit>12345</SPAN>, ProtocolType.Tcp, <SPAN class=code-string>"</SPAN><SPAN class=code-string>MyApp (TCP)"</SPAN>);
</PRE>
      <P>In practice, it would be best to check for exceptions. </P>
      <H2>UPnP + NAT</H2>
      <P>For the people who want to do it themselves, or who are interested, 
      here is what I found out about UPnP in combination with NAT routers.</P>
      <P>The first thing to do is finding the UPnP device you are interested in. 
      Apparently, the best way to do that is by using SSDP.</P>
      <P>Finding the UPnP device using SSDP comes down to broadcasting a single 
      packet over UDP and examining the replies. The packet looks like this (or 
      at least, when it looks like this it'll work):</P><PRE lang=cs>            <SPAN class=code-string>"</SPAN><SPAN class=code-string>M-SEARCH * HTTP/1.1\r\n"</SPAN> +
            <SPAN class=code-string>"</SPAN><SPAN class=code-string>HOST: 239.255.255.250:1900\r\n"</SPAN> +
            <SPAN class=code-string>"</SPAN><SPAN class=code-string>ST:upnp:rootdevice\r\n"</SPAN> +
            <SPAN class=code-string>"</SPAN><SPAN class=code-string>MAN:\"ssdp:discover\"\r\n"</SPAN> +
            <SPAN class=code-string>"</SPAN><SPAN class=code-string>MX:3\r\n\r\n"</SPAN>;</PRE>
      <P>in ASCII. While the Host is 239.255.255.250, the packet still has to be 
      broadcasted to the standard IPAddress.Broadcast address.<BR></P>
      <P>Examining the replies is pretty straightforward. You should only get 
      one, but if you get more anyway, the right one is identifiable. A standard 
      reply from a NAT device looks like this:</P><PRE lang=text>HTTP/1.1 200 OK
ST:upnp:rootdevice
USN:uuid:00-0C-F6-12-95-D3-FE7BA8C00::upnp:rootdevice
Location:http://192.168.123.254:80/desc.xml
Cache-Control:max-age=1800
Server:IGD-HTTP/1.1 UPnP/1.0 UPnP-Device-Host/1.0
Ext: </PRE>
      <P>The ST should be "upnp:rootdevice", if it's not it isn't the right 
      device and it shouldn't have replied in the first place, but one never 
      knows what happens in a network.</P>
      <P>Anyhow, we're interested in the Location, since at that location there 
      will be an XML file containing information about the device - we will need 
      this to find out how to send commands to the device.</P>
      <P>Sending commands to a UPnP device is made possible through something 
      they called a "service". The XML file describing the device is quite long, 
      so suffice it to know that the XPath to the service we're interested in 
      is</P><PRE lang=cs><SPAN class=code-string>"</SPAN><SPAN class=code-string>//tns:service[tns:serviceType=\"urn:schemas-upnp-org:service:WANIPConnection:1\"]/tns:controlURL/text()"</SPAN></PRE>
      <P>Since it uses namespaces you will have to use an XmlNamespaceManager, 
      but that's a whole different subject.</P>
      <P>The result of this query should look somewhat like "/serv3.xml", once 
      again an XML file. Note that this is a relative location, so you will need 
      to append it to the base-url, which is "http://192.168.123.254:80" in this 
      example.</P>
      <P>This file has a double purpose: first, its contents tell you something 
      about what kinds of commands it accepts and how it will reply to them, and 
      second, you will be POST-ing SOAP to it. That's correct, XML again.</P>
      <P>Before this, I had never used a HTTP-POST on an XML file, and it 
      greatly surprised me, but apparently this is the way it should work. </P>
      <P>Sending commands then is just using SOAP in the right way. However, 
      this is not very straightforward - if you are using a WebRequest (as am I) 
      then you will not only have to set the Method to "POST" but also add a 
      header, and change the content-type: </P><PRE lang=cs> Headers.Add(<SPAN class=code-string>"</SPAN><SPAN class=code-string>SOAPACTION"</SPAN>, <SPAN class=code-string>"</SPAN><SPAN class=code-string>\"urn:schemas-upnp-org:service:WANIPConnection:1#"</SPAN> + function + <SPAN class=code-string>"</SPAN><SPAN class=code-string>\""</SPAN>); 
 ContentType = <SPAN class=code-string>"</SPAN><SPAN class=code-string>text/xml; charset=\"utf-8\""</SPAN>;
</PRE>
      <P>The variable <CODE>function</CODE> here must be the same as the 
      function you are sending in the contents.<BR></P>
      <P>That is pretty much all there is to it. With this information you 
      should be able to implement your own UPnP NAT traversal methods.</P>
      <H2>Points of Interest </H2>
      <P>While writing the code for this tiny library I was absolutely stunned 
      by the complete absence of clear information on the subject. Most sites 
      deal only with UPnP for media and such, or explain the lack of security of 
      UPnP NAT-traversal, without going very far into detail on how to actually 
      <EM>do </EM>it. When there <EM>is</EM> such information, it is generally 
      written in such a way that at least I do not understand half of it. </P>
      <P>In the end, I used WireShark to examine µTorrent's UPnP traffic, and 
      reverse-engineered the process. I hope that this article changes matters 
      for some people so that they will not have to reverse-engineer anything to 
      get UPnP NAT-traversal working. </P>
      <H2>History</H2>
      <P>July 18th, 2008: Wrote the first version of the UPnP NAT library. </P>
      <P>July 22nd, 2008: Wrote the first version of this article.</P>
      <P>July 22nd, 2008 (later that day): Updated the source and the article to 
      work on some stricter routers and in cases where the port is not 80 (with 
      thanks to <A 
      href="http://www.codeproject.com/KB/Membership/Profiles.aspx?mid=2649904">ajiau</A> 
      )</P>
      <P>July 23rd, 2008: Updated source to work with some additional routers 
      (thanks to <A 
      href="http://www.codeproject.com/KB/Membership/Profiles.aspx?mid=4836726">Chris 
      Harper</A> 
      )</P><!-- Article Ends --><!-- Main Page Contents End --></DIV></SPAN>
      <FORM id=aspnetForm 
      style="PADDING-RIGHT: 0px; PADDING-LEFT: 0px; PADDING-BOTTOM: 0px; MARGIN: 0px; PADDING-TOP: 0px" 
      name=aspnetForm action=upnpnattraversal.aspx method=post>
      <DIV><INPUT id=__VIEWSTATE type=hidden 
      value=/wEPDwULLTEwMDUyNjYzMjhkZKIrmi7Wr1ko1beaFLQvjG9Me6en 
      name=__VIEWSTATE> </DIV>
      <H2>License</H2>
      <DIV id=ctl00_LicenseTerms>
      <P>This article, along with any associated source code and files, is 
      licensed under <A 
      href="http://creativecommons.org/licenses/publicdomain/">A Public Domain 
      dedication</A></P></DIV>
      <H2>About the Author</H2>
      <TABLE cellSpacing=5 cellPadding=0 width="100%" border=0>
        <TBODY>
        <TR vAlign=top>
          <TD id=ctl00_AboutAuthorRptr_ctl00_AboutAuthor_memberPhotoTable 
          style="WIDTH: 155px" vAlign=top><B><A 
            id=ctl00_AboutAuthorRptr_ctl00_AboutAuthor_memberProfileLink 
            href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=4475648">harold 
            aptroot</A></B><BR><BR>
            <CENTER></CENTER><BR><SPAN class=SmallText 
            id=ctl00_AboutAuthorRptr_ctl00_AboutAuthor_memberType></SPAN></TD>
          <TD><BR>
            <TABLE>
              <TBODY>
              <TR id=ctl00_AboutAuthorRptr_ctl00_AboutAuthor_locationRow>
                <TD class=SmallText>Location: </TD>
                <TD width="100%"><SPAN class=SmallText 
                  id=ctl00_AboutAuthorRptr_ctl00_AboutAuthor_memberLocation><IMG 
                  height=11 alt=Netherlands 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/NL.gif" 
                  width=16> 
      Netherlands</SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE><BR>
      <TABLE id=ctl00_PopularArticlesRow cellSpacing=0 cellPadding=0 
      width="100%" border=0>
        <TBODY>
        <TR vAlign=top>
          <TD style="WIDTH: 100%">
            <H2>Other popular Internet / Network articles:</H2>
            <UL>
              <LI><A 
              href="http://www.codeproject.com/KB/IP/AsyncSocketServerandClien.aspx">An 
              Asynchronous Socket Server and Client</A>
              <DIV class=SmallText>An asynchronous socket server and client with 
              encryption and compression.</DIV>
              <LI><A 
              href="http://www.codeproject.com/KB/IP/MyDownloader.aspx">MyDownloader: 
              A Multi-thread C# Segmented Download Manager</A>
              <DIV class=SmallText>Sample application that manages multiple 
              segmented downloads and supports HTTP, FTP and YouTube video 
              downloads</DIV>
              <LI><A href="http://www.codeproject.com/KB/IP/ndk.aspx">Network 
              Development Kit 2.0</A>
              <DIV class=SmallText>Network Development Kit is a set of simple 
              classes for a client-server architecture.</DIV>
              <LI><A 
              href="http://www.codeproject.com/KB/IP/drvfltip.aspx">Developing 
              Firewalls for Windows 2000/XP</A>
              <DIV class=SmallText>An article about developing Firewalls for 
              Windows 2000/XP</DIV>
              <LI><A 
              href="http://www.codeproject.com/KB/IP/iocp_server_client.aspx">A 
              simple IOCP Server/Client Class</A>
              <DIV class=SmallText>This source code uses the advanced IOCP 
              technology which can efficiently serve multiple clients. It also 
              presents some solutions to practical problems that arise with the 
              IOCP programming API, and provides a simple echo client/server 
              with file transfer.</DIV></LI></UL>
            <H2></H2></TD>
          <TD>
            <SCRIPT type=text/javascript>document.write(unescape("%3ca%20href%3d%22http%3a%2f%2fwww.codeproject.com%2fRedir.aspx%3fadid%3d6563%26way%3dban%22%20target%3d%22_blank%22%20rel%3d%22nofollow%22%3e%3cimg%20src%3d%22http%3a%2f%2fwww.codeproject.com%2fscript%2fAdm%2fServeImg.aspx%3fFile%3d%252fscript%252fadmentor%252fimages%252fbox_300_250.gif%26C%3dFalse%26adid%3d6563%22%20alt%3d%22%22%20border%3d%220%22%20width%3d%22300%22%20height%3d%22250%22%3e%3c%2fa%3e"));</SCRIPT>
          </TD></TR></TBODY></TABLE>
      <DIV id=ctl00_AddTo_AddTo style="MARGIN: 10px">
      <SCRIPT language=JavaScript type=text/javascript>
var socialLinks = new social();
socialLinks.addtoMethod=1;
socialLinks.DrawLinks("socialLinks", document.location.href, escape(document.title), 100, 0, "SmallText Bold", "AddTo");
</SCRIPT>
      </DIV>
      <TABLE class=ArticleUneditedHeader id=ctl00_RateArticleRow cellSpacing=0 
      cellPadding=0 width="100%" border=0>
        <TBODY>
        <TR>
          <TD><A 
            href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx#_top">Article 
            Top</A></TD>
          <TD align=right>
            <TABLE cellSpacing=0 cellPadding=0 width="100%">
              <TBODY>
              <TR>
                <TD id=ctl00_RateArticle_VoteResultDiv noWrap align=right 
                width="100%"><SPAN id=voteRes></SPAN><IMG id=loaderImg 
                  style="DISPLAY: none" height=16 alt=loading... 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/ajax-loader.gif" 
                  width=16> </TD>
                <TD class=SmallText id=voteTbl style="WHITE-SPACE: nowrap" 
                align=right>
                  <TABLE>
                    <TBODY>
                    <TR>
                      <TD id=ctl00_RateArticle_RateText 
                      style="PADDING-RIGHT: 5px; WHITE-SPACE: nowrap"><I><B>Rate 
                        this Article for us!</B></I></TD>
                      <TD id=ctl00_RateArticle_StartForm 
                        align=right><I>&nbsp;&nbsp;Poor</I></TD>
                      <TD id=ctl00_RateArticle_VoteFormDiv 
                      style="WHITE-SPACE: nowrap" align=left>
                        <TABLE id=ctl00_RateArticle_VoteRBL border=0>
                          <TBODY>
                          <TR>
                            <TD><INPUT id=ctl00_RateArticle_VoteRBL_0 
                              type=radio value=1 
                            name=ctl00$RateArticle$VoteRBL></TD>
                            <TD><INPUT id=ctl00_RateArticle_VoteRBL_1 
                              type=radio value=2 
                            name=ctl00$RateArticle$VoteRBL></TD>
                            <TD><INPUT id=ctl00_RateArticle_VoteRBL_2 
                              type=radio value=3 
                            name=ctl00$RateArticle$VoteRBL></TD>
                            <TD><INPUT id=ctl00_RateArticle_VoteRBL_3 
                              type=radio value=4 
                            name=ctl00$RateArticle$VoteRBL></TD>
                            <TD><INPUT id=ctl00_RateArticle_VoteRBL_4 
                              type=radio value=5 
                            name=ctl00$RateArticle$VoteRBL></TD></TR></TBODY></TABLE></TD>
                      <TD id=ctl00_RateArticle_EndForm noWrap 
                        align=left><I>Excellent</I> <INPUT class=FormButton id=ctl00_RateArticle_SubmitRateBtn onclick="return rateItem(27992,2);" type=submit value=Vote name=ctl00$RateArticle$SubmitRateBtn> 
                      </TD>
                      <TD><SPAN 
                    id=ctl00_RateArticle_ErrorMessage></SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE>
      <DIV><INPUT id=__EVENTVALIDATION type=hidden 
      value=/wEWCALU36WvCgLAlMXDBwLBlMXDBwLClMXDBwLDlMXDBwLElMXDBwLP+++tCwK5upDkC203BSa/FtyPMrHYsu0YLsnIP1Lu 
      name=__EVENTVALIDATION> </DIV></FORM>
      <DIV 
      style="PADDING-RIGHT: 10px; PADDING-LEFT: 10px; PADDING-BOTTOM: 10px; OVERFLOW: hidden; PADDING-TOP: 10px; WHITE-SPACE: nowrap; TEXT-ALIGN: center"><IFRAME 
      src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/ServeLinks.htm" 
      frameBorder=0 width=468 scrolling=no height=58></IFRAME><IFRAME 
      src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/blank.htm" 
      frameBorder=0 width=300 scrolling=no height=60></IFRAME></DIV><A 
      name=_comments></A><!-- Forum Start -->
      <DIV id=_MessageBoard onclick="return SwitchMessage(event, null)">
      <TABLE class=Frm_MainTable id=ForumTable cellSpacing=0 cellPadding=0>
        <TBODY>
        <TR>
          <TD>
            <FORM 
            style="PADDING-RIGHT: 0px; PADDING-LEFT: 0px; PADDING-BOTTOM: 0px; MARGIN: 0px; PADDING-TOP: 0px" 
            action=/script/Forums/SetOptions.aspx?floc=%2fKB%2fIP%2fupnpnattraversal.aspx&amp;fid=1511377 
            method=get><INPUT type=hidden value=1511377 name=fid><INPUT 
            type=hidden 
            value=?floc=%2fKB%2fIP%2fupnpnattraversal.aspx&amp;fid=1511377 
            name=currentQS><INPUT type=hidden value=/KB/IP/upnpnattraversal.aspx 
            name=floc>
            <TABLE cellSpacing=0 cellPadding=3 width="100%" border=0>
              <TBODY>
              <TR class=Frm_HeaderRow1>
                <TD style="WHITE-SPACE: nowrap"><IMG height=16 alt=FAQ 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/forum_faq.gif" 
                  width=16 align=middle border=0>&nbsp;<A 
                  href="http://www.codeproject.com/script/Forums/FAQ.aspx"><B>FAQ</B></A>&nbsp;</TD>
                <TD style="WHITE-SPACE: nowrap; TEXT-ALIGN: right">Noise 
                  Tolerance<SELECT class=Frm_DropDown size=1 name=noise> 
                    <OPTION value=1>Very High</OPTION><OPTION 
                    value=2>High</OPTION><OPTION value=3 
                    selected>Medium</OPTION><OPTION value=4>Low</OPTION><OPTION 
                    value=5>Very Low</OPTION></SELECT></TD>
                <TD style="WHITE-SPACE: nowrap; TEXT-ALIGN: right" 
                  colSpan=2><IMG height=15 alt=Search 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/forum_search.gif" 
                  width=16 align=top border=0>&nbsp;<A 
                  href="http://www.codeproject.com/script/Forums/Search.aspx?fid=1511377">Search 
                  Messages</A>&nbsp;</TD>
                <TD style="TEXT-ALIGN: right"><INPUT class=Frm_Button type=submit value="Set Options" name=SetOpt></TD></TR>
              <TR class=Frm_HeaderRow2>
                <TD style="WIDTH: 100%">&nbsp;</TD>
                <TD 
                  style="WHITE-SPACE: nowrap; TEXT-ALIGN: right">Layout<SELECT 
                  class=Frm_DropDown size=1 name=view> <OPTION value=Quick 
                    selected>Normal</OPTION><OPTION value=Topic>Expand Root 
                    Messages</OPTION><OPTION value=Expanded>Expand All 
                    Messages</OPTION><OPTION value=Thread>Thread 
                    View</OPTION><OPTION value=Normal>No Javascript 
                    (slow)</OPTION><OPTION value=Preview>No Javascript 
                    Preview</OPTION></SELECT>&nbsp;&nbsp;</TD>
                <TD style="WHITE-SPACE: nowrap">Per page<SELECT 
                  class=Frm_DropDown size=1 name=mpp> <OPTION 
                    value=10>10</OPTION><OPTION value=25 
                    selected>25</OPTION><OPTION 
                  value=50>50</OPTION></SELECT>&nbsp;&nbsp;</TD>
                <TD colSpan=2>&nbsp;</TD></TR></TBODY></TABLE></FORM></TD></TR>
        <TR>
          <TD><A name=xx0xx></A>
            <TABLE cellSpacing=0 cellPadding=2 width="100%" border=0>
              <TBODY>
              <TR class=Frm_NavigationBar>
                <TD><IMG height=16 alt=new 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/forum_newmsg.gif" 
                  width=16 align=top border=0><A class=Frm_HL 
                  title="Create a new message thread" 
                  href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;floc=/KB/IP/upnpnattraversal.aspx" 
                  target=_top name=Frm_HoverNL><B>New Message</B></A></TD>
                <TD>Msgs 1 to 23 of 23 (Total in Forum: 23) (<A 
                  href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377">Refresh</A>)</TD>
                <TD style="WHITE-SPACE: nowrap; TEXT-ALIGN: right"><SPAN 
                  class=Frm_HL>First</SPAN><SPAN class=Frm_HL>Prev</SPAN><SPAN 
                  class=Frm_HL>Next</SPAN></TD></TR></TBODY></TABLE></TD></TR>
        <TR>
          <TD>
            <TABLE class=Frm_MsgTable cellSpacing=0 cellPadding=0 width="100%" 
            border=0><!-- Column Headers -->
              <TBODY>
              <TR class=Frm_ColumnHeaders>
                <TD style="WIDTH: 100%">
                  <TABLE cellSpacing=0 cellPadding=2 width="100%" border=0>
                    <TBODY>
                    <TR>
                      <TD>Subject&nbsp;</TD>
                      <TD class=Frm_MsgAuthor>&nbsp;Author&nbsp;</TD>
                      <TD 
              class=Frm_MsgDate>Date&nbsp;</TD></TR></TBODY></TABLE></TD></TR>
              <TR>
                <TD><IMG height=5 alt="" 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/t.gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd Rt HdUnSel " id=F2675906_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=16><A 
                        name=xx2675906xx></A><IMG height=16 alt=General 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_general.gif" 
                        width=16 align=top></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;select=2675906#xx2675906xx" 
                        name=2675906>[Message Deleted]</A><IMG height=12 alt=new 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/New.gif" 
                        width=31></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 alt=member 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=112569">sdssd</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">18:30 
                        12 Aug '08 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=F2675906_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 16px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2><BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: middle">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2675906&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2675906&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;tid=2675906">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=1511377&amp;msg=2675906">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=2675906&amp;obtid=3&amp;bma=AddBookmark">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF2675906 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT type=text/javascript>
												MsgVFrm(112569,2675906,false,"","","");
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgRtDivide><IMG height=1 alt="" 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/t.gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd Rt HdUnSel " id=F2654941_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=16><A 
                        name=xx2654941xx></A><IMG height=16 alt=General 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_general.gif" 
                        width=16 align=top></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;select=2654941#xx2654941xx" 
                        name=2654941>Not working due to firewall</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 alt=member 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=76461">fmaeseele</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">10:36 
                        28 Jul '08 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=F2654941_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 16px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Great article<BR>I justed wanted 
                                to make you notice that compared to using the 
                                native Microsoft UPNP library, you have to 
                                authorize your program to the windows firewall 
                                in order to be able to receive the UPnP device 
                                response... But indeed, using the native UPnP 
                                Library (interop) in c# requires that the UPnP 
                                Service is running, which is not often the 
                                case.<BR><BR>Regards<BR><BR>François 
                                MAESEELE<BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: middle">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2654941&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2654941&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;tid=2654941">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=1511377&amp;msg=2654941">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=2654941&amp;obtid=3&amp;bma=AddBookmark">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF2654941 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT type=text/javascript>
												MsgVFrm(76461,2654941,false,"","","");
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 alt="" 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/t.gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=F2654986_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=34><A 
                        name=xx2654986xx></A><IMG height=16 alt=General 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_general.gif" 
                        width=16 align=top></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;select=2654986#xx2654986xx" 
                        name=2654986>Re: Not working due to firewall</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 alt=member 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=4475648">harold 
                        aptroot</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">11:18 
                        28 Jul '08 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=F2654986_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 34px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Thank you<BR>On the other hand, a 
                                program that needs ports to be forwarded has a 
                                big chance to need to do things that will 
                                trigger the firewall anyway<BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: middle">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2654986&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2654986&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;tid=2654941">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=1511377&amp;msg=2654986">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=2654986&amp;obtid=3&amp;bma=AddBookmark">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF2654986 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT type=text/javascript>
												MsgVFrm(4475648,2654986,false,"","","");
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 alt="" 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/t.gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=F2654989_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=52><A 
                        name=xx2654989xx></A><IMG height=16 alt=General 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_general.gif" 
                        width=16 align=top></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;select=2654989#xx2654989xx" 
                        name=2654989>Re: Not working due to firewall</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 alt=member 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=76461">fmaeseele</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">11:21 
                        28 Jul '08 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=F2654989_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 52px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>;P You're right... My bad!<BR>I 
                                guess my notice was more for people trying your 
                                demo <IMG title="D'Oh!" 
                                src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/smiley_doh.gif" 
                                align=top><BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: middle">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2654989&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2654989&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;tid=2654941">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=1511377&amp;msg=2654989">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=2654989&amp;obtid=3&amp;bma=AddBookmark">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF2654989 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT type=text/javascript>
												MsgVFrm(76461,2654989,false,"","","");
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgRtDivide><IMG height=1 alt="" 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/t.gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd Rt HdUnSel " id=F2649180_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=16><A 
                        name=xx2649180xx></A><IMG height=16 alt=General 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_general.gif" 
                        width=16 align=top></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;select=2649180#xx2649180xx" 
                        name=2649180>Issue with getting service URL on older 
                        WRT54G.</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 alt=member 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=4836726">Chris 
                        Harper</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">9:05 23 
                        Jul '08 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=F2649180_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 16px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Line 70: “serviceUrl = 
                                descUrl.Substring(0, descUrl.LastIndexOf("/")) + 
                                relurl;”<BR><BR>This line appears to assume the 
                                URL is relative. On an older LINKSYS WRT54G, the 
                                URL 
                                is:<BR>"/uuid:000c-4182-5d2c02009adc/WANIPConnection:1"<BR><BR>Since 
                                the URL is at the root, the concatenation on 
                                line 70 causes the URL to be incorrect and 
                                subsequent operations fail. Building the URL 
                                should consider whether it’s at the root or 
                                relative.<BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: middle">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2649180&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2649180&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;tid=2649180">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=1511377&amp;msg=2649180">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=2649180&amp;obtid=3&amp;bma=AddBookmark">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF2649180 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT type=text/javascript>
												MsgVFrm(4836726,2649180,false,"","","");
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 alt="" 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/t.gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=F2649191_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=34><A 
                        name=xx2649191xx></A><IMG height=16 alt=General 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_general.gif" 
                        width=16 align=top></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;select=2649191#xx2649191xx" 
                        name=2649191>Re: Issue with getting service URL on older 
                        WRT54G.</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 alt=member 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=4475648">harold 
                        aptroot</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">9:12 23 
                        Jul '08 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=F2649191_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 34px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>How should that be fixed then? 
                                "/uuid:000c-4182-5d2c02009adc/WANIPConnection:1" 
                                looks very relative to me..<BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: middle">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2649191&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2649191&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;tid=2649180">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=1511377&amp;msg=2649191">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=2649191&amp;obtid=3&amp;bma=AddBookmark">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF2649191 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT type=text/javascript>
												MsgVFrm(4475648,2649191,false,"","","");
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 alt="" 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/t.gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=F2649236_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=52><A 
                        name=xx2649236xx></A><IMG height=16 alt=General 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_general.gif" 
                        width=16 align=top></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;select=2649236#xx2649236xx" 
                        name=2649236>Re: Issue with getting service URL on older 
                        WRT54G.</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 alt=member 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=4836726">Chris 
                        Harper</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">9:42 23 
                        Jul '08 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=F2649236_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 52px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Yes, I really meant root path and 
                                not relative. Sorry.<BR><BR>The issue is 
                                actually due to the fact that the router’s URL 
                                is: 
                                http://192.168.254.1:5431/dyndev/uuid:000c-4182-5d2c00009adc. 
                                It’s the dyndev sub-directory in the URL that 
                                causes the issue. The code assumes the last / is 
                                the URL’s root, when in this case it’s not. The 
                                concatenation should concatenate the two URLs 
                                with consideration of root or relative.<BR><BR>I 
                                modified it to the following and it resolves the 
                                issue. There may be a better way, but this is a 
                                quick fix.<BR><BR><PRE><BR>int n;<BR><BR>if(relurl[0] == '/')<BR>{<BR>	n = descUrl.IndexOf("://");<BR>	if (n &gt; -1)<BR>	{<BR>		n = descUrl.IndexOf('/', n + 3);<BR>		if (n &gt; -1)<BR>			serviceUrl = descUrl.Substring(0, n) + relurl;<BR>	}<BR>} else<BR>{<BR>	serviceUrl = descUrl.Substring(0, descUrl.LastIndexOf("/")) + relurl;<BR>}<BR></PRE><BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: middle">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2649236&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2649236&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;tid=2649180">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=1511377&amp;msg=2649236">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=2649236&amp;obtid=3&amp;bma=AddBookmark">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF2649236 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT type=text/javascript>
												MsgVFrm(4836726,2649236,false,"","","");
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 alt="" 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/t.gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=F2649609_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=70><A 
                        name=xx2649609xx></A><IMG height=16 alt=General 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_general.gif" 
                        width=16 align=top></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;select=2649609#xx2649609xx" 
                        name=2649609>Re: Issue with getting service URL on older 
                        WRT54G.</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 alt=member 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=4475648">harold 
                        aptroot</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">15:29 
                        23 Jul '08 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=F2649609_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 70px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>*Source updated with this 
                                code*<BR>Does that work for that 
                                router?<BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: middle">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2649609&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2649609&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;tid=2649180">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=1511377&amp;msg=2649609">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=2649609&amp;obtid=3&amp;bma=AddBookmark">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF2649609 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT type=text/javascript>
												MsgVFrm(4475648,2649609,false,"","","");
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgRtDivide><IMG height=1 alt="" 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/t.gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd Rt HdUnSel " id=F2649140_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=16><A 
                        name=xx2649140xx></A><IMG height=16 alt=General 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_general.gif" 
                        width=16 align=top></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;select=2649140#xx2649140xx" 
                        name=2649140>Issue with older WRT54G.</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 alt=member 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=4836726">Chris 
                        Harper</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">8:42 23 
                        Jul '08 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=F2649140_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 16px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>The code makes an assumption that 
                                the Location header will contain an .xml 
                                extension. On an older LINKSYS WRT54G, the 
                                Location header looks like this 
                                “http://192.168.254.1:5431/dyndev/uuid:000c-4182-5d2c00009adc” 
                                and thus the loop at line 29 never breaks, 
                                causing an infinite loop. The router does return 
                                an XML document from this address, so it doesn’t 
                                seem necessary to require an xml extension in 
                                the Location header. Can’t this check simply be 
                                taken out?<BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: middle">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2649140&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2649140&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;tid=2649140">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=1511377&amp;msg=2649140">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=2649140&amp;obtid=3&amp;bma=AddBookmark">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF2649140 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT type=text/javascript>
												MsgVFrm(4836726,2649140,false,"","","");
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 alt="" 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/t.gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=F2649195_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=34><A 
                        name=xx2649195xx></A><IMG height=16 alt=General 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_general.gif" 
                        width=16 align=top></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;select=2649195#xx2649195xx" 
                        name=2649195>Re: Issue with older WRT54G.</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 alt=member 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=4475648">harold 
                        aptroot</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">9:15 23 
                        Jul '08 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=F2649195_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 34px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Perhaps it can<BR>I'm not entirely 
                                why it is there in the first place <IMG 
                                title=Laugh 
                                src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/smiley_laugh.gif" 
                                align=top><BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: middle">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2649195&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2649195&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;tid=2649140">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=1511377&amp;msg=2649195">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=2649195&amp;obtid=3&amp;bma=AddBookmark">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF2649195 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT type=text/javascript>
												MsgVFrm(4475648,2649195,false,"","","");
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgRtDivide><IMG height=1 alt="" 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/t.gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd Rt HdUnSel " id=F2648932_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=16><A 
                        name=xx2648932xx></A><IMG height=16 alt=General 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_general.gif" 
                        width=16 align=top></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;select=2648932#xx2648932xx" 
                        name=2648932>Mono.Nat</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 alt=member 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=189">Ramon 
                        Smits</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">6:10 23 
                        Jul '08 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=F2648932_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 16px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Are you aware of the fact that 
                                upnp mapping code is already present in the mono 
                                sources for a long time now? It is in the 
                                Mono.Nat namespace.<BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: middle">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2648932&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2648932&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;tid=2648932">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=1511377&amp;msg=2648932">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=2648932&amp;obtid=3&amp;bma=AddBookmark">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF2648932 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT type=text/javascript>
												MsgVFrm(189,2648932,false,"","","");
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 alt="" 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/t.gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=F2649042_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=34><A 
                        name=xx2649042xx></A><IMG height=16 alt=General 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_general.gif" 
                        width=16 align=top></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;select=2649042#xx2649042xx" 
                        name=2649042>Re: Mono.Nat</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 alt=member 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=4475648">harold 
                        aptroot</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">7:35 23 
                        Jul '08 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=F2649042_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 34px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Ah no, I was not aware.. well I'll 
                                have a look at that, thanks for mentioning <IMG 
                                title=Smile 
                                src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/smiley_smile.gif" 
                                align=top><BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: middle">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2649042&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2649042&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;tid=2648932">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=1511377&amp;msg=2649042">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=2649042&amp;obtid=3&amp;bma=AddBookmark">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF2649042 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT type=text/javascript>
												MsgVFrm(4475648,2649042,false,"","","");
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 alt="" 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/t.gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=F2649053_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=52><A 
                        name=xx2649053xx></A><IMG height=16 alt=General 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_general.gif" 
                        width=16 align=top></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;select=2649053#xx2649053xx" 
                        name=2649053>Re: Mono.Nat</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 alt=member 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=189">Ramon 
                        Smits</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">7:44 23 
                        Jul '08 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=F2649053_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 52px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Well... I too made a upnp lib 
                                implementation and is was very interesting to 
                                learn how it actually works but when I found an 
                                implementation in mono torrent a long time ago 
                                that got merged in the mono framework I started 
                                using that implementation.<BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: middle">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2649053&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2649053&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;tid=2648932">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=1511377&amp;msg=2649053">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=2649053&amp;obtid=3&amp;bma=AddBookmark">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF2649053 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT type=text/javascript>
												MsgVFrm(189,2649053,false,"","","");
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgRtDivide><IMG height=1 alt="" 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/t.gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd Rt HdUnSel " id=F2647200_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=16><A 
                        name=xx2647200xx></A><IMG height=16 alt=General 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_general.gif" 
                        width=16 align=top></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;select=2647200#xx2647200xx" 
                        name=2647200>Too hardcoded to work universally</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 alt=member 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=2649904">ajiau</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">5:26 22 
                        Jul '08 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=F2647200_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 16px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>I have been meaning to write a 
                                UPnP class myself, so it's good to see others 
                                trying too, however there are too many 
                                assumptions in your code for it to work properly 
                                on other NAT devices. Specifically, my DG834G 
                                doesn't comply with several assumptions you've 
                                made. <BR><BR>Firstly, <PRE>239.255.255.250</PRE>works perfectly for my 
                                DG834, whereas <PRE>255.255.255.255</PRE>only triggers my XBMC 
                                media center to announce 
                                itself.<BR><BR>Secondly, the line<BR><BR><PRE>s.SendTo(data, new IPEndPoint(IPAddress.Broadcast, 1900));</PRE><BR><BR>should 
                                be repeated three times, as per one of the specs 
                                for UPnP (I forget which, I just remember 
                                reading it the other day)<BR><BR>Thirdly, your 
                                code assumes certain text in the response which 
                                may not be there, specifically "location" (case 
                                sensitivity), port "80", and 
                                ".xml".<BR><BR>Below is the changed code (which 
                                may now not work on your NAT box. <IMG 
                                title=Smile 
                                src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/smiley_smile.gif" 
                                align=top> )<BR><BR><PRE>using System;<BR>using System.Collections.Generic;<BR>using System.Text;<BR>using System.Net;<BR>using System.Net.Sockets;<BR>using System.Xml;<BR>using System.IO;<BR><BR>namespace UPnP<BR>{<BR>    public delegate void Method();<BR>    public class NAT<BR>    {<BR>        public static void BeginDiscover(Method callback)<BR>        {<BR>            Socket s = new Socket(AddressFamily.InterNetwork, SocketType.Dgram, ProtocolType.Udp);<BR>            s.SetSocketOption(SocketOptionLevel.Socket, SocketOptionName.Broadcast, 1);<BR>            string req = "M-SEARCH * HTTP/1.1\r\n" +<BR>            "HOST: 255.255.255.255:1900\r\n" +<BR>            "ST:upnp:rootdevice\r\n" +<BR>            "MAN:\"ssdp:discover\"\r\n" +<BR>            "MX:3\r\n\r\n";<BR>            byte[] data = Encoding.ASCII.GetBytes(req);<BR>            s.BeginSendTo(data, 0, data.Length, SocketFlags.None, new IPEndPoint(IPAddress.Broadcast, 1900),<BR>                delegate(IAsyncResult ar)<BR>                {<BR>                    s.EndSendTo(ar);<BR>                    byte[] buffer = new byte[0x1000];<BR>                    s.BeginReceive(buffer, 0, 0x1000, SocketFlags.None, delegate(IAsyncResult rar)<BR>                    {<BR>                        int l = s.EndReceive(rar);<BR>                        string resp = Encoding.ASCII.GetString(buffer, 0, l);<BR>                        resp = resp.Substring(resp.IndexOf("Location:") + "Location:".Length);<BR>                        resp = resp.Substring(0, resp.IndexOf(".xml") + 4);<BR>                        descUrl = resp;<BR>                        BeginGetServiceUrl(callback);<BR>                    }, null);<BR>                }, null);<BR>        }<BR>        public static string Discover()<BR>        {<BR>            Socket s = new Socket(AddressFamily.InterNetwork, SocketType.Dgram, ProtocolType.Udp);<BR>            s.SetSocketOption(SocketOptionLevel.Socket, SocketOptionName.Broadcast, 1);<BR>            string req = "M-SEARCH * HTTP/1.1\r\n" +<BR>            "HOST: 239.255.255.250:1900\r\n" +<BR>            "ST:upnp:rootdevice\r\n" +<BR>            "MAN:\"ssdp:discover\"\r\n" +<BR>            "MX:3\r\n\r\n";<BR>            byte[] data = Encoding.ASCII.GetBytes(req);<BR><BR>            byte[] buffer = new byte[0x1000];<BR><BR>            string resp;<BR><BR>            do<BR>            {<BR>                s.SendTo(data, new IPEndPoint(IPAddress.Broadcast, 1900));<BR>                s.SendTo(data, new IPEndPoint(IPAddress.Broadcast, 1900));<BR>                s.SendTo(data, new IPEndPoint(IPAddress.Broadcast, 1900));<BR><BR>                int l = s.Receive(buffer);<BR><BR>                resp = Encoding.ASCII.GetString(buffer, 0, l);<BR><BR>                if (resp.ToLower().Contains("upnp:rootdevice"))<BR>                {<BR>                    resp = resp.Substring(resp.ToLower().IndexOf("location:") + "Location:".Length);<BR>                    resp = resp.Substring(0, resp.IndexOf("\r")).Trim();<BR>                    if (resp.ToLower().Contains(".xml"))<BR>                    {<BR>                        descUrl = resp;<BR>                        GetServiceUrl();<BR>                        break;<BR>                    }<BR>                }<BR>            } while (true);<BR><BR>            return resp;<BR>        }<BR><BR><BR>        static string descUrl;<BR>        static string serviceUrl;<BR><BR>        static void BeginGetServiceUrl(Method callback)<BR>        {<BR>            WebRequest req = WebRequest.Create(descUrl);<BR>            XmlDocument xdoc = new XmlDocument();<BR>            req.BeginGetResponse(delegate(IAsyncResult ar)<BR>            {<BR>                xdoc.Load(req.EndGetResponse(ar).GetResponseStream());<BR>                XmlNamespaceManager nsMgr = new XmlNamespaceManager(xdoc.NameTable);<BR>                nsMgr.AddNamespace("tns", "urn:schemas-upnp-org:device-1-0");<BR>                string relurl = xdoc.SelectSingleNode("//tns:service[tns:serviceType=\"urn:schemas-upnp-org:service:WANIPConnection:1\"]/tns:controlURL/text()", nsMgr).Value;<BR>                serviceUrl = descUrl.Substring(0, descUrl.IndexOf(":80") + 3) + relurl;<BR>                if (callback != null) callback();<BR>            }, null);<BR>        }<BR>        static void GetServiceUrl()<BR>        {<BR>            XmlDocument desc = new XmlDocument();<BR>            desc.Load(WebRequest.Create(descUrl).GetResponse().GetResponseStream());<BR>            XmlNamespaceManager nsMgr = new XmlNamespaceManager(desc.NameTable);<BR>            nsMgr.AddNamespace("tns", "urn:schemas-upnp-org:device-1-0");<BR>            XmlNode node = desc.SelectSingleNode("//tns:service[tns:serviceType=\"urn:schemas-upnp-org:service:WANIPConnection:1\"]/tns:controlURL/text()", nsMgr);<BR>            if (node != null)<BR>            {<BR>                string relurl = node.Value;<BR><BR>                serviceUrl = descUrl.Substring(0, descUrl.LastIndexOf("/")) + relurl;<BR>            }<BR>        }<BR><BR>        public static IPAddress GetExternalIP()<BR>        {<BR>            if (string.IsNullOrEmpty(serviceUrl))<BR>                throw new Exception("No UPnP service available or Discover() has not been called");<BR>            XmlDocument xdoc = SOAPRequest(serviceUrl, "<U:GETEXTERNALIPADDRESS urn:schemas-upnp-org:service:WANIPConnection:1\?? xmlns:u="\">\r\n" +<BR>            "</U:GETEXTERNALIPADDRESS>\r\n", "GetExternalIPAddress");<BR>            XmlNamespaceManager nsMgr = new XmlNamespaceManager(xdoc.NameTable);<BR>            nsMgr.AddNamespace("tns", "urn:schemas-upnp-org:device-1-0");<BR>            string IP = xdoc.SelectSingleNode("//NewExternalIPAddress/text()", nsMgr).Value;<BR>            return IPAddress.Parse(IP);<BR>        }<BR><BR>        public static void ForwardPort(int port, ProtocolType protocol, string description)<BR>        {<BR>            if (string.IsNullOrEmpty(serviceUrl))<BR>                throw new Exception("No UPnP service available or Discover() has not been called");<BR>            XmlDocument xdoc = SOAPRequest(serviceUrl, "<U:ADDPORTMAPPING urn:schemas-upnp-org:service:WANIPConnection:1\?? xmlns:u="\">\r\n" +<BR>                "<NEWREMOTEHOST></NEWREMOTEHOST><NEWEXTERNALPORT>" + port.ToString() + "</NEWEXTERNALPORT><NEWPROTOCOL>" + protocol.ToString().ToUpper() + "</NEWPROTOCOL>" +<BR>                "<NEWINTERNALPORT>" + port.ToString() + "</NEWINTERNALPORT><NEWINTERNALCLIENT>" + Dns.GetHostAddresses(Dns.GetHostName())[0].ToString() +<BR>                "</NEWINTERNALCLIENT><NEWENABLED>1</NEWENABLED><NEWPORTMAPPINGDESCRIPTION>" + description +<BR>            "</NEWPORTMAPPINGDESCRIPTION><NEWLEASEDURATION>0</NEWLEASEDURATION></U:ADDPORTMAPPING>\r\n", "AddPortMapping");<BR>        }<BR><BR>        static XmlDocument SOAPRequest(string url, string soap, string function)<BR>        {<BR>            string req = "\r\n" +<BR>            "<S:ENVELOPE \?? encoding soap schemas.xmlsoap.org http: s:encodingstyle="\" envelope xmlns:s="\">\r\n" +<BR>            "<S:BODY>\r\n" +<BR>            soap +<BR>            "</S:BODY>\r\n" +<BR>            "</S:ENVELOPE>";<BR>            WebRequest r = HttpWebRequest.Create(url);<BR>            r.Method = "POST";<BR>            byte[] b = Encoding.UTF8.GetBytes(req);<BR>            r.Headers.Add("SOAPACTION", "urn:schemas-upnp-org:service:WANIPConnection:1#" + function);<BR>            r.ContentLength = b.Length;<BR>            r.GetRequestStream().Write(b, 0, b.Length);<BR>            XmlDocument resp = new XmlDocument();<BR>            WebResponse wres = r.GetResponse();<BR>            Stream ress = wres.GetResponseStream();<BR>            resp.Load(ress);<BR>            return resp;<BR>        }<BR>    }<BR>}</PRE><BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: middle">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2647200&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2647200&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;tid=2647200">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=1511377&amp;msg=2647200">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=2647200&amp;obtid=3&amp;bma=AddBookmark">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF2647200 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT type=text/javascript>
												MsgVFrm(2649904,2647200,false,"","","");
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 alt="" 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/t.gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=F2647265_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=34><A 
                        name=xx2647265xx></A><IMG height=16 alt=General 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_general.gif" 
                        width=16 align=top></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;select=2647265#xx2647265xx" 
                        name=2647265>Re: Too hardcoded to work 
universally</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 alt=member 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=4475648">harold 
                        aptroot</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">6:01 22 
                        Jul '08 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=F2647265_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 34px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Thanx, that works too, so it has 
                                to be better <IMG title=Smile 
                                src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/smiley_smile.gif" 
                                align=top> <BR>Sadly I only have one NAT router 
                                to test this on, and there are still some 
                                assumptions there - but they are ones that you 
                                can make then, yes?<BR><BR>Do you mind if I 
                                update my code and article 
                                accordingly?<BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: middle">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2647265&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2647265&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;tid=2647200">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=1511377&amp;msg=2647265">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=2647265&amp;obtid=3&amp;bma=AddBookmark">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF2647265 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT type=text/javascript>
												MsgVFrm(4475648,2647265,false,"","","");
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 alt="" 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/t.gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=F2647441_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=52><A 
                        name=xx2647441xx></A><IMG height=16 alt=General 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_general.gif" 
                        width=16 align=top></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;select=2647441#xx2647441xx" 
                        name=2647441>Re: Too hardcoded to work universally 
                        [modified]</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 alt=member 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=2649904">ajiau</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">8:05 22 
                        Jul '08 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=F2647441_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 52px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Sure go for it!<BR><BR>Also, I've 
                                just found two more problems talking to the 
                                DG834G; you need quotes around the soap action, 
                                and you need to specify the 
                                <CODE>ContentType</CODE> correctly.<BR><BR><PRE>r.Headers.Add("SOAPACTION", "\"urn:schemas-upnp-org:service:WANIPConnection:1#" + function + "\"");<BR>r.ContentType = "text/xml; charset=\"utf-8\"";<BR></PRE><BR><BR>I've 
                                just spend the last few hours tinkering with 
                                this code, and I have to say that I'm quite 
                                impressed with how well it works 
                                now.<BR><BR>Just for reference, I'll now post 
                                below the handshaking which goes on for the 
                                various UPnP commands. Note that in these 
                                examples my DG834G has an IP address of 
                                <CODE>192.168.0.1</CODE>, and my PC has an IP 
                                address of 
                                <CODE>192.168.0.5</CODE>.<BR><BR><B><BIG>Get 
                                External IP 
                                Address</BIG></B><BR><BR><B>Request</B><BR><PRE>POST /upnp/control/WANIPConnection HTTP/1.1<BR>HOST: 192.168.0.1:49153<BR>CONTENT-LENGTH: 295<BR>CONTENT-TYPE: text/xml; charset="utf-8"<BR>SOAPACTION: "urn:schemas-upnp-org:service:WANIPConnection:1#GetExternalIPAddress"<BR><BR>&lt;?xml version="1.0"?&gt;<BR>&lt;s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"&gt;<BR>&lt;s:Body&gt;<BR>&lt;u:GetExternalIPAddress xmlns:u="urn:schemas-upnp-org:service:WANIPConnection:1"&gt;<BR>&lt;/u:GetExternalIPAddress&gt;<BR>&lt;/s:Body&gt;<BR>&lt;/s:Envelope&gt;</PRE><BR><B>Response 
                                (Actual Address Obfuscated)</B><BR><PRE>HTTP/1.1 200 OK<BR>CONTENT-LENGTH: 331<BR>CONTENT-TYPE: text/xml; charset="utf-8"<BR>DATE: Tue, 22 Jul 2008 13:32:15 GMT<BR>EXT:<BR>SERVER: Linux/2.4.17_mvl21-malta-mips_fp_le, UPnP/1.0, Intel SDK for UPnP devices /1.2<BR><BR>&lt;s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"&gt;<BR>&lt;s:Body&gt;<BR>&lt;u:GetExternalIPAddressResponse xmlns:u="urn:upnp-org:serviceId:WANIPConnection"&gt;<BR>&lt;NewExternalIPAddress&gt;999.999.999.999&lt;/NewExternalIPAddress&gt;<BR>&lt;/u:GetExternalIPAddressResponse&gt;<BR>&lt;/s:Body&gt;<BR>&lt;/s:Envelope&gt;<BR></PRE><BR><BR><B><BIG>Get 
                                Port Mapping Entry 
                                (Successful)</BIG></B><BR><B>Request</B><BR><PRE>POST /upnp/control/WANIPConnection HTTP/1.1<BR>HOST: 192.168.0.1:49153<BR>CONTENT-LENGTH: 351<BR>CONTENT-TYPE: text/xml; charset="utf-8"<BR>SOAPACTION: "urn:schemas-upnp-org:service:WANIPConnection:1#GetGenericPortMappingEntry"<BR><BR>&lt;?xml version="1.0"?&gt;<BR>&lt;s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"&gt;<BR>&lt;s:Body&gt;<BR>&lt;u:GetGenericPortMappingEntry xmlns:u="urn:schemas-upnp-org:service:WANIPConnection:1"&gt;<BR>&lt;NewPortMappingIndex&gt;1&lt;/NewPortMappingIndex&gt;<BR>&lt;/u:GetGenericPortMappingEntry&gt;<BR>&lt;/s:Body&gt;<BR>&lt;/s:Envelope&gt;</PRE><BR><B>Response</B><BR><PRE>HTTP/1.1 200 OK<BR>CONTENT-LENGTH: 616<BR>CONTENT-TYPE: text/xml; charset="utf-8"<BR>DATE: Tue, 22 Jul 2008 13:32:14 GMT<BR>EXT:<BR>SERVER: Linux/2.4.17_mvl21-malta-mips_fp_le, UPnP/1.0, Intel SDK for UPnP devices /1.2<BR><BR>&lt;s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"&gt;<BR>&lt;s:Body&gt;<BR>&lt;u:GetGenericPortMappingEntryResponse xmlns:u="urn:upnp-org:serviceId:WANIPConnection"&gt;<BR>&lt;NewRemoteHost&gt;<BR>&lt;/NewRemoteHost&gt;<BR>&lt;NewExternalPort&gt;1234&lt;/NewExternalPort&gt;<BR>&lt;NewProtocol&gt;UDP&lt;/NewProtocol&gt;<BR>&lt;NewInternalPort&gt;1234&lt;/NewInternalPort&gt;<BR>&lt;NewInternalClient&gt;192.168.0.5&lt;/NewInternalClient&gt;<BR>&lt;NewEnabled&gt;1&lt;/NewEnabled&gt;<BR>&lt;NewPortMappingDescription&gt;uTorrent (UDP)&lt;/NewPortMappingDescription&gt;<BR>&lt;NewLeaseDuration&gt;0&lt;/NewLeaseDuration&gt;<BR>&lt;/u:GetGenericPortMappingEntryResponse&gt;<BR>&lt;/s:Body&gt;<BR>&lt;/s:Envelope&gt;<BR></PRE><BR><B><BIG>Get Port Mapping Entry 
                                (Unsuccessful)</BIG></B><BR><BR><B>Request</B><BR><PRE>POST /upnp/control/WANIPConnection HTTP/1.1<BR>HOST: 192.168.0.1:49153<BR>CONTENT-LENGTH: 351<BR>CONTENT-TYPE: text/xml; charset="utf-8"<BR>SOAPACTION: "urn:schemas-upnp-org:service:WANIPConnection:1#GetGenericPortMappingEntry"<BR><BR>&lt;?xml version="1.0"?&gt;<BR>&lt;s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"&gt;<BR>&lt;s:Body&gt;<BR>&lt;u:GetGenericPortMappingEntry xmlns:u="urn:schemas-upnp-org:service:WANIPConnection:1"&gt;<BR>&lt;NewPortMappingIndex&gt;2&lt;/NewPortMappingIndex&gt;<BR>&lt;/u:GetGenericPortMappingEntry&gt;<BR>&lt;/s:Body&gt;<BR>&lt;/s:Envelope&gt;<BR></PRE><BR><B>Response</B><BR><PRE>HTTP/1.1 500 Internal Server Error<BR>CONTENT-LENGTH: 410<BR>CONTENT-TYPE: text/xml; charset="utf-8"<BR>DATE: Tue, 22 Jul 2008 13:32:14 GMT<BR>EXT:<BR>SERVER: Linux/2.4.17_mvl21-malta-mips_fp_le, UPnP/1.0, Intel SDK for UPnP devices /1.2<BR><BR>&lt;s:Envelope<BR>xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"<BR>s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"&gt;<BR>&lt;s:Body&gt;<BR>&lt;s:Fault&gt;<BR>&lt;faultcode&gt;s:Client&lt;/faultcode&gt;<BR>&lt;faultstring&gt;UPnPError&lt;/faultstring&gt;<BR>&lt;detail&gt;<BR>&lt;UPnPError xmlns="urn:schemas-upnp-org:control-1-0"&gt;<BR>&lt;errorCode&gt;402&lt;/errorCode&gt;<BR>&lt;errorDescription&gt;Invalid Args&lt;/errorDescription&gt;<BR>&lt;/UPnPError&gt;<BR>&lt;/detail&gt;<BR>&lt;/s:Fault&gt;<BR>&lt;/s:Body&gt;<BR>&lt;/s:Envelope&gt;<BR></PRE><BR><B><BIG>Add 
                                Port Mapping</BIG></B><BR><BR><B>Request</B><BR><PRE>POST /upnp/control/WANIPConnection HTTP/1.1<BR>HOST: 192.168.0.1:49153<BR>CONTENT-LENGTH: 607<BR>CONTENT-TYPE: text/xml; charset="utf-8"<BR>SOAPACTION: "urn:schemas-upnp-org:service:WANIPConnection:1#AddPortMapping"<BR><BR>&lt;?xml version="1.0"?&gt;<BR>&lt;s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"&gt;<BR>&lt;s:Body&gt;<BR>&lt;u:AddPortMapping xmlns:u="urn:schemas-upnp-org:service:WANIPConnection:1"&gt;<BR>&lt;NewRemoteHost&gt;<BR>&lt;/NewRemoteHost&gt;<BR>&lt;NewExternalPort&gt;1234&lt;/NewExternalPort&gt;<BR>&lt;NewProtocol&gt;TCP&lt;/NewProtocol&gt;<BR>&lt;NewInternalPort&gt;1234&lt;/NewInternalPort&gt;<BR>&lt;NewInternalClient&gt;192.168.0.5&lt;/NewInternalClient&gt;<BR>&lt;NewEnabled&gt;1&lt;/NewEnabled&gt;<BR>&lt;NewPortMappingDescription&gt;uTorrent (TCP)&lt;/NewPortMappingDescription&gt;<BR>&lt;NewLeaseDuration&gt;0&lt;/NewLeaseDuration&gt;<BR>&lt;/u:AddPortMapping&gt;<BR>&lt;/s:Body&gt;<BR>&lt;/s:Envelope&gt;<BR></PRE><BR><B>Response</B><BR><PRE>HTTP/1.1 200 OK<BR>CONTENT-LENGTH: 259<BR>CONTENT-TYPE: text/xml; charset="utf-8"<BR>DATE: Tue, 22 Jul 2008 13:32:14 GMT<BR>EXT:<BR>SERVER: Linux/2.4.17_mvl21-malta-mips_fp_le, UPnP/1.0, Intel SDK for UPnP devices /1.2<BR><BR>&lt;s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"&gt;<BR>&lt;s:Body&gt;<BR>&lt;u:AddPortMappingResponse xmlns:u="urn:upnp-org:serviceId:WANIPConnection"&gt;<BR>&lt;/u:AddPortMappingResponse&gt;<BR>&lt;/s:Body&gt;<BR>&lt;/s:Envelope&gt;<BR></PRE><BR><B><BIG>Delete 
                                Port Mapping</BIG></B><BR><BR><B>Request</B><BR><PRE>POST /upnp/control/WANIPConnection HTTP/1.1<BR>HOST: 192.168.0.1:49153<BR>CONTENT-LENGTH: 390<BR>CONTENT-TYPE: text/xml; charset="utf-8"<BR>SOAPACTION: "urn:schemas-upnp-org:service:WANIPConnection:1#DeletePortMapping"<BR><BR>&lt;?xml version="1.0"?&gt;<BR>&lt;s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"&gt;<BR>&lt;s:Body&gt;<BR>&lt;u:DeletePortMapping xmlns:u="urn:schemas-upnp-org:service:WANIPConnection:1"&gt;<BR>&lt;NewRemoteHost&gt;<BR>&lt;/NewRemoteHost&gt;<BR>&lt;NewExternalPort&gt;1234&lt;/NewExternalPort&gt;<BR>&lt;NewProtocol&gt;TCP&lt;/NewProtocol&gt;<BR>&lt;/u:DeletePortMapping&gt;<BR>&lt;/s:Body&gt;<BR>&lt;/s:Envelope&gt;<BR></PRE><BR><B>Response</B><BR><PRE>HTTP/1.1 200 OK<BR>CONTENT-LENGTH: 265<BR>CONTENT-TYPE: text/xml; charset="utf-8"<BR>DATE: Tue, 22 Jul 2008 13:32:14 GMT<BR>EXT:<BR>SERVER: Linux/2.4.17_mvl21-malta-mips_fp_le, UPnP/1.0, Intel SDK for UPnP devices /1.2<BR><BR>&lt;s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"&gt;<BR>&lt;s:Body&gt;<BR>&lt;u:DeletePortMappingResponse xmlns:u="urn:upnp-org:serviceId:WANIPConnection"&gt;<BR>&lt;/u:DeletePortMappingResponse&gt;<BR>&lt;/s:Body&gt;<BR>&lt;/s:Envelope&gt;<BR></PRE><BR><BR>Hope 
                                this is useful to you / others. <BR><BR>
                                <DIV class=ForumMod>modified on Tuesday, July 
                                22, 2008 11:24 AM</DIV><BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: middle">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2647441&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2647441&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;tid=2647200">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=1511377&amp;msg=2647441">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=2647441&amp;obtid=3&amp;bma=AddBookmark">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF2647441 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT type=text/javascript>
												MsgVFrm(2649904,2647441,false,"","","");
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 alt="" 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/t.gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=F2647505_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=70><A 
                        name=xx2647505xx></A><IMG height=16 alt=General 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_general.gif" 
                        width=16 align=top></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;select=2647505#xx2647505xx" 
                        name=2647505>Re: Too hardcoded to work 
universally</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 alt=member 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=4475648">harold 
                        aptroot</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">8:49 22 
                        Jul '08 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=F2647505_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 70px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Thanx <IMG title=Smile 
                                src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/smiley_smile.gif" 
                                align=top><BR>Will update soon<BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: middle">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2647505&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2647505&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;tid=2647200">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=1511377&amp;msg=2647505">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=2647505&amp;obtid=3&amp;bma=AddBookmark">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF2647505 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT type=text/javascript>
												MsgVFrm(4475648,2647505,false,"","","");
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 alt="" 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/t.gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HiVote HdUnSel " id=F2648338_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=88><A 
                        name=xx2648338xx></A><IMG height=16 alt=General 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_general.gif" 
                        width=16 align=top></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;select=2648338#xx2648338xx" 
                        name=2648338>Re: Too hardcoded to work 
universally</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 alt=member 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=2649904">ajiau</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">23:56 
                        22 Jul '08 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=F2648338_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 88px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>I'm going to expand it to support 
                                query of existing mappings and deletion of 
                                mappings. I'll let you know how I 
                                go.<BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: middle">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2648338&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2648338&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;tid=2647200">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=1511377&amp;msg=2648338">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=2648338&amp;obtid=3&amp;bma=AddBookmark">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF2648338 
                                style="WHITE-SPACE: nowrap">5.00/5 (1 vote)
                                <SCRIPT type=text/javascript>
												MsgVFrm(2649904,2648338,false,"","","");
											</SCRIPT>
                                 
                        </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 alt="" 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/t.gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=F2649040_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=106><A 
                        name=xx2649040xx></A><IMG height=16 alt=General 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_general.gif" 
                        width=16 align=top></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;select=2649040#xx2649040xx" 
                        name=2649040>Re: Too hardcoded to work 
universally</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 alt=member 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=4475648">harold 
                        aptroot</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">7:35 23 
                        Jul '08 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=F2649040_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 106px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Cool <IMG title=Smile 
                                src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/smiley_smile.gif" 
                                align=top><BR>Good luck, it would be nice to add 
                                those<BR>So far I've had little success with the 
                                querying of existing mappings.. must be doing 
                                something wrong.. <BR>So I hope you get it 
                                working<BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: middle">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2649040&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2649040&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;tid=2647200">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=1511377&amp;msg=2649040">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=2649040&amp;obtid=3&amp;bma=AddBookmark">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF2649040 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT type=text/javascript>
												MsgVFrm(4475648,2649040,false,"","","");
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 alt="" 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/t.gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=F2652727_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=116><A 
                        name=xx2652727xx></A><IMG height=16 alt=General 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_general.gif" 
                        width=16 align=top></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;select=2652727#xx2652727xx" 
                        name=2652727>Re: Too hardcoded to work 
universally</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 alt=member 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=2649904">ajiau</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">8:25 26 
                        Jul '08 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=F2652727_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 116px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>I got a little carried away, and 
                                refactored the whole thing.&nbsp;&nbsp; Changes 
                                include:<BR><BR>1) Add, Delete, Query all 
                                mappings.<BR>2) Supports multiple routers on one 
                                subnet.<BR>3) Supports router discovery without 
                                SSDP.<BR>4) Supports multiple network card 
                                setups.<BR>5) Includes improved SOAP compliance, 
                                and a nicer abstraction of all soap 
                                actions.<BR>6) Added a lot of comments to the 
                                code.<BR>7) Broke all Async code (sorry, but you 
                                should make the async entrypoints jsut wrap the 
                                regular ones.)<BR><BR>**Note to all who try 
                                this, please let me know whether it works for 
                                you!**<BR><BR>// SNIP //<BR>using 
                                System;<BR>using 
                                System.Collections.Generic;<BR>using 
                                System.Text;<BR>using System.Net;<BR>using 
                                System.Net.Sockets;<BR>using 
                                System.Net.NetworkInformation;<BR>using 
                                System.Xml;<BR>using System.IO;<BR><BR>namespace 
                                UPnP<BR>{<BR>&nbsp;&nbsp; &nbsp;&nbsp; //public 
                                delegate void Method();<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; public class NAT<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; {<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; //public static void 
                                BeginDiscover(Method callback)<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                //{<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; //&nbsp;&nbsp; &nbsp;&nbsp; Socket 
                                s = new Socket(AddressFamily.InterNetwork, 
                                SocketType.Dgram, 
                                ProtocolType.Udp);<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                //&nbsp;&nbsp; &nbsp;&nbsp; 
                                s.SetSocketOption(SocketOptionLevel.Socket, 
                                SocketOptionName.Broadcast, 
                                1);<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; //&nbsp;&nbsp; 
                                &nbsp;&nbsp; String req =<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                //&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; "M-SEARCH * HTTP/1.1\r\n" 
                                +<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; //&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; "HOST: 
                                239.255.255.250:1900\r\n" +<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                //&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; "ST:upnp:rootdevice\r\n" 
                                +<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; //&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                "MAN:\"ssdp:discover\"\r\n" +<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                //&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; "MX:3\r\n\r\n";<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                //&nbsp;&nbsp; &nbsp;&nbsp; byte[] data = 
                                Encoding.ASCII.GetBytes(req);<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                //&nbsp;&nbsp; &nbsp;&nbsp; s.BeginSendTo(data, 
                                0, data.Length, SocketFlags.None, new 
                                IPEndPoint(IPAddress.Broadcast, 
                                1900),<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; //&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; delegate(IAsyncResult 
                                ar)<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; //&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; {<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                //&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                s.EndSendTo(ar);<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; //&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; byte[] buffer = new 
                                byte[0x1000];<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; //&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; s.BeginReceive(buffer, 
                                0, 0x1000, SocketFlags.None, 
                                delegate(IAsyncResult rar)<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                //&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                {<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; //&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; int l = 
                                s.EndReceive(rar);<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; //&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; String resp = 
                                Encoding.ASCII.GetString(buffer, 0, 
                                l);<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; //&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; if 
                                (resp.ToLower().Contains("upnp:rootdevice"))<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                //&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; {<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                //&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; resp = 
                                resp.Substring(resp.ToLower().IndexOf("location:") 
                                + "Location:".Length);<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                //&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; resp = resp.Substring(0, 
                                resp.IndexOf("\r")).Trim();<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                //&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; if 
                                (resp.ToLower().Contains(".xml"))<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                //&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; {<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; //&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; descUrl = 
                                resp;<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; //&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; 
                                BeginGetServiceUrl(callback);<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                //&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; }<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; //&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; //&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; }, 
                                null);<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; //&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; }, 
                                null);<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; //}<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; /// 
                                &lt;summary&gt;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; /// Below are several 
                                possible Service Description URL 
                                Suffixes<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; /// Some are found 
                                through personal testing, other are 
                                found<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; /// from Google searchs for 
                                potential SSDP query results.<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; /// 
                                &lt;/summary&gt;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; static String[] 
                                ServiceSuffixes = new String[] {<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; "/desc.xml", // DLink 
                                DWL....<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; "/description.xml",<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                "/InternetGatewayDevice.xml",<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                "/upnp/service/des_ppp.xml",<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                "/wanipconn-361.xml",<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                ":5678/igd.xml",<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; 
                                ":5678/rootDesc.xml",<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                ":49000/igddesc.xml",<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; ":49152/gateway.xml", 
                                // DG834Gv3<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; ":49153/gateway.xml", // 
                                DG834Gv1<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; ":54877/",<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                ":49152/description.xml",<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                ":1064/",<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; ":1900/igd.xml",<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                ""};<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; /// 
                                &lt;summary&gt;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; /// Here are some 
                                possible SSDP Broadcast addresses to 
                                try.<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; /// The standard requires only the 
                                first, but we're trying to<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; /// 
                                handle devices which may not necessarily obey 
                                the standard too.<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; /// 
                                &lt;/summary&gt;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; static String[] 
                                SSDPAddresses = new String[] {<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                "239.255.255.250"/*,<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                "255.255.255.255"*/<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; };<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; /// 
                                &lt;summary&gt;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; /// Here we store the 
                                results for SSDP and Default Gateway 
                                Probing.<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; /// 
                                &lt;/summary&gt;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; static 
                                List&lt;String&gt; PotentialHosts = new 
                                List&lt;String&gt;();<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; /// 
                                &lt;summary&gt;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; /// Here we store the 
                                confirmed UPnP service control 
                                URLs<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; /// 
                                &lt;/summary&gt;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; static 
                                List&lt;String&gt; ServiceURLs = new 
                                List&lt;String&gt;();<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; static 
                                IPAddress MyAddress = null;<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; /// 
                                &lt;summary&gt;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; /// Begin the 
                                discovery process.<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; /// 
                                &lt;/summary&gt;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; /// &lt;returns&gt;The 
                                number of NAT devices 
                                discovered&lt;/returns&gt;<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; public 
                                static int Discover()<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                {<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                PotentialHosts.Clear();<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                ServiceURLs.Clear();<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                DefaultGateways_Probe();<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                SSPD_Probe();<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; 
                                GetServiceUrls();<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; return 
                                ServiceURLs.Count;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; /// 
                                &lt;summary&gt;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; /// Use SSDP to 
                                discover NAT routers in the local 
                                network.<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; /// 
                                &lt;/summary&gt;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; private static void 
                                SSPD_Probe()<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; {<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; Socket s = new 
                                Socket(AddressFamily.InterNetwork, 
                                SocketType.Dgram, 
                                ProtocolType.Udp);<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; 
                                s.SetSocketOption(SocketOptionLevel.Socket, 
                                SocketOptionName.Broadcast, 1);<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; s.ReceiveTimeout = 
                                100;<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; foreach (String sSSDPAddress in 
                                SSDPAddresses)<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; {<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; String 
                                req = String.Format(<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; "M-SEARCH 
                                * HTTP/1.1\r\n" +<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; "HOST: {0}:1900\r\n" 
                                +<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; "ST:upnp:rootdevice\r\n" 
                                +<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; "MAN:\"ssdp:discover\"\r\n" 
                                +<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; "MX:3\r\n\r\n",<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                sSSDPAddress);<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; byte[] 
                                data = 
                                Encoding.ASCII.GetBytes(req);<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; byte[] buffer = new 
                                byte[0x1000];<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; for (int 
                                i = 0; i &lt; 2; i++)<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; {<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; try<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                {<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                s.SendTo(data, new 
                                IPEndPoint(IPAddress.Broadcast, 
                                1900));<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; while (true)<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; {<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; int l = 
                                s.Receive(buffer);<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; String resp = 
                                Encoding.ASCII.GetString(buffer, 0, 
                                l);<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; if 
                                (resp.ToLower().Contains("upnp:rootdevice"))<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; {<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; resp = 
                                resp.Substring(resp.ToLower().IndexOf("location:") 
                                + "Location:".Length);<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; resp = 
                                resp.Substring(0, 
                                resp.IndexOf("\r")).Trim();<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; if 
                                (!PotentialHosts.Contains(resp))<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                {<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                PotentialHosts.Add(resp);<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                }<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; }<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; }<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                }<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; catch<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; {<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                }<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; }<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; }<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                }<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; /// &lt;summary&gt;<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; /// 
                                Iterate through all local network 
                                adaptors.&nbsp;&nbsp; Find out the 
                                <BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; /// default gateway, and store 
                                possible addresses on the 
                                default<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; /// gateway for 
                                further probing later.<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; /// 
                                &lt;/summary&gt;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; private static void 
                                DefaultGateways_Probe()<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                {<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                IPGlobalProperties ipProperties = 
                                IPGlobalProperties.GetIPGlobalProperties();<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; foreach 
                                (NetworkInterface networkCard in 
                                NetworkInterface.GetAllNetworkInterfaces())<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; {<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; foreach 
                                (GatewayIPAddressInformation gatewayAddr in 
                                networkCard.GetIPProperties().GatewayAddresses)<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; {<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; // Store the first IP 
                                Address of the first Network interface 
                                which<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; // has a valid default 
                                gateway.&nbsp;&nbsp; (Where there are multiple 
                                network <BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; // interfaces on a 
                                single PC, this one is most likely the one we 
                                want.<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; if (MyAddress == 
                                null)<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; {<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; MyAddress = 
                                networkCard.GetIPProperties().UnicastAddresses[0].Address;<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                }<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; // Transform the discovered gateway 
                                to a set of possible<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; // urls, 
                                based on possible Service URLS.<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; foreach 
                                (String sSuffix in 
                                ServiceSuffixes)<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; {<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; String sHost = 
                                String.Format(@"http://{0}{1}", 
                                gatewayAddr.Address.ToString(), 
                                sSuffix);<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; if 
                                (!PotentialHosts.Contains(sHost))<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; {<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; 
                                PotentialHosts.Add(sHost);<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; }<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                }<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; }<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; }<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                }<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; //static void 
                                BeginGetServiceUrl(Method 
                                callback)<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; //{<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                //&nbsp;&nbsp; &nbsp;&nbsp; WebRequest req = 
                                WebRequest.Create(descUrl);<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                //&nbsp;&nbsp; &nbsp;&nbsp; 
                                req.BeginGetResponse(delegate(IAsyncResult 
                                ar)<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; //&nbsp;&nbsp; &nbsp;&nbsp; 
                                {<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; //&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                GetServiceUrl();<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; //&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; if 
                                (callback != null) callback();<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                //&nbsp;&nbsp; &nbsp;&nbsp; }, 
                                null);<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; //}<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; /// 
                                &lt;summary&gt;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; /// Quickly scan 
                                through all potential UPnP addresses, 
                                discarding<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; /// anything that 
                                looks wrong, and retreiving service URLS 
                                for<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; /// those that 
                                work.<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; /// 
                                &lt;/summary&gt;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; static void 
                                GetServiceUrls()<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; {<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; foreach (String 
                                descUrl in 
                                PotentialHosts.ToArray())<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; {<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; try<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                {<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; WebRequest web = 
                                WebRequest.Create(descUrl);<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                web.Timeout = 50;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; XmlDocument desc = new 
                                XmlDocument();<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                desc.Load(web.GetResponse().GetResponseStream());<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                XmlNamespaceManager nsMgr = new 
                                XmlNamespaceManager(desc.NameTable);<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                nsMgr.AddNamespace("tns", 
                                "urn:schemas-upnp-org:device-1-0");<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; XmlNode 
                                node = 
                                desc.SelectSingleNode("//tns:service[tns:serviceType=\"urn:schemas-upnp-org:service:WANIPConnection:1\"]/tns:controlURL/text()", 
                                nsMgr);<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; if (node != 
                                null)<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; {<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; String sRelativeURL = 
                                node.Value;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; int n = 
                                descUrl.IndexOf("://");<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; if (n &gt; 
                                -1)<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                {<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; n = 
                                descUrl.IndexOf('/', n + 3);<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; if (n &gt; -1)<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; {<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                ServiceURLs.Add(descUrl.Substring(0, n) + 
                                sRelativeURL);<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                continue;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                }<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                }<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; }<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                }<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; catch 
                                (WebException)<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; { 
                                }<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                PotentialHosts.Remove(descUrl);<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; }<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                }<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; public static IPAddress 
                                GetExternalIP(int iServiceId)<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                {<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; IPAddress 
                                addr = null;<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; String sServiceURL = 
                                ServiceURLs[iServiceId];<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; SoapBuilder soap = new 
                                SoapBuilder(sServiceURL, 
                                "GetExternalIPAddress");<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; if 
                                (soap.TryPostMessage())<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; {<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; try<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                {<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; String IP = 
                                soap.GetValue("NewExternalIPAddress");<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; addr = 
                                IPAddress.Parse(IP);<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; }<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; catch { 
                                }<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                }<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; return 
                                addr;<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; public static Boolean 
                                AddPortMapping(int iServiceId, int Port, 
                                ProtocolType Protocol, String 
                                Description)<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; {<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; Boolean bRet = 
                                false;<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; String serviceUrl = 
                                ServiceURLs[iServiceId];<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; SoapBuilder soap = new 
                                SoapBuilder(serviceUrl, 
                                "AddPortMapping");<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                soap.AddParams("NewRemoteHost", 
                                "");<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                soap.AddParams("NewExternalPort", 
                                Port);<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                soap.AddParams("NewProtocol", 
                                Protocol);<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; soap.AddParams("NewInternalPort", 
                                Port);<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                soap.AddParams("NewInternalClient", 
                                MyAddress);<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; soap.AddParams("NewEnabled", 
                                1);<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                soap.AddParams("NewPortMappingDescription", 
                                Description);<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; soap.AddParams("NewLeaseDuration", 
                                0);<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; if 
                                (soap.TryPostMessage())<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; {<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; bRet = true;<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; return 
                                bRet;<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; public static Boolean 
                                GetGenericPortMapping(int iServiceId, int index, 
                                out int Port, out ProtocolType Protocol, out 
                                IPAddress Client, out Boolean Enabled, out 
                                String Description)<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; {<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; Boolean bRet = 
                                false;<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; Port = 0;<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; Protocol = 
                                ProtocolType.Unknown;<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; Client = 
                                IPAddress.None;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; Enabled = false;<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; Description = 
                                String.Empty;<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; String sServiceURL = 
                                ServiceURLs[iServiceId];<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; SoapBuilder soap = new 
                                SoapBuilder(sServiceURL, 
                                "GetGenericPortMappingEntry");<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                soap.AddParams("NewPortMappingIndex", 
                                index);<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; if 
                                (soap.TryPostMessage())<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; {<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; try<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                {<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; String sPort = 
                                soap.GetValue("NewInternalPort");<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; String 
                                sProtocol = 
                                soap.GetValue("NewProtocol");<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; String 
                                sClient = 
                                soap.GetValue("NewInternalClient");<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; String 
                                sEnabled = 
                                soap.GetValue("NewEnabled");<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; String 
                                sDescription = 
                                soap.GetValue("NewPortMappingDescription");<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; Port = 
                                int.Parse(sPort);<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; Protocol = 
                                sProtocol.ToLower().Equals("udp") ? 
                                ProtocolType.Udp : 
                                ProtocolType.Tcp;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; Client = 
                                IPAddress.Parse(sClient);<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; Enabled = 
                                int.Parse(sEnabled) &gt; 0;<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                Description = sDescription;<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; bRet = 
                                true;<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; }<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; catch { }<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; return 
                                bRet;<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; public static Boolean 
                                DeletePortMapping(int iServiceId, int Port, 
                                ProtocolType Protocol)<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                {<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; Boolean 
                                bRet = false;<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; String sServiceURL = 
                                ServiceURLs[iServiceId];<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; SoapBuilder soap = new 
                                SoapBuilder(sServiceURL, 
                                "DeletePortMapping");<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                soap.AddParams("NewRemoteHost");<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                soap.AddParams("NewExternalPort", 
                                Port);<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                soap.AddParams("NewProtocol", 
                                Protocol);<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; if 
                                (soap.TryPostMessage())<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; {<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; bRet = true;<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; return 
                                bRet;<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; }<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                }<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; /// 
                                &lt;summary&gt;<BR>&nbsp;&nbsp; &nbsp;&nbsp; /// 
                                Abstraction for managing simple SOAP 
                                interactions.<BR>&nbsp;&nbsp; &nbsp;&nbsp; /// 
                                &lt;/summary&gt;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                class SoapBuilder<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                {<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; readonly String 
                                URL;<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; readonly String 
                                Action;<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; XmlDocument Response = 
                                null;<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; XmlNamespaceManager nsMgr = 
                                null;<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; /// 
                                &lt;summary&gt;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; /// Construct a new 
                                SOAP message<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; /// 
                                &lt;/summary&gt;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; /// &lt;param 
                                name="url"&gt;UPnP Control 
                                URL&lt;/param&gt;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; /// &lt;param 
                                name="action"&gt;SOAP 
                                Action&lt;/param&gt;<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; public 
                                SoapBuilder(String url, String 
                                action)<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; {<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; URL = 
                                url;<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; Action = 
                                action;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                List&lt;String&gt; Params = new 
                                List&lt;string&gt;();<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                List&lt;String&gt; Types = new 
                                List&lt;string&gt;();<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                List&lt;object&gt; Values = new 
                                List&lt;object&gt;();<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; public 
                                void AddParams(String sParam)<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                {<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                AddParams(sParam, String.Empty);<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                }<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; public void AddParams(String 
                                sParam, object oValue)<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                {<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                Params.Add(sParam);<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; <BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; String sType;<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; if (oValue is 
                                int)<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                {<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; sType = 
                                "ui2";<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                }<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; else if 
                                (oValue is string)<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; {<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; sType = 
                                "string";<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; }<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; else if (oValue is 
                                ProtocolType)<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; {<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; sType = 
                                "string";<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; oValue = 
                                oValue.ToString().ToUpper();<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; }<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; else if (oValue is 
                                IPAddress)<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; {<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; sType = 
                                "string";<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; }<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; else<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; {<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; sType = 
                                "string";<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; }<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; 
                                Types.Add(sType);<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                Values.Add(oValue);<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; /// 
                                &lt;summary&gt;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; /// Build up a SOAP 
                                message with the information we now have, send 
                                it off, and interpret the 
                                response.<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; /// 
                                &lt;/summary&gt;<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; /// 
                                &lt;returns&gt;Returns TRUE if no error 
                                occurred.&nbsp;&nbsp; (Will return TRUE even if 
                                you are requesting an invalid 
                                deletion.&lt;/returns&gt;<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; public 
                                Boolean TryPostMessage()<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                {<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; Boolean 
                                bRet = false;<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; StringBuilder sbRequest = new 
                                StringBuilder();<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                sbRequest.AppendLine("&lt;?xml 
                                version=\"1.0\"?&gt;");<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                sbRequest.Append("&lt;SOAP-ENV:Envelope 
                                xmlns:SOAP-ENV=\"http://schemas.xmlsoap.org/soap/envelope/\" 
                                SOAP-ENV:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\"&gt;");<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                sbRequest.Append("&lt;SOAP-ENV:Body&gt;");<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                sbRequest.AppendFormat("&lt;m:{0} 
                                xmlns:m=\"urn:schemas-upnp-org:service:WANIPConnection:1\"&gt;", 
                                Action);<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; for (int i = 0; i &lt; 
                                Params.Count; i++)<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; {<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                sbRequest.AppendFormat("&lt;{0} 
                                xmlns:dt=\"urn:schemas-microsoft-com:datatypes\" 
                                dt:dt=\"{1}\"&gt;{2}&lt;/{0}&gt;", Params[i], 
                                Types[i], Values[i]);<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; }<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                sbRequest.AppendFormat("&lt;/m:{0}&gt;", 
                                Action);<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; 
                                sbRequest.Append("&lt;/SOAP-ENV:Body&gt;");<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                sbRequest.Append("&lt;/SOAP-ENV:Envelope&gt;");<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; Byte[] soapRequest = 
                                Encoding.UTF8.GetBytes(sbRequest.ToString());<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; WebRequest webReq = 
                                HttpWebRequest.Create(URL);<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; webReq.Timeout = 
                                500;<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                webReq.Method = "POST";<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; 
                                webReq.Headers.Add("SOAPACTION", 
                                "\"urn:schemas-upnp-org:service:WANIPConnection:1#" 
                                + Action + "\"");<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; webReq.ContentType = "text/xml; 
                                charset=\"utf-8\"";<BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; webReq.ContentLength = 
                                soapRequest.Length;<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; try<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; {<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; 
                                webReq.GetRequestStream().Write(soapRequest, 0, 
                                soapRequest.Length);<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; Response = new 
                                XmlDocument();<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                Response.Load(webReq.GetResponse().GetResponseStream());<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; nsMgr = new 
                                XmlNamespaceManager(Response.NameTable);<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; nsMgr.AddNamespace("tns", 
                                "urn:schemas-upnp-org:device-1-0");<BR><BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; bRet = true;<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; }<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; catch { 
                                }<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; return 
                                bRet;<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; public String 
                                GetValue(String Param)<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                {<BR>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; return 
                                Response.SelectSingleNode(String.Format("//{0}/text()", 
                                Param), nsMgr).Value;<BR>&nbsp;&nbsp; 
                                &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; 
                                }<BR>&nbsp;&nbsp; &nbsp;&nbsp; }<BR>}<BR>// SNIP 
                                // <BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: middle">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2652727&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2652727&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;tid=2647200">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=1511377&amp;msg=2652727">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=2652727&amp;obtid=3&amp;bma=AddBookmark">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF2652727 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT type=text/javascript>
												MsgVFrm(2649904,2652727,false,"","","");
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 alt="" 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/t.gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=F2653053_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=126><A 
                        name=xx2653053xx></A><IMG height=16 alt=General 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_general.gif" 
                        width=16 align=top></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;select=2653053#xx2653053xx" 
                        name=2653053>Re: Too hardcoded to work 
universally</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 alt=member 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=4475648">harold 
                        aptroot</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">17:37 
                        26 Jul '08 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=F2653053_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 126px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Nice nice<BR>I'll work on updating 
                                everything<BR>Thanks <IMG title=Smile 
                                src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/smiley_smile.gif" 
                                align=top><BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: middle">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2653053&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2653053&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;tid=2647200">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=1511377&amp;msg=2653053">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=2653053&amp;obtid=3&amp;bma=AddBookmark">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF2653053 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT type=text/javascript>
												MsgVFrm(4475648,2653053,false,"","","");
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 alt="" 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/t.gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=F2677156_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=136><A 
                        name=xx2677156xx></A><IMG height=16 alt=General 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_general.gif" 
                        width=16 align=top></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;select=2677156#xx2677156xx" 
                        name=2677156>Re: Too hardcoded to work 
                        universally</A><IMG height=12 alt=new 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/New.gif" 
                        width=31></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 alt=member 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=112569">sdssd</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">9:45 13 
                        Aug '08 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=F2677156_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 136px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>ajiau <BR><BR>I tried to work with 
                                your code but my router which is Wireless-N 
                                Gigabit Router WRT310N <BR>is returning this 
                                error<BR>System.Net.WebException: The remote 
                                server returned an error: (500) Internal Server 
                                Error.<BR>at 
                                System.Net.HttpWebRequest.GetResponse()<BR><BR>Any 
                                Idea<BR><BR>I am calling the Service like 
                                this<BR><BR>NAT.Discover();<BR>// 
                                NAT.GetExternalIP(0);<BR>NAT.AddPortMapping(0, 
                                4098, ProtocolType.Tcp, 
                                "HelloWorld");<BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: middle">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2677156&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2677156&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;tid=2647200">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=1511377&amp;msg=2677156">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=2677156&amp;obtid=3&amp;bma=AddBookmark">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF2677156 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT type=text/javascript>
												MsgVFrm(112569,2677156,false,"","","");
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 alt="" 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/t.gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=F2677158_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=146><A 
                        name=xx2677158xx></A><IMG height=16 alt=General 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_general.gif" 
                        width=16 align=top></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;select=2677158#xx2677158xx" 
                        name=2677158>Re: Too hardcoded to work 
                        universally</A><IMG height=12 alt=new 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/New.gif" 
                        width=31></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 alt=member 
                        src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=112569">sdssd</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">9:45 13 
                        Aug '08 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=F2677158_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 146px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>More info on the error:<BR>I can 
                                see your code detecting IGD with success so 
                                Congrats over that:<BR><BR>Here is the request 
                                object created :<BR><BR>COntrol URL is fine and 
                                responding: here is the xml returned by the 
                                router:<BR>&lt;?xml version="1.0" ?&gt; <BR>- 
                                &lt;root 
                                xmlns="urn:schemas-upnp-org:device-1-0"&gt;<BR>- 
                                &lt;specVersion&gt;<BR>&lt;major&gt;1&lt;/major&gt; 
                                <BR>&lt;minor&gt;0&lt;/minor&gt; 
                                <BR>&lt;/specVersion&gt;<BR>&lt;URLBase&gt;http://192.168.1.1:5431&lt;/URLBase&gt; 
                                <BR>- 
                                &lt;device&gt;<BR>&lt;deviceType&gt;urn:schemas-upnp-org:device:InternetGatewayDevice:1&lt;/deviceType&gt; 
                                <BR>&lt;presentationURL&gt;/index.asp&lt;/presentationURL&gt; 
                                <BR>&lt;friendlyName&gt;WRT310N&lt;/friendlyName&gt; 
                                <BR>&lt;manufacturer&gt;Linksys 
                                Inc.&lt;/manufacturer&gt; 
                                <BR>&lt;manufacturerURL&gt;http://www.linksys.com/&lt;/manufacturerURL&gt; 
                                <BR>&lt;modelDescription&gt;Internet Access 
                                Server&lt;/modelDescription&gt; 
                                <BR>&lt;modelName&gt;WRT310N&lt;/modelName&gt; 
                                <BR>&lt;modelNumber&gt;v1.00.1&lt;/modelNumber&gt; 
                                <BR>&lt;modelURL&gt;http://www.linksys.com/&lt;/modelURL&gt; 
                                <BR>&lt;UDN&gt;uuid:001d7ee1-b8ed-001d-7ee1-b8ed0000e800&lt;/UDN&gt; 
                                <BR>- &lt;serviceList&gt;<BR>- 
                                &lt;service&gt;<BR>&lt;serviceType&gt;urn:schemas-upnp-org:service:Layer3Forwarding:1&lt;/serviceType&gt; 
                                <BR>&lt;serviceId&gt;urn:upnp-org:serviceId:Layer3Forwarding:11&lt;/serviceId&gt; 
                                <BR>&lt;controlURL&gt;/uuid:001d7ee1-b8ed-001d-7ee1-b8ed0000e800/Layer3Forwarding:1&lt;/controlURL&gt; 
                                <BR>&lt;eventSubURL&gt;/uuid:001d7ee1-b8ed-001d-7ee1-b8ed0000e800/Layer3Forwarding:1&lt;/eventSubURL&gt; 
                                <BR>&lt;SCPDURL&gt;/dynsvc/Layer3Forwarding:1.xml&lt;/SCPDURL&gt; 
                                <BR>&lt;/service&gt;<BR>&lt;/serviceList&gt;<BR>- 
                                &lt;deviceList&gt;<BR>- 
                                &lt;device&gt;<BR>&lt;deviceType&gt;urn:schemas-upnp-org:device:WANDevice:1&lt;/deviceType&gt; 
                                <BR>&lt;friendlyName&gt;urn:schemas-upnp-org:device:WANDevice:1&lt;/friendlyName&gt; 
                                <BR>&lt;manufacturer&gt;Linksys 
                                Inc.&lt;/manufacturer&gt; 
                                <BR>&lt;manufacturerURL&gt;http://www.linksys.com/&lt;/manufacturerURL&gt; 
                                <BR>&lt;modelDescription&gt;Internet Access 
                                Server&lt;/modelDescription&gt; 
                                <BR>&lt;modelName&gt;WRT310N&lt;/modelName&gt; 
                                <BR>&lt;modelNumber&gt;v1.00.1&lt;/modelNumber&gt; 
                                <BR>&lt;modelURL&gt;http://www.linksys.com/&lt;/modelURL&gt; 
                                <BR>&lt;UDN&gt;uuid:001d7ee1-b8ed-001d-7ee1-b8ed0100e800&lt;/UDN&gt; 
                                <BR>- &lt;serviceList&gt;<BR>- 
                                &lt;service&gt;<BR>&lt;serviceType&gt;urn:schemas-upnp-org:service:WANCommonInterfaceConfig:1&lt;/serviceType&gt; 
                                <BR>&lt;serviceId&gt;urn:upnp-org:serviceId:WANCommonIFC1&lt;/serviceId&gt; 
                                <BR>&lt;controlURL&gt;/uuid:001d7ee1-b8ed-001d-7ee1-b8ed0100e800/WANCommonInterfaceConfig:1&lt;/controlURL&gt; 
                                <BR>&lt;eventSubURL&gt;/uuid:001d7ee1-b8ed-001d-7ee1-b8ed0100e800/WANCommonInterfaceConfig:1&lt;/eventSubURL&gt; 
                                <BR>&lt;SCPDURL&gt;/dynsvc/WANCommonInterfaceConfig:1.xml&lt;/SCPDURL&gt; 
                                <BR>&lt;/service&gt;<BR>&lt;/serviceList&gt;<BR>- 
                                &lt;deviceList&gt;<BR>- 
                                &lt;device&gt;<BR>&lt;deviceType&gt;urn:schemas-upnp-org:device:WANConnectionDevice:1&lt;/deviceType&gt; 
                                <BR>&lt;friendlyName&gt;urn:schemas-upnp-org:device:WANConnectionDevice:1&lt;/friendlyName&gt; 
                                <BR>&lt;manufacturer&gt;Linksys 
                                Inc.&lt;/manufacturer&gt; 
                                <BR>&lt;manufacturerURL&gt;http://www.linksys.com/&lt;/manufacturerURL&gt; 
                                <BR>&lt;modelDescription&gt;Internet Access 
                                Server&lt;/modelDescription&gt; 
                                <BR>&lt;modelName&gt;WRT310N&lt;/modelName&gt; 
                                <BR>&lt;modelNumber&gt;v1.00.1&lt;/modelNumber&gt; 
                                <BR>&lt;modelURL&gt;http://www.linksys.com/&lt;/modelURL&gt; 
                                <BR>&lt;UDN&gt;uuid:001d7ee1-b8ed-001d-7ee1-b8ed0200e800&lt;/UDN&gt; 
                                <BR>- &lt;serviceList&gt;<BR>- 
                                &lt;service&gt;<BR>&lt;serviceType&gt;urn:schemas-upnp-org:service:WANIPConnection:1&lt;/serviceType&gt; 
                                <BR>&lt;serviceId&gt;urn:upnp-org:serviceId:WANIPConn1&lt;/serviceId&gt; 
                                <BR>&lt;controlURL&gt;/uuid:001d7ee1-b8ed-001d-7ee1-b8ed0200e800/WANIPConnection:1&lt;/controlURL&gt; 
                                <BR>&lt;eventSubURL&gt;/uuid:001d7ee1-b8ed-001d-7ee1-b8ed0200e800/WANIPConnection:1&lt;/eventSubURL&gt; 
                                <BR>&lt;SCPDURL&gt;/dynsvc/WANIPConnection:1.xml&lt;/SCPDURL&gt; 
                                <BR>&lt;/service&gt;<BR>- 
                                &lt;service&gt;<BR>&lt;serviceType&gt;urn:schemas-upnp-org:service:WANPPPConnection:1&lt;/serviceType&gt; 
                                <BR>&lt;serviceId&gt;urn:upnp-org:serviceId:WANPPPConn1&lt;/serviceId&gt; 
                                <BR>&lt;controlURL&gt;/uuid:001d7ee1-b8ed-001d-7ee1-b8ed0200e800/WANPPPConnection:1&lt;/controlURL&gt; 
                                <BR>&lt;eventSubURL&gt;/uuid:001d7ee1-b8ed-001d-7ee1-b8ed0200e800/WANPPPConnection:1&lt;/eventSubURL&gt; 
                                <BR>&lt;SCPDURL&gt;/dynsvc/WANPPPConnection:1.xml&lt;/SCPDURL&gt; 
                                <BR>&lt;/service&gt;<BR>&lt;/serviceList&gt;<BR>&lt;/device&gt;<BR>&lt;/deviceList&gt;<BR>&lt;/device&gt;<BR>&lt;/deviceList&gt;<BR>&lt;/device&gt;<BR>&lt;/root&gt;<BR><BR>I 
                                got these results by directly putting the URL in 
                                the browser returned by your code.<BR>anf the 
                                URI is 
                                <BR>http://192.168.1.1:5431/dyndev/uuid:001d7ee1-b8ed-001d-7ee1-b8ed0000e800[^]<BR><BR>If 
                                you need more info letme know<BR>Mean while i am 
                                also trying to debug<BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: middle">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2677158&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=1511377&amp;select=2677158&amp;floc=/KB/IP/upnpnattraversal.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/IP/upnpnattraversal.aspx?fid=1511377&amp;tid=2647200">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=1511377&amp;msg=2677158">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=2677158&amp;obtid=3&amp;bma=AddBookmark">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF2677158 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT type=text/javascript>
												MsgVFrm(112569,2677158,false,"","","");
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR>
                <TD><IMG height=5 alt="" 
                  src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/t.gif" 
                  width=1 border=0></TD></TR></TBODY></TABLE></TD></TR>
        <TR>
          <TD>
            <TABLE cellSpacing=0 cellPadding=2 width="100%">
              <TBODY>
              <TR class=Frm_Footer>
                <TD>Last Visit: Tuesday, July 29, 2008 12:24 AM &nbsp; &nbsp; 
                  Last Update:Thursday, August 14, 2008 11:06 AM</TD>
                <TD 
              style="WHITE-SPACE: nowrap; TEXT-ALIGN: right"></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></DIV>
      <P class=SmallText><IMG height=16 alt=General 
      src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_general.gif" 
      width=16 align=top> General &nbsp;&nbsp; <IMG height=16 alt=News 
      src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_news.gif" 
      width=16 align=top> News &nbsp;&nbsp; <IMG height=16 alt=Question 
      src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_question.gif" 
      width=16 align=top> Question &nbsp;&nbsp; <IMG height=16 alt=Answer 
      src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_answer.gif" 
      width=16 align=top> Answer &nbsp;&nbsp; <IMG height=16 alt=Joke 
      src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_joke.gif" 
      width=16 align=top> Joke &nbsp;&nbsp; <IMG height=16 alt=Rant 
      src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_rant.gif" 
      width=16 align=top> Rant &nbsp;&nbsp; <IMG height=16 alt=Admin 
      src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/msg_admin.gif" 
      width=16 align=top> Admin &nbsp;&nbsp; </P><!-- Forum End --></DIV>
      <TABLE width="100%">
        <TBODY>
        <TR vAlign=top>
          <TD class=TinyText align=left><A id=ctl00_PermaLink 
            href="http://www.codeproject.com/script/Articles/Article.aspx?aid=27992">PermaLink</A> 
            | <A id=ctl00_PrivacyLink 
            href="http://www.codeproject.com/info/privacy.aspx">Privacy </A>| <A 
            id=ctl00_TermsOfUseLink 
            href="http://www.codeproject.com/info/TermsOfUse.aspx">Terms of 
            Use</A> <BR>Last Updated: 21 Jul 2008<BR>Editor: <A 
            id=ctl00_ArticleEditor></A><BR></TD>
          <TD class=TinyText vAlign=top align=right>Copyright 2008 by harold 
            aptroot<BR>Everything else Copyright © <A 
            href="mailto:webmaster@codeproject.com">CodeProject</A>, 1999-2008 
            <BR>Web10 | <A id=ctl00_AdvertiseLink 
            href="http://www.codeproject.com/info/MediaKit.aspx">Advertise on 
            the Code Project </A></TD></TR></TBODY></TABLE>
      <CENTER></CENTER></TD></TR>
  <TR>
    <TD align=middle colSpan=2></TD></TR></TBODY></TABLE><BR>
<SCRIPT language=Javascript type=text/javascript>//<![CDATA[
if (document.all) try {window.attachEvent("oncopy",copyCode);}catch(e){};
//]]></SCRIPT>

<SCRIPT language=Javascript 
src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/TogglePre.js" 
type=text/javascript></SCRIPT>

<SCRIPT language=Javascript 
src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/menu132_com.js" 
type=text/javascript></SCRIPT>

<SCRIPT language=Javascript 
src="CodeProject NAT Traversal with UPnP in C#_ Free source code and programming help_files/TopNavBar.js" 
type=text/javascript></SCRIPT>

<SCRIPT language=Javascript type=text/javascript>//<![CDATA[
new HVMenu(new menu_NavbarConfig());
//]]></SCRIPT>
</BODY></HTML>

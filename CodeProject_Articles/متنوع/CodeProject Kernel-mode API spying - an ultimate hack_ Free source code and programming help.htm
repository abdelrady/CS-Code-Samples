<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!-- saved from url=(0054)http://www.codeproject.com/KB/system/kernelspying.aspx -->
<HTML><HEAD><TITLE>CodeProject: Kernel-mode API spying - an ultimate hack. Free source code and programming help</TITLE>
<META http-equiv=Content-Type content="text/html; charset=utf-8">
<META 
content="An article on kernel-mode API spying.; Author: Anton Bassov; Section: Hardware &amp; System; Chapter: Desktop Development" 
name=Description>
<META 
content="VC6, VC7, VC7.1, Windows, Visual Studio, Dev, Intermediate,Hardware &amp; System,Desktop Development,Free source code, tutorials" 
name=Keywords>
<META content="The Code Project" name=Author>
<META content=General name=Rating>
<META content="index, follow" name=Robots>
<META content="1 days" name=Revisit-After><LINK 
title="CodeProject Lounge Postings" 
href="http://www.codeproject.com/webservices/LoungeRSS.aspx" 
type=application/rss+xml rel=alternate><LINK 
title="CodeProject Latest articles - All topics" 
href="http://www.codeproject.com/webservices/articlerss.aspx?cat=1" 
type=application/rss+xml rel=alternate><LINK 
title="CodeProject Latest articles - MFC / C++" 
href="http://www.codeproject.com/webservices/articlerss.aspx?cat=2" 
type=application/rss+xml rel=alternate><LINK 
title="CodeProject Latest articles - C#" 
href="http://www.codeproject.com/webservices/articlerss.aspx?cat=3" 
type=application/rss+xml rel=alternate><LINK 
title="CodeProject Latest articles - ASP.NET" 
href="http://www.codeproject.com/webservices/articlerss.aspx?cat=4" 
type=application/rss+xml rel=alternate><LINK 
title="CodeProject Latest articles - .NET" 
href="http://www.codeproject.com/webservices/articlerss.aspx?cat=5" 
type=application/rss+xml rel=alternate><LINK 
title="CodeProject Latest articles - VB.NET" 
href="http://www.codeproject.com/webservices/articlerss.aspx?cat=6" 
type=application/rss+xml rel=alternate><LINK title=CodeProject 
href="http://www.codeproject.com/info/OpenSearch.xml" 
type=application/opensearchdescription+xml rel=search><LINK 
href="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/CodeProject.css" 
type=text/css rel=stylesheet><LINK 
href="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/ForumClassic.css" 
type=text/css rel=stylesheet>
<SCRIPT type=text/javascript>
  var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</SCRIPT>

<SCRIPT type=text/javascript>
   var pageTracker = _gat._getTracker("UA-1735123-1");
   pageTracker._setDomainName("codeproject.com");
   pageTracker._setSessionTimeout("1200"); // 20 mins
   pageTracker._initData();
   pageTracker._trackPageview();
</SCRIPT>

<SCRIPT language=Javascript 
src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/oncopy.js" 
type=text/javascript></SCRIPT>

<SCRIPT language=Javascript 
src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/addto.js" 
type=text/javascript></SCRIPT>

<SCRIPT language=Javascript type=text/javascript><!--
function ToggleMenu(itemName)
{
	var elm = document.getElementById(itemName);
	var i,others = document.getElementById('SectionMenu');
	for(i=0; i < others.childNodes.length; i++)
	{
		var other = others.childNodes[i];
		if ((other.className == 'MenuSectionBlock') && (other != elm))
			other.style.display='none';
	}
	if (elm.style.display == 'block') elm.style.display='none';
	else elm.style.display='block';
	return false;
}

--></SCRIPT>

<SCRIPT language=Javascript type=text/javascript><!--
function MsgVoteForm(MemberID, MsgID) {
 document.write("Rate this message: ");
 document.write(unescape("%3Ca href=\"#xx" + MsgID.toString() + "xx\" onclick=\"RateMsg(" + MemberID.toString() + ", " + MsgID.toString() + ",1)\"%3E"));
 document.write(unescape("%3Cimg height=\"14\" width=\"14\" src=\"/script/Forums/Images/thumbs_down.gif\" alt=\"vote 1\" border=\"0\" align=\"absmiddle\" /%3E%3C/a%3E "));
 for (var i=1; i<=5;i++)
  document.write(unescape("%3Ca class=\"Frm_MHL\" href=\"#xx" + MsgID.toString() + "xx\" title=\"give this message a vote of " + i.toString() + "\" onclick=\"RateMsg(" + MemberID.toString() + ", " + MsgID.toString() + ", " + i.toString() + ")\"%3E%3Cb%3E" + i.toString() + "%3C/b%3E%3C/a%3E "));
 document.write(unescape("%3Ca href=\"#xx" + MsgID.toString() + "xx\" onclick=\"RateMsg(" + MemberID.toString() + ", " + MsgID.toString() + ",5)\"%3E"));
 document.write(unescape("%3Cimg height=\"14\" width=\"14\" src=\"/script/Forums/Images/thumbs_up.gif\" alt=\"vote 5\" border=\"0\" align=\"absmiddle\" /%3E%3C/a%3E "));
}

function ReportMsg(userid, msgid, score) {
 if (confirm("Are you sure you want to report this message?") == true)
  return RateMsg(userid, msgid, score);
 else return false;
}
function RateMsg(memberid, msgid, score) {
 var req = new ActiveXObject("MSXML2.XMLHTTP");
 req.onreadystatechange = function() {
  if (req.readyState == 4) {
   if ( req.status == 200 ) {
    var respText = req.responseText;
    var re = new RegExp(unescape("\%3Cdiv\%3E([^\%3C]*)\%3C/div\%3E"), "g");
    var match = re.exec(respText);
    voteStatus.innerHTML = unescape("%3Cb%3E") + (match)?match[1]:"An error occured" + unescape("%3C/b%3E");
   }
   else
   {
    voteStatus.innerHTML = unescape("%3Cb style='color:red'%3EFailed!") + req.statusText + unescape("%3C/b%3E");
   }
  }
 }
 var voteStatus = document.getElementById("MVF" + msgid);
 if (!voteStatus) return;
 voteStatus.innerHTML = unescape("%3Cb style='color:green'%3EVoting...%3C/b%3E");
 var strAction = "/script/Forums/Vote.aspx?js=1&fmid="+memberid.toString()+"&select="+msgid.toString()+"&score="+score.toString();
 req.open("GET", strAction, true);
 req.send(null);
  return false;
}
--></SCRIPT>

<SCRIPT language=Javascript type=text/javascript><!--
var Selected = "-1";

function SwitchMessage(e, msgId)
{
  if (!msgId) {
    if(!e)e=window.event;
    var target=e.target?e.target:e.srcElement;
    while(target&&target.id!='DynMessLink')target=target.parentNode;
    if(!target||target.id!='DynMessLink')return;
    msgId=target.name;
  }
  if(Selected&&Selected!=""){
    var body=eval("document.getElementById('" + Selected + "_h1')");
    if(body) body.style.display = 'none';
    var head=eval("document.getElementById('" + Selected + "_h0')");
    if(head) head.className = head.className.replace("Sel", "UnSel");
  }
  if(Selected==msgId.toString())
    Selected="";
  else {
    Selected=msgId.toString();
    var body=eval("document.getElementById('" + Selected + "_h1')");
    if(body){
      if(body.style.display=='none') body.style.display='';
      else body.style.display = 'none';
    }
    var head=eval("document.getElementById('" + Selected + "_h0')");
    if (head) 
      head.className = head.className.replace("UnSel", "Sel");
    if(body&&head&&body.style.display!='none'){
      document.body.scrollTop = getRealPos(head, "Top") - document.body.clientHeight/10;
      EnsureMessageVisible(Selected, true);
    }
  }
  if (e){if(e.preventDefault)e.preventDefault;else e.returnValue=false;}
  return false;
}

--></SCRIPT>

<SCRIPT language=Javascript 
src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/ShortCuts.js" 
type=text/javascript></SCRIPT>
<LINK href="/favicon.ico" type=image/ico rel=icon><LINK href="/favicon.ico" 
type=image/ico rel="shortcut icon">
<SCRIPT type=text/javascript>
	function SetAsAvailable() {
	   var aid = document.getElementById("ArticleId");
	   if(aid)
		   window.location.href = "/script/Articles/UpdateArticleStatus.aspx?aid=" + articleId.value + "&rp=" + location.href;
	}
	</SCRIPT>

<META content="MSHTML 6.00.2900.2838" name=GENERATOR></HEAD>
<BODY>
<TABLE id=ctl00_AT cellSpacing=0 cellPadding=0 border=0>
  <TBODY>
  <TR vAlign=top>
    <TD colSpan=2>
      <TABLE cellSpacing=0 cellPadding=0 border=0>
        <TBODY>
        <TR>
          <TD class=HeaderLogo><A href="http://www.codeproject.com/"><IMG 
            height=90 alt=Home 
            src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/codeproject225x90.gif" 
            width=225 border=0></A></TD>
          <TD class=HeaderBanner align=right width="100%">
            <SCRIPT type=text/javascript>document.write("<a href=\"http://www.codeproject.com/Redir.aspx?adid=4035&way=ban\" target=\"_blank\" rel=\"nofollow\"><img src=\"http://www.codeproject.com/script/Ann/ServeImg.aspx?File=%2fscript%2fadmentor%2fimages%2finnerworkings_728x90.gif&C=False&id=4035\" alt=\"\" border=\"0\" width=\"728\" height=\"90\"></a>");</SCRIPT>
          </TD></TR>
        <TR>
          <TD colSpan=2>
            <TABLE class=MemberNavBar cellSpacing=0 cellPadding=5 
              width="100%"><TBODY>
              <TR>
                <TD class=SmallText style="FONT-WEIGHT: bold">4,825,066 
                  members and growing! (8,106 online)</TD>
                <TD align=right>
                  <DIV class=MemberNavBarText 
                  id=ctl00_MemberMenu_LoggedOnOptions><A 
                  id=ctl00_MemberMenu_MyProfile 
                  href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=2959938">abdelrady2030</A> 
                  | <A id=ctl00_MemberMenu_MySettings 
                  href="http://www.codeproject.com/script/Membership/Modify.aspx"><IMG 
                  height=16 
                  src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/tools.gif" 
                  width=16 align=absMiddle border=0> <B>My Settings</B></A> | <A 
                  id=ctl00_MemberMenu_MyBookmarks 
                  href="http://www.codeproject.com/script/Bookmarks/List.aspx?obtid=2"><IMG 
                  height=16 
                  src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/fave.gif" 
                  width=16 align=absMiddle border=0> My Bookmarks</A> | <A 
                  id=ctl00_MemberMenu_MyArticles 
                  href="http://www.codeproject.com/script/Articles/MemberArticles.aspx?amid=2959938">My 
                  Articles</A> | <A id=ctl00_MemberMenu_Signout 
                  href="http://www.codeproject.com/script/Membership/LogOff.aspx?rp=%2fKB%2fsystem%2fkernelspying.aspx">Sign 
                  out</A> </DIV></TD></TR></TBODY></TABLE></TD></TR>
        <TR>
          <TD colSpan=2>
            <TABLE class=SiteNavBar id=tblSiteToolbar cellSpacing=0 
            cellPadding=0>
              <TBODY>
              <TR>
                <TD><A href="http://www.codeproject.com/">Home</A></TD>
                <TD class=SelCat noWrap><A 
                  href="http://www.codeproject.com/?cat=1">All Topics</A></TD>
                <TD noWrap><A 
                  href="http://www.codeproject.com/?cat=2">MFC/C++</A></TD>
                <TD noWrap><A 
                href="http://www.codeproject.com/?cat=3">C#</A></TD>
                <TD noWrap><A 
                  href="http://www.codeproject.com/?cat=6">VB.NET</A></TD>
                <TD noWrap><A 
                  href="http://www.codeproject.com/?cat=4">ASP.NET</A></TD>
                <TD noWrap><A 
                href="http://www.codeproject.com/?cat=9">SQL</A></TD>
                <TD noWrap><A 
                  href="http://www.codeproject.com/?cat=8">Architect</A></TD>
                <TD width="100%">&nbsp;</TD>
                <TD id=ctl00_TopNavBar_RightMenus><!--380-->
                  <DIV id=MenuPos 
                  style="WIDTH: 305px; POSITION: relative; TOP: 1px; HEIGHT: 22px">
                  <TABLE 
                  style="BORDER-TOP-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; HEIGHT: 20px; BORDER-RIGHT-WIDTH: 0px" 
                  cellSpacing=0 cellPadding=0 width=305>
                    <TBODY>
                    <TR vAlign=center>
                      <TD 
                      style="BORDER-TOP-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px" 
                      noWrap><A 
                        href="http://www.codeproject.com/info/FAQ.aspx">Help!</A></TD>
                      <TD 
                      style="BORDER-TOP-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px" 
                      noWrap><A 
                        href="http://www.codeproject.com/script/Articles/Latest.aspx">Articles</A></TD>
                      <TD 
                      style="BORDER-TOP-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px" 
                      noWrap><A 
                        href="http://www.codeproject.com/script/Forums/List.aspx">Message 
                        Boards</A></TD>
                      <TD 
                      style="BORDER-TOP-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px" 
                      noWrap><A 
                        href="http://www.codeproject.com/Lounge.aspx">Lounge</A></TD></TR></TBODY></TABLE></DIV></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
  <TR>
    <TD vAlign=top colSpan=2><A name=_top></A>
      <TABLE class=ArticleHeader id=ctl00_ArticleTopHeader_HeaderTable 
      cellSpacing=0 cellPadding=3 width="100%" border=0>
        <TBODY>
        <TR vAlign=top>
          <TD class=SmallText><A id=ctl00_ArticleTopHeader_ChapterLink 
            href="http://www.codeproject.com/script/Content/Chapter.aspx?chapterId=1">Desktop 
            Development</A> » <A id=ctl00_ArticleTopHeader_SectionLink 
            href="http://www.codeproject.com/KB/system/">Hardware &amp; 
            System</A> » <A id=ctl00_ArticleTopHeader_SubsectionLink 
            href="http://www.codeproject.com/KB/system/index.aspx?#Hardware &amp; System - General">General</A> 
            <SPAN class=ArticleIntermediate 
            id=ctl00_ArticleTopHeader_SkillLevel>&nbsp;&nbsp;&nbsp; 
            Intermediate</SPAN> <SPAN 
            id=ctl00_ArticleTopHeader_LicenceTerms></SPAN><BR><BR>
            <H1><SPAN class=ArticleTopTitle 
            id=ctl00_ArticleTopHeader_ArticleTitle>Kernel-mode API spying - an 
            ultimate hack</SPAN></H1><B>By <A 
            href="http://www.codeproject.com/script/Articles/MemberArticles.aspx?amid=846502">Anton 
            Bassov</A></B><BR><BR><SPAN class=ArticleTopDescr 
            id=ctl00_ArticleTopHeader_ArticleDescr>An article on kernel-mode API 
            spying.</SPAN> </TD>
          <TD class=SmallText style="WIDTH: 210px"><SPAN 
            id=ctl00_ArticleTopHeader_ArticleAttributes>C++, VC6, VC7, VC7.1, 
            Windows, Visual Studio, Dev</SPAN><BR><BR><SPAN 
            style="PADDING-RIGHT: 2ex">Posted</SPAN>: <B>21 Apr 
            2004</B><BR><SPAN style="PADDING-RIGHT: 0.5ex">Updated</SPAN>: <B>21 
            Apr 2004</B> <BR><SPAN style="PADDING-RIGHT: 3.2ex">Views</SPAN>: 
            <B>93,193</B><BR></TD></TR>
        <TR>
          <TD colSpan=2>
            <TABLE width="100%">
              <TBODY>
              <TR>
                <TD></TD>
                <TD class=SmallText style="WHITE-SPACE: nowrap" 
              align=right></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
  <TR vAlign=top>
    <TD class=LHNavBar id=ctl00_LeftNavCell>
      <DIV style="PADDING-TOP: 5px; TEXT-ALIGN: center"><IFRAME 
      src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/ServeHTML.htm" 
      frameBorder=0 width=150 scrolling=no height=80></IFRAME></DIV>
      <DIV class=FeatureBlockHeader>Announcements</DIV>
      <DIV class="FeatureBlockContent RHFeatureBar">
      <DIV style="PADDING-TOP: 0px"><IMG 
      style="PADDING-RIGHT: 10px; FLOAT: left; MARGIN-LEFT: 5px; MARGIN-RIGHT: 10px" 
      height=20 alt=Comp 
      src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/prize_winner.gif" 
      width=10> <A id=ctl00_Announcements_CompLink 
      href="http://www.codeproject.com/Feature/ArticleCompetition/">Monthly 
      Competition</A><BR clear=all>
      <DIV style="PADDING-BOTTOM: 5px; PADDING-TOP: 5px"><IMG 
      style="PADDING-RIGHT: 10px; FLOAT: left; MARGIN-LEFT: 5px; MARGIN-RIGHT: 10px" 
      height=16 alt=Staff 
      src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/staff_sm.gif" 
      width=12> <A href="http://www.codeproject.com/info/jobs/">We're 
      Hiring!</A></DIV></DIV></DIV>
      <DIV id=SectionMenu>
      <DIV class=MenuCat>Chapters</DIV>
      <DIV class=MenuChapter><A onclick="return ToggleMenu('Chapter1');" 
      href="http://www.codeproject.com/script/Content/Chapter.aspx?chapterId=1">Desktop 
      Development</A></DIV>
      <DIV class=MenuSectionBlock id=Chapter1>
      <DIV class=MI id=Section1><A 
      href="http://www.codeproject.com/KB/buttons/">Button Controls</A></DIV>
      <DIV class=MI id=Section15><A 
      href="http://www.codeproject.com/KB/clipboard/">Clipboard</A></DIV>
      <DIV class=MI id=Section2><A 
      href="http://www.codeproject.com/KB/combobox/">Combo &amp; List 
      Boxes</A></DIV>
      <DIV class=MI id=Section67><A 
      href="http://www.codeproject.com/KB/dialog/">Dialogs and Windows</A></DIV>
      <DIV class=MI id=Section107><A 
      href="http://www.codeproject.com/KB/gadgets/">Desktop Gadgets</A></DIV>
      <DIV class=MI id=Section16><A 
      href="http://www.codeproject.com/KB/docview/">Document / View</A></DIV>
      <DIV class=MI id=Section4><A 
      href="http://www.codeproject.com/KB/edit/">Edit Controls</A></DIV>
      <DIV class=MI id=Section17><A 
      href="http://www.codeproject.com/KB/files/">Files and Folders</A></DIV>
      <DIV class=MI id=Section3><A 
      href="http://www.codeproject.com/KB/grid/">Grid &amp; Data 
      Controls</A></DIV>
      <DIV class=MIS id=Section48><A 
      href="http://www.codeproject.com/KB/system/">Hardware &amp; 
      System</A></DIV>
      <DIV class=MI id=Section5><A 
      href="http://www.codeproject.com/KB/list/">List Controls</A></DIV>
      <DIV class=MI id=Section6><A 
      href="http://www.codeproject.com/KB/menus/">Menus</A></DIV>
      <DIV class=MI id=Section14><A 
      href="http://www.codeproject.com/KB/miscctrl/">Miscellaneous</A></DIV>
      <DIV class=MI id=Section18><A 
      href="http://www.codeproject.com/KB/printing/">Printing</A></DIV>
      <DIV class=MI id=Section95><A 
      href="http://www.codeproject.com/KB/progress/">Progress Controls</A></DIV>
      <DIV class=MI id=Section11><A 
      href="http://www.codeproject.com/KB/selection/">Selection 
      Controls</A></DIV>
      <DIV class=MI id=Section19><A 
      href="http://www.codeproject.com/KB/shell/">Shell and IE 
      programming</A></DIV>
      <DIV class=MI id=Section68><A 
      href="http://www.codeproject.com/KB/smart/">Smart Client</A></DIV>
      <DIV class=MI id=Section8><A 
      href="http://www.codeproject.com/KB/splitter/">Splitter Windows</A></DIV>
      <DIV class=MI id=Section9><A 
      href="http://www.codeproject.com/KB/static/">Static &amp; Panel 
      Controls</A></DIV>
      <DIV class=MI id=Section10><A 
      href="http://www.codeproject.com/KB/statusbar/">Status Bar</A></DIV>
      <DIV class=MI id=Section7><A 
      href="http://www.codeproject.com/KB/tabs/">Tabs &amp; Property 
      Pages</A></DIV>
      <DIV class=MI id=Section12><A 
      href="http://www.codeproject.com/KB/toolbars/">Toolbars &amp; Docking 
      windows</A></DIV>
      <DIV class=MI id=Section13><A 
      href="http://www.codeproject.com/KB/tree/">Tree Controls</A></DIV></DIV>
      <DIV class=MenuChapter><A onclick="return ToggleMenu('Chapter2');" 
      href="http://www.codeproject.com/script/Content/Chapter.aspx?chapterId=2">Web 
      Development</A></DIV>
      <DIV class=MenuSectionBlock id=Chapter2 style="DISPLAY: none">
      <DIV class=MI id=Section70><A 
      href="http://www.codeproject.com/KB/ajax/">AJAX and Atlas</A></DIV>
      <DIV class=MI id=Section27><A 
      href="http://www.codeproject.com/KB/applications/">Applications &amp; 
      Tools</A></DIV>
      <DIV class=MI id=Section85><A 
      href="http://www.codeproject.com/KB/asp/">ASP</A></DIV>
      <DIV class=MI id=Section89><A 
      href="http://www.codeproject.com/KB/aspnet/">ASP.NET</A></DIV>
      <DIV class=MI id=Section28><A 
      href="http://www.codeproject.com/KB/webforms/">ASP.NET Controls</A></DIV>
      <DIV class=MI id=Section38><A 
      href="http://www.codeproject.com/KB/ATL-Server/">ATL Server</A></DIV>
      <DIV class=MI id=Section29><A 
      href="http://www.codeproject.com/KB/web-cache/">Caching</A></DIV>
      <DIV class=MI id=Section91><A 
      href="http://www.codeproject.com/KB/web-image/">Charts, Graphs and 
      Images</A></DIV>
      <DIV class=MI id=Section25><A 
      href="http://www.codeproject.com/KB/scripting/">Client side 
      scripting</A></DIV>
      <DIV class=MI id=Section30><A 
      href="http://www.codeproject.com/KB/custom-controls/">Custom 
      Controls</A></DIV>
      <DIV class=MI id=Section23><A 
      href="http://www.codeproject.com/KB/HTML/">HTML / CSS</A></DIV>
      <DIV class=MI id=Section22><A 
      href="http://www.codeproject.com/KB/IP/">Internet / Network</A></DIV>
      <DIV class=MI id=Section24><A 
      href="http://www.codeproject.com/KB/ISAPI/">ISAPI</A></DIV>
      <DIV class=MI id=Section33><A 
      href="http://www.codeproject.com/KB/server-management/">Server 
      Management</A></DIV>
      <DIV class=MI id=Section34><A 
      href="http://www.codeproject.com/KB/session/">Session State</A></DIV>
      <DIV class=MI id=Section113><A 
      href="http://www.codeproject.com/KB/silverlight/">Silverlight</A></DIV>
      <DIV class=MI id=Section36><A 
      href="http://www.codeproject.com/KB/trace/">Trace and Logs</A></DIV>
      <DIV class=MI id=Section31><A 
      href="http://www.codeproject.com/KB/user-controls/">User 
Controls</A></DIV>
      <DIV class=MI id=Section37><A 
      href="http://www.codeproject.com/KB/validation/">Validation</A></DIV>
      <DIV class=MI id=Section35><A 
      href="http://www.codeproject.com/KB/viewstate/">View State</A></DIV>
      <DIV class=MI id=Section26><A 
      href="http://www.codeproject.com/KB/WAP/">WAP / WML</A></DIV>
      <DIV class=MI id=Section32><A 
      href="http://www.codeproject.com/KB/web-security/">Web Security</A></DIV>
      <DIV class=MI id=Section20><A 
      href="http://www.codeproject.com/KB/webservices/">Web 
      Services</A></DIV></DIV>
      <DIV class=MenuChapter><A onclick="return ToggleMenu('Chapter9');" 
      href="http://www.codeproject.com/script/Content/Chapter.aspx?chapterId=9">Enterprise 
      Systems</A></DIV>
      <DIV class=MenuSectionBlock id=Chapter9 style="DISPLAY: none">
      <DIV class=MI id=Section98><A 
      href="http://www.codeproject.com/KB/MCMS/">Content Management 
      Server</A></DIV>
      <DIV class=MI id=Section99><A 
      href="http://www.codeproject.com/KB/biztalk/">Microsoft BizTalk 
      Server</A></DIV>
      <DIV class=MI id=Section102><A 
      href="http://www.codeproject.com/KB/exchange/">Microsoft 
Exchange</A></DIV>
      <DIV class=MI id=Section90><A 
      href="http://www.codeproject.com/KB/office/">Office Development</A></DIV>
      <DIV class=MI id=Section101><A 
      href="http://www.codeproject.com/KB/sharepoint/">SharePoint 
      Server</A></DIV></DIV>
      <DIV class=MenuChapter><A onclick="return ToggleMenu('Chapter3');" 
      href="http://www.codeproject.com/script/Content/Chapter.aspx?chapterId=3">Multimedia</A></DIV>
      <DIV class=MenuSectionBlock id=Chapter3 style="DISPLAY: none">
      <DIV class=MI id=Section42><A 
      href="http://www.codeproject.com/KB/audio-video/">Audio and 
Video</A></DIV>
      <DIV class=MI id=Section44><A 
      href="http://www.codeproject.com/KB/directx/">DirectX</A></DIV>
      <DIV class=MI id=Section46><A 
      href="http://www.codeproject.com/KB/GDI/">GDI</A></DIV>
      <DIV class=MI id=Section47><A 
      href="http://www.codeproject.com/KB/GDI-plus/">GDI+</A></DIV>
      <DIV class=MI id=Section43><A 
      href="http://www.codeproject.com/KB/graphics/">General Graphics</A></DIV>
      <DIV class=MI id=Section45><A 
      href="http://www.codeproject.com/KB/openGL/">OpenGL</A></DIV></DIV>
      <DIV class=MenuChapter><A onclick="return ToggleMenu('Chapter4');" 
      href="http://www.codeproject.com/script/Content/Chapter.aspx?chapterId=4">Database</A></DIV>
      <DIV class=MenuSectionBlock id=Chapter4 style="DISPLAY: none">
      <DIV class=MI id=Section66><A 
      href="http://www.codeproject.com/KB/database/">Database</A></DIV>
      <DIV class=MI id=Section100><A 
      href="http://www.codeproject.com/KB/reporting-services/">SQL Reporting 
      Services</A></DIV></DIV>
      <DIV class=MenuChapter><A onclick="return ToggleMenu('Chapter8');" 
      href="http://www.codeproject.com/script/Content/Chapter.aspx?chapterId=8">Platforms, 
      Frameworks &amp; Libraries</A></DIV>
      <DIV class=MenuSectionBlock id=Chapter8 style="DISPLAY: none">
      <DIV class=MI id=Section83><A 
      href="http://www.codeproject.com/KB/atl/">ATL</A></DIV>
      <DIV class=MI id=Section117><A 
      href="http://www.codeproject.com/KB/MFC/">MFC</A></DIV>
      <DIV class=MI id=Section88><A 
      href="http://www.codeproject.com/KB/stl/">STL</A></DIV>
      <DIV class=MI id=Section84><A 
      href="http://www.codeproject.com/KB/wtl/">WTL</A></DIV>
      <DIV class=MI id=Section49><A 
      href="http://www.codeproject.com/KB/COM/">COM / COM+</A></DIV>
      <DIV class=MI id=Section76><A 
      href="http://www.codeproject.com/KB/dotnet/">.NET Framework</A></DIV>
      <DIV class=MI id=Section92><A 
      href="http://www.codeproject.com/KB/winsdk/">Win32/64 SDK &amp; 
      OS</A></DIV>
      <DIV class=MI id=Section108><A 
      href="http://www.codeproject.com/KB/vista/">Vista API</A></DIV>
      <DIV class=MI id=Section110><A 
      href="http://www.codeproject.com/KB/vista-security/">Vista 
      Security</A></DIV>
      <DIV class=MI id=Section82><A 
      href="http://www.codeproject.com/KB/cross-platform/">Cross 
      Platform</A></DIV>
      <DIV class=MI id=Section69><A 
      href="http://www.codeproject.com/KB/game/">Game Development</A></DIV>
      <DIV class=MI id=Section73><A 
      href="http://www.codeproject.com/KB/mobile/">Mobile Development</A></DIV>
      <DIV class=MI id=Section106><A 
      href="http://www.codeproject.com/KB/WC/">Windows CardSpace</A></DIV>
      <DIV class=MI id=Section103><A 
      href="http://www.codeproject.com/KB/WCF/">Windows Communication 
      Foundation</A></DIV>
      <DIV class=MI id=Section104><A 
      href="http://www.codeproject.com/KB/WPF/">Windows Presentation 
      Foundation</A></DIV>
      <DIV class=MI id=Section105><A 
      href="http://www.codeproject.com/KB/WF/">Windows Workflow 
      Foundation</A></DIV>
      <DIV class=MI id=Section119><A 
      href="http://www.codeproject.com/KB/library/">Libraries</A></DIV>
      <DIV class=MI id=Section122><A 
      href="http://www.codeproject.com/KB/powershell/">Windows 
      Powershell</A></DIV>
      <DIV class=MI id=Section123><A 
      href="http://www.codeproject.com/KB/linq/">LINQ</A></DIV></DIV>
      <DIV class=MenuChapter><A onclick="return ToggleMenu('Chapter5');" 
      href="http://www.codeproject.com/script/Content/Chapter.aspx?chapterId=5">Languages</A></DIV>
      <DIV class=MenuSectionBlock id=Chapter5 style="DISPLAY: none">
      <DIV class=MI id=Section71><A href="http://www.codeproject.com/KB/cpp/">C 
      / C++ Language</A></DIV>
      <DIV class=MI id=Section72><A 
      href="http://www.codeproject.com/KB/mcpp/">C++ / CLI</A></DIV>
      <DIV class=MI id=Section93><A 
      href="http://www.codeproject.com/KB/cs/">C#</A></DIV>
      <DIV class=MI id=Section78><A 
      href="http://www.codeproject.com/KB/msil/">MSIL</A></DIV>
      <DIV class=MI id=Section86><A 
      href="http://www.codeproject.com/KB/vbscript/">VBScript</A></DIV>
      <DIV class=MI id=Section87><A 
      href="http://www.codeproject.com/KB/vb/">VB.NET</A></DIV>
      <DIV class=MI id=Section115><A 
      href="http://www.codeproject.com/KB/vb-interop/">VB6 Interop</A></DIV>
      <DIV class=MI id=Section77><A 
      href="http://www.codeproject.com/KB/net-languages/">Other .NET 
      Languages</A></DIV>
      <DIV class=MI id=Section21><A 
      href="http://www.codeproject.com/KB/XML/">XML</A></DIV></DIV>
      <DIV class=MenuChapter><A onclick="return ToggleMenu('Chapter6');" 
      href="http://www.codeproject.com/script/Content/Chapter.aspx?chapterId=6">General 
      Programming</A></DIV>
      <DIV class=MenuSectionBlock id=Chapter6 style="DISPLAY: none">
      <DIV class=MI id=Section57><A 
      href="http://www.codeproject.com/KB/recipes/">Algorithms &amp; 
      Recipes</A></DIV>
      <DIV class=MI id=Section64><A 
      href="http://www.codeproject.com/KB/bugs/">Bugs &amp; 
Workarounds</A></DIV>
      <DIV class=MI id=Section79><A 
      href="http://www.codeproject.com/KB/collections/">Collections</A></DIV>
      <DIV class=MI id=Section56><A 
      href="http://www.codeproject.com/KB/security/">Cryptography &amp; 
      Security</A></DIV>
      <DIV class=MI id=Section50><A 
      href="http://www.codeproject.com/KB/datetime/">Date and Time</A></DIV>
      <DIV class=MI id=Section52><A 
      href="http://www.codeproject.com/KB/DLL/">DLLs &amp; Assemblies</A></DIV>
      <DIV class=MI id=Section80><A 
      href="http://www.codeproject.com/KB/exception/">Exception 
      Handling</A></DIV>
      <DIV class=MI id=Section81><A 
      href="http://www.codeproject.com/KB/locale/">Localisation</A></DIV>
      <DIV class=MI id=Section53><A 
      href="http://www.codeproject.com/KB/macros/">Macros and Add-ins</A></DIV>
      <DIV class=MI id=Section54><A 
      href="http://www.codeproject.com/KB/tips/">Programming Tips</A></DIV>
      <DIV class=MI id=Section55><A 
      href="http://www.codeproject.com/KB/string/">String handling</A></DIV>
      <DIV class=MI id=Section58><A 
      href="http://www.codeproject.com/KB/threads/">Threads, Processes &amp; 
      IPC</A></DIV>
      <DIV class=MI id=Section59><A 
      href="http://www.codeproject.com/KB/winhelp/">WinHelp / 
      HTMLHelp</A></DIV></DIV>
      <DIV class=MenuChapter><A onclick="return ToggleMenu('Chapter10');" 
      href="http://www.codeproject.com/script/Content/Chapter.aspx?chapterId=10">Graphics 
      / Design</A></DIV>
      <DIV class=MenuSectionBlock id=Chapter10 style="DISPLAY: none">
      <DIV class=MI id=Section40><A 
      href="http://www.codeproject.com/KB/expression/">Expression</A></DIV>
      <DIV class=MI id=Section114><A 
      href="http://www.codeproject.com/KB/usability/">Usability</A></DIV></DIV>
      <DIV class=MenuChapter><A onclick="return ToggleMenu('Chapter11');" 
      href="http://www.codeproject.com/script/Content/Chapter.aspx?chapterId=11">Development 
      Lifecycle</A></DIV>
      <DIV class=MenuSectionBlock id=Chapter11 style="DISPLAY: none">
      <DIV class=MI id=Section51><A 
      href="http://www.codeproject.com/KB/debug/">Debug Tips</A></DIV>
      <DIV class=MI id=Section39><A 
      href="http://www.codeproject.com/KB/architecture/">Design and 
      Architecture</A></DIV>
      <DIV class=MI id=Section112><A 
      href="http://www.codeproject.com/KB/install/">Installation</A></DIV>
      <DIV class=MI id=Section41><A 
      href="http://www.codeproject.com/KB/work/">Work Issues</A></DIV></DIV>
      <DIV class=MenuChapter><A onclick="return ToggleMenu('Chapter7');" 
      href="http://www.codeproject.com/script/Content/Chapter.aspx?chapterId=7">General 
      Reading</A></DIV>
      <DIV class=MenuSectionBlock id=Chapter7 style="DISPLAY: none">
      <DIV class=MI id=Section60><A 
      href="http://www.codeproject.com/KB/books/">Book Chapters</A></DIV>
      <DIV class=MI id=Section61><A 
      href="http://www.codeproject.com/KB/book-reviews/">Book Reviews</A></DIV>
      <DIV class=MI id=Section109><A 
      href="http://www.codeproject.com/KB/hardware-review/">Hardware 
      Reviews</A></DIV>
      <DIV class=MI id=Section63><A 
      href="http://www.codeproject.com/KB/interviews/">Interviews</A></DIV>
      <DIV class=MI id=Section65><A 
      href="http://www.codeproject.com/KB/showcase/">Product Showcase</A></DIV>
      <DIV class=MI id=Section62><A 
      href="http://www.codeproject.com/KB/scrapbook/">Scrapbook</A></DIV></DIV></DIV><BR>
      <DIV class=MenuCat>Feature Zones</DIV>
      <DIV class=MenuChapter><A 
      href="http://www.codeproject.com/kb/showcase/">Product Showcase</A></DIV>
      <DIV class=MenuChapter><A 
      href="http://www.codeproject.com/Zones/Install">Installshield 
      2008</A></DIV>
      <DIV class=MenuChapter><A href="http://www.codeproject.com/Zones/IBM">IBM 
      DeveloperWorks</A></DIV><BR>
      <SCRIPT type=text/javascript>document.write("<a href=\"http://www.codeproject.com/Redir.aspx?adid=5044&way=ban\" target=\"_blank\" rel=\"nofollow\"><img src=\"http://www.codeproject.com/script/Ann/ServeImg.aspx?File=%2fscript%2fadmentor%2fimages%2fWhole_Tomato_VisastX_160x600_v1.gif&C=False&id=5044\" alt=\"The intellisense upgrade for Visual Studio .NET - make your IDE as smart as you.\" border=\"0\" width=\"160\" height=\"600\"></a>");</SCRIPT>
      <IMG height=1 alt="" 
      src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/t.gif" 
      width=160> </TD>
    <TD class=ArticlePane vAlign=top>
      <TABLE class=SearchHeaderBar cellSpacing=0 width="100%">
        <TBODY>
        <TR>
          <TD style="WIDTH: 60%; WHITE-SPACE: nowrap" vAlign=center 
            align=right><FORM style="MARGIN: 0px" name=Search 
            action=/info/search.aspx method=get><B>Search &nbsp;</B> <INPUT 
            class=SmallText style="WIDTH: 200px" name=artkw> <SELECT 
            class=SmallText style="FONT-WEIGHT: bold" name=sbo> <OPTION 
              value=kw selected>Articles</OPTION> <OPTION 
              value=fm>Messages</OPTION></SELECT> <INPUT class=SmallText style="FONT-WEIGHT: bold" type=submit value=" Go! "> 
            &nbsp; </FORM></TD>
          <TD class=TinyText style="WHITE-SPACE: nowrap"><A 
            href="http://www.codeproject.com/info/search.aspx">Advanced 
            Search</A><BR><A 
            href="http://www.codeproject.com/script/Content/SiteMap.aspx">Sitemap</A> 
            | <A id=ctl00_SearchBarCtrl_AddToIESearchLnk 
            title="Add The Code Project to your IE search Providers" 
            onclick="window.external.AddSearchProvider('http://www.codeproject.com/info/OpenSearch.xml');return false;" 
            href="http://www.codeproject.com/">Add to IE Search</A> 
        </TD></TR></TBODY></TABLE><SPAN id=ctl00_ResultMessage></SPAN>
      <DIV id=ctl00_ArtDiv>
      <TABLE cellSpacing=0 cellPadding=0 width="100%" border=0>
        <TBODY>
        <TR vAlign=top>
          <TD vAlign=top>
            <TABLE>
              <TBODY></TBODY></TABLE>
            <TABLE cellSpacing=1 cellPadding=3 width=1 border=0>
              <TBODY>
              <TR class=smalltext vAlign=center>
                <TD style="WHITE-SPACE: nowrap"><IMG 
                  style="BORDER-RIGHT: 0px; BORDER-TOP: 0px; VERTICAL-ALIGN: middle; BORDER-LEFT: 0px; BORDER-BOTTOM: 0px" 
                  height=16 alt=print 
                  src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/print.gif" 
                  width=16> <A id=ctl00_ArticleHeaderLinks_PrintLnk 
                  href="http://www.codeproject.com/KB/system/kernelspying.aspx?display=Print">Print</A> 
                </TD>
                <TD style="WHITE-SPACE: nowrap"><IMG 
                  style="BORDER-RIGHT: 0px; BORDER-TOP: 0px; VERTICAL-ALIGN: middle; BORDER-LEFT: 0px; BORDER-BOTTOM: 0px" 
                  height=16 alt="Broken Article?" 
                  src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/broken.gif" 
                  width=16> <A id=ctl00_ArticleHeaderLinks_BrokenLnk 
                  href="http://www.codeproject.com/script/Articles/Report.aspx?aid=6805">Broken 
                  Article?</A> </TD>
                <TD style="WHITE-SPACE: nowrap"><IMG 
                  id=ctl00_ArticleHeaderLinks_ArticleBmk_BookmarkImg 
                  style="BORDER-RIGHT: 0px; BORDER-TOP: 0px; VERTICAL-ALIGN: middle; BORDER-LEFT: 0px; WIDTH: 16px; BORDER-BOTTOM: 0px; HEIGHT: 16px" 
                  src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/link.png"> 
                  <A id=ctl00_ArticleHeaderLinks_ArticleBmk_BookmarkLnk 
                  href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=6805&amp;obtid=2">Add 
                  Bookmark</A> <SPAN 
                  id=ctl00_ArticleHeaderLinks_ArticleBmk_Message></SPAN></TD>
                <TD style="WHITE-SPACE: nowrap"><IMG 
                  style="BORDER-RIGHT: 0px; BORDER-TOP: 0px; VERTICAL-ALIGN: middle; BORDER-LEFT: 0px; BORDER-BOTTOM: 0px" 
                  height=16 alt=Discuss 
                  src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/discuss.gif" 
                  width=15> <A 
                  href="http://www.codeproject.com/KB/system/kernelspying.aspx#_comments">Discuss</A> 
                </TD>
                <TD style="WHITE-SPACE: nowrap"><IMG 
                  style="BORDER-RIGHT: 0px; BORDER-TOP: 0px; VERTICAL-ALIGN: middle; BORDER-LEFT: 0px; BORDER-BOTTOM: 0px" 
                  height=16 alt="Recommend Article" 
                  src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/mail.gif" 
                  width=16> <A id=ctl00_ArticleHeaderLinks_Recommend 
                  href="http://www.codeproject.com/script/common/TellFriend.aspx?obtid=2&amp;obid=6805">Send 
                  to a friend</A> </TD></TR></TBODY></TABLE></TD>
          <TD align=right>
            <TABLE>
              <TBODY>
              <TR>
                <TD class=SmallText style="WHITE-SPACE: nowrap" 
                  align=right><SPAN id=ctl00_ArticleRating_VoteLabel>38 votes 
                  for this Article.</SPAN> </TD>
                <TD>
                  <TABLE cellSpacing=0 cellPadding=0 border=1>
                    <TBODY>
                    <TR>
                      <TD width=20 bgColor=white height=5><IMG height=5 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/red.gif" 
                        width=20 border=0></TD>
                      <TD width=20 bgColor=white height=5><IMG height=5 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/red.gif" 
                        width=20 border=0></TD>
                      <TD width=20 bgColor=white height=5><IMG height=5 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/red.gif" 
                        width=20 border=0></TD>
                      <TD width=20 bgColor=white height=5><IMG height=5 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/red.gif" 
                        width=20 border=0></TD>
                      <TD noWrap width=20 bgColor=white height=5><IMG height=5 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/red.gif" 
                        width=14 border=0></TD></TR></TBODY></TABLE></TD></TR>
              <TR id=ctl00_ArticleRating_PopularityRow>
                <TD class=SmallText align=right colSpan=2><A 
                  id=ctl00_ArticleRating_PopularityLnk 
                  title="Calculated as rating x Log10(# votes)" 
                  href="http://www.codeproject.com/script/Articles/TopArticles.aspx?ta_so=1">Popularity: 
                  7.39</A><SPAN id=ctl00_ArticleRating_PopularityLbl></SPAN> 
                  Rating: <B>4.68</B> out of 5 
      </TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE>
      <UL class=Callout id=ctl00_confirmError style="MARGIN-RIGHT: 20px">
        <LI class=SmallText 
        style="LIST-STYLE-IMAGE: url(/images/warning.gif)">You are signed up for 
        one or more <A id=ctl00_SubscribeLink2 
        href="http://www.codeproject.com/script/Membership/Subscribe.aspx?rp=%2fKB%2fsystem%2fkernelspying.aspx">newsletters</A> 
        but your email address is either unconfirmed, or has not been 
        reconfirmed in a long time. Please click <A id=ctl00_RequestConfirmLink2 
        href="http://www.codeproject.com/script/Membership/SendConfirmRequest.aspx?rp=%2fKB%2fsystem%2fkernelspying.aspx">here</A> 
        to have an email sent that will allow us to confirm your email address 
        and start sending you newsletters again.</LI></UL><SPAN id=intelliTXT>
      <DIV id=contentdiv><!-- Main Page Contents Start --><!-- Article Starts -->
      <UL class=download>
        <LI><A 
        href="http://www.codeproject.com/KB/system/kernelspying/kernelspyfiles.zip">Download 
        source code - 23.8 Kb</A> </LI></UL>
      <H2>Abstract</H2>
      <P>After having published my article about process-wide API spying, I 
      received plenty of encouraging messages - readers have generally accepted 
      my model of hooking function calls. In this article, we will extend our 
      model to kernel- mode spying, and hook the API calls that are made by our 
      target device driver. We will also introduce a brand-new way of 
      communication between the kernel-mode driver and the user-mode application 
      - instead of using system services, we will implement our own mini-version 
      of Asynchronous Procedure Calls. This task is not as complicated as it may 
      seem - in fact, it is just shockingly easy. Windows flat memory model 
      offers us plenty of exciting opportunities - the only thing we need is a 
      sense of adventure (plus a good knowledge of assembly language, of 
      course). All tips and tricks, described in this article, are 100% of my 
      own design - you would not find anything more or less similar to these 
      tricks anywhere.</P>
      <P>I took into account the messages, saying that I should have provided 
      the readers with the source code. Therefore, the source code for this 
      article is available for download (please read the installation 
      instructions in the end of the article).</P>
      <P><B>Important</B>: This article is based upon the bold assumption that 
      you have read <A 
      href="http://codeproject.com/system/api_spying_hack.asp">my previous 
      article about process-wide API spying</A>. If you haven't read it yet, go 
      and do it now. This is an absolute must - otherwise, you will be unable to 
      understand absolutely anything here, and the whole article will seem 
      totally incoherent to you.</P>
      <H2>Introduction</H2>
      <P>First of all, let's look at complications, arising from the fact that 
      our spying activity is going to take place in the kernel mode. To begin 
      with, Windows is a protected system, which means user-mode applications 
      have no access to the kernel address space. Therefore, a spying DLL, 
      described in the previous article, cannot work in kernel mode - in order 
      to start spying in kernel mode, we have to write not a DLL but a 
      kernel-mode spying driver.</P>
      <P>Our spying driver has to communicate with the user-mode controller 
      application, and do it asynchronously. Any virtual address in the lower 2G 
      of the process address space is meaningless for the kernel code - even in 
      the same process. This means kernel-mode code cannot call user-mode 
      functions, so that our driver cannot send a window message to its 
      controller application the way user-mode spying DLL does, because 
      <CODE>SendMessage()</CODE> API function resides in user-mode address 
      space. In fact, even if our driver could call <CODE>SendMessage()</CODE>, 
      doing so would be an extremely unwise move on its behalf - 
      <CODE>SendMessage()</CODE> does not return until the message gets 
      processed, and kernel-mode code cannot afford to wait patiently for the 
      user-mode one to accomplish its task, unless we are desperate to bring the 
      system down. Therefore, we must find some way of asynchronous 
      communication between the spying driver and its controller 
application.</P>
      <P>Furthermore, if we spy on user-mode modules, we can save the original 
      return address, as well as other relevant information, in the thread local 
      storage. However, our kernel-mode driver cannot call user-mode 
      <CODE>TlsGetValue()</CODE> or <CODE>TlsSetValue()</CODE>. TLS-related 
      system functions that can be called by kernel-mode code don't seem to 
      exist. If you disassemble <CODE>TlsAlloc()</CODE>, 
      <CODE>TlsGetValue()</CODE> or <CODE>TlsSetValue()</CODE>, you will see 
      that neither of these functions invokes INT 2Eh, i.e. managing TLS does 
      not involve system services. Once every user-mode thread in the system 
      receives its own copy of CPU stack and registers, the FS register is 
      mapped to the beginning of the section where thread-specific data is 
      stored. This is how <I>kernel32.dll</I> implements thread local storage - 
      everything is implemented purely by user-mode code, which cannot be called 
      by our spying driver. Therefore, we have to find some other thread-safe 
      way of saving the original return address, as well as all other relevant 
      information.</P>
      <P>In addition to the above, we should not forget that our spying code may 
      run at any IRQL. Some system services may be called at any IRQL, and some 
      are IRQL-dependent. Therefore, we have to take the current IRQL into 
      account when we call certain system services. Furthermore, we must make 
      sure that, if our spying code currently runs at high IRQL, it does not go 
      anywhere close to the paged pool. If our spying code tries to access the 
      paged memory while running at high IRQL, or calls any function that tries 
      to do it, the “blue screen of death”, due to the page fault, is 
      inevitable.</P>
      <P>We should also keep in mind that kernel-mode code is interruptible. If 
      an interrupt occurs while our spying code runs, the system will transfer 
      control to the interrupt handler, which may call some API function that we 
      have hooked. In other words, the system may interrupt the execution of our 
      spying code only in order to execute exactly the same spying code. As a 
      result, when our interrupted code continues its execution, it may find 
      global variables and resources in the state, very different from the one 
      they used to be in before the interrupt had occurred. We should always 
      remember this, and disable interrupts whenever we expect global variables 
      and resources to be immutable while our code runs - otherwise, we can get 
      an unpleasant surprise (i.e., the "blue screen", which is the system's 
      standard reaction to any mistake we make in kernel-mode code).</P>
      <P>As you can see, in order to work in kernel mode, <CODE>Prolog()</CODE> 
      and <CODE>Epilog()</CODE> need quite a few adjustments. Although 
      <CODE>ProxyProlog()</CODE> and <CODE>ProxyEpilog()</CODE> may stay as they 
      are - the only thing they do is saving and restoring CPU registers and 
      flags, which is done the same way in both kernel and user modes. We will 
      start with "theoretical foundations" - first, we will look at how our 
      custom asynchronous message queue and TLS can be implemented, and proceed 
      to the actual task of spying afterwards.</P>
      <H2>Asynchronous Message Queuing</H2>
      <P>Look at the code below (I hope that, after having read my previous 
      article, you are able to recognize handcrafted indirect jump 
      instruction):</P><PRE lamg="mc++"><SPAN class=code-SDKkeyword>BYTE</SPAN> chunk1[<SPAN class=code-digit>32</SPAN>];
chunk1[<SPAN class=code-digit>0</SPAN>]=0xFF;chunk1[<SPAN class=code-digit>1</SPAN>]=0x25;<SPAN class=code-keyword>int</SPAN> i=(<SPAN class=code-keyword>int</SPAN>)&amp;chunk1[<SPAN class=code-digit>6</SPAN>];
memmove(&amp;chunk1[<SPAN class=code-digit>2</SPAN>],&amp;i,<SPAN class=code-digit>4</SPAN>);i=(<SPAN class=code-keyword>int</SPAN>)&amp;chunk1[<SPAN class=code-digit>0</SPAN>];
memmove(&amp;chunk1[<SPAN class=code-digit>6</SPAN>],&amp;i,<SPAN class=code-digit>4</SPAN>);
CreateThread(<SPAN class=code-digit>0</SPAN>,<SPAN class=code-digit>0</SPAN>,(LPTHREAD_START_ROUTINE)&amp;chunk1[<SPAN class=code-digit>0</SPAN>],<SPAN class=code-digit>0</SPAN>,<SPAN class=code-digit>0</SPAN> ,&amp;dw);</PRE>
      <P>What does the newly created thread do? Absolutely nothing - in the 
      beginning of <CODE>chunk1</CODE> array, it finds the instruction to jump 
      to the location, address of which is stored 6 bytes above the beginning of 
      <CODE>chunk1</CODE> array. However, the only thing stored there is the 
      address of <CODE>chunk1</CODE> array itself. Therefore, the code is 
      instructed to jump to its current position, where it finds the instruction 
      to jump to its current position, etc., etc., etc... As a result, the 
      thread gets into the processor-level version of infinite loop, and is 
      unable to move anywhere - it spins at its start address.</P>
      <P>What is going to happen if, at some point, the program executes the 
      following lines (<CODE>addr</CODE> is the variable, containing a pointer 
      to the function which, for the sake of simplicity, takes no 
arguments):</P><PRE lamg="mc++"><SPAN class=code-comment>//</SPAN><SPAN class=code-comment>fill the array with the machine codes
</SPAN>chunk2[<SPAN class=code-digit>0</SPAN>]=0xFF;chunk2[<SPAN class=code-digit>1</SPAN>]=0x25;i=(<SPAN class=code-keyword>int</SPAN>)&amp;chunk2[<SPAN class=code-digit>6</SPAN>];
memmove(&amp;chunk2[<SPAN class=code-digit>2</SPAN>],&amp;i,<SPAN class=code-digit>4</SPAN>);i=(<SPAN class=code-keyword>int</SPAN>)&amp;chunk2[<SPAN class=code-digit>0</SPAN>];
memmove(&amp;chunk2[<SPAN class=code-digit>6</SPAN>],&amp;i,<SPAN class=code-digit>4</SPAN>);
chunk2[<SPAN class=code-digit>10</SPAN>]=0x68;i=(<SPAN class=code-keyword>int</SPAN>)&amp;chunk2[<SPAN class=code-digit>0</SPAN>];
memmove(&amp;chunk2[<SPAN class=code-digit>11</SPAN>],&amp;i,<SPAN class=code-digit>4</SPAN>);
chunk2[<SPAN class=code-digit>15</SPAN>]=0xFF;chunk2[<SPAN class=code-digit>16</SPAN>]=0x25;i=(<SPAN class=code-keyword>int</SPAN>)&amp;addr;
memmove(&amp;chunk2[<SPAN class=code-digit>17</SPAN>],&amp;i,<SPAN class=code-digit>4</SPAN>);

<SPAN class=code-comment>//</SPAN><SPAN class=code-comment> what is going to happen???
</SPAN>i=(<SPAN class=code-keyword>int</SPAN>)&amp;chunk2[<SPAN class=code-digit>10</SPAN>];
memmove(&amp;chunk1[<SPAN class=code-digit>6</SPAN>],&amp;i,<SPAN class=code-digit>4</SPAN>);</PRE>
      <P>When the last line of the above code gets executed, the thread will 
      break out of its infinite loop, and jump to the handcrafted code in 
      <CODE>chunk2</CODE> array. Why? Because the thread is instructed to jump 
      to the location, address of which is stored 6 bytes above the beginning of 
      <CODE>chunk1</CODE> array. We wrote the address of <CODE>chunk1</CODE> 
      array there, and, as a result, made the thread spin. If we write some 
      other address 6 bytes above the beginning of <CODE>chunk1</CODE> array, 
      the code flow will jump to the new location.</P>
      <P>The code in <CODE>chunk2</CODE> array (starting from byte 10, i.e. the 
      location to which our thread will jump) instructs the thread to push the 
      address of <CODE>chunk2</CODE> array on the stack, and to jump to the 
      target function. Therefore, after the target function returns, the code 
      flow will jump to the beginning of <CODE>chunk2</CODE> array, where it 
      will find the instruction to jump to the location, address of which is 
      stored 6 bytes above the beginning of <CODE>chunk2</CODE> array. Once the 
      only thing stored there is the address of <CODE>chunk2</CODE> array, the 
      thread starts spinning again.</P>
      <P>We can repeat this sequence again and again and again with 
      <CODE>chunk3</CODE>, <CODE>chunk4</CODE>, <CODE>chunk5</CODE>, etc. - the 
      thread will break out of its infinite loop, execute the target function, 
      enter an infinite loop, break out when the next chunk of instructions 
      arrives, execute the target function, enter an infinite loop again, and so 
      on and so forth. Therefore, we can schedule the target function for 
      subsequent execution simply by writing data to the array, rather than by 
      means of system-defined APC. We can do it whenever we wish - our thread 
      never terminates. The only thing we need to know is the location where the 
      thread currently spins, or, in case if it currently executes the target 
      function, the location where it will spin after the target function 
      returns - we have to write the address we want it to jump to 6 bytes above 
      this location. In practical terms, it makes sense to allocate all these 
      chunks from the same pool, and to use an offset index as a pointer into 
      this pool. When the pool gets fully packed, we can reuse it- all we have 
      to do is to set an index to zero, and start it over again.</P>
      <P>Let's say the thread runs in the user-mode process X. It is 
      understandable that the function we want it to execute must reside in the 
      address space of user-mode process X as well, but what about the code that 
      actually fills the array with the machine instructions and makes the 
      thread break out of its infinite loop? Where should it reside? It can 
      reside anywhere - in the same module, in a different module of the same 
      process, in another user-mode process, or even in kernel- mode driver. 
      Furthermore, this code can be concurrently executed by different threads 
      in different processes. As long as this code has a write access to the 
      address space of the process X, it can post an asynchronous message that 
      schedules the target function for execution. In order to do so, it does 
      not need any system services - what it needs are the addresses of the 
      target function and of the pool (as they are known to the process X), the 
      ability to write data to this pool, plus the current value of offset 
      index. This approach is absolutely generic, and can be used whenever we 
      need to post an asynchronous message to an application, but, for some 
      reason, are unable to use system-defined APC and asynchronous message 
      queuing.</P>
      <P>Now, let's look at how we can save thread-specific data without using 
      system-defined TLS.</P>
      <H2>Storing Thread-Specific Data</H2>
      <P>Prolog and epilog of any function that uses <CODE lang=asm>EBP</CODE> 
      register as a base pointer to its local variables look like the 
      following:</P><PRE lang=asm><SPAN class=code-keyword>push</SPAN> ebp<SPAN class=code-comment>;</SPAN><SPAN class=code-comment> save ebp
</SPAN><SPAN class=code-keyword>mov</SPAN> ebp,esp
<SPAN class=code-keyword>sub</SPAN> esp, XXX<SPAN class=code-comment>;</SPAN><SPAN class=code-comment> allocate local variables 
</SPAN>.......
do actual things...
..........
<SPAN class=code-keyword>mov</SPAN> esp,ebp
<SPAN class=code-keyword>pop</SPAN> ebp<SPAN class=code-comment>;</SPAN><SPAN class=code-comment> restore ebp
</SPAN><SPAN class=code-keyword>ret</SPAN></PRE>
      <P>It is easy to see that, as a very first step, the function must save 
      the value of <CODE lang=asm>EBP</CODE> register on the stack, and restore 
      it before returning the control. This is an absolute must - otherwise, the 
      caller will be unable to keep track of its local variables after the 
      function returns. It is also easy to see that the function saves the value 
      of <CODE lang=asm>EBP</CODE> on the stack just one stack entry above the 
      function's return address, and then copies the current value of <CODE 
      lang=asm>ESP</CODE> into <CODE lang=asm>EBP</CODE> register. Therefore, 
      the current value of <CODE lang=asm>EBP</CODE> register always points to 
      the location that stores the previous value of <CODE 
      lang=asm>EBP</CODE>.</P>
      <P>What does it have to do with spying? Look at how our spying code flow 
      affects the original value of <CODE lang=asm>EBP</CODE>, i.e. the value of 
      <CODE lang=asm>EBP</CODE> at the time when <CODE>ProxyProlog()</CODE> 
      starts execution (I hope you remember our "spying team" from the previous 
      article):</P>
      <UL>
        <LI><CODE>ProxyProlog()</CODE> - does not change <CODE 
        lang=asm>EBP</CODE> value before calling <CODE>Prolog()</CODE> 
        <LI><CODE>Prolog()</CODE> - Once <CODE>Prolog()</CODE> is not a naked 
        routine, the compiler will definitely generate instructions to save the 
        value of <CODE lang=asm>EBP</CODE> above <CODE>Prolog()</CODE>'s return 
        address, and to pop this value into <CODE lang=asm>EBP</CODE> register 
        before <CODE>Prolog()</CODE> returns. 
        <LI><CODE>ProxyProlog()</CODE> - does not change <CODE 
        lang=asm>EBP</CODE> value after <CODE>Prolog()</CODE> returns. 
        <P>Actual callee - either saves the original value of <CODE 
        lang=asm>EBP</CODE> and restores it before returning control, or leaves 
        <CODE lang=asm>EBP</CODE> register intact. In any case, the original 
        value of <CODE lang=asm>EBP</CODE> is of no importance for the actual 
        callee - it is only the client code that actually uses it.</P>
        <LI><CODE>ProxyEpilog()</CODE> - does not change <CODE 
        lang=asm>EBP</CODE> value before calling <CODE>Epilog()</CODE> 
        <LI><CODE>Epilog()</CODE> - Once <CODE>Epilog()</CODE> is not a naked 
        routine, the compiler will definitely generate instructions to save the 
        value of <CODE lang=asm>EBP</CODE> above <CODE>Epilog()</CODE>'s return 
        address.... 
        <P>Did you get it? The value, stored above <CODE>Prolog()</CODE>'s 
        return address, is always going to be equal to the one, stored above 
        <CODE>Epilog()</CODE>'s return address!!! Furthermore, this value in 
        itself is of no importance until the program flow returns to the client 
        code. This is what we can take advantage on.</P>
        <LI><CODE>Prolog()</CODE> can save the original value of <CODE 
        lang=asm>EBP</CODE>, along with the original return address and all 
        other relevant information, in the <CODE>Storage</CODE> structure, and 
        write the pointer to this structure just above its return address. Once 
        the same pointer to the <CODE>Storage</CODE> structure is going to be 
        stored above <CODE>Epilog()</CODE>'s return address, and the original 
        value of <CODE lang=asm>EBP</CODE> is available from this structure, 
        <CODE>Epilog()</CODE> can write this value above its return address, so 
        that it will get popped into <CODE lang=asm>EBP</CODE> register before 
        <CODE>Epilog()</CODE> returns. As a result, at the time when the program 
        flow jumps to the client code, the value of <CODE lang=asm>EBP</CODE> is 
        going to be exactly the same it used to be at the time when 
        <CODE>ProxyProlog()</CODE> started execution. 
        <P>Therefore, we can save the pointer to the <CODE>Storage</CODE> 
        structure in the location, pointed to by <CODE lang=asm>EBP</CODE> 
        register, rather than in the thread local storage - our spying code is 
        going to stay thread-safe anyway. Such approach is suitable for both 
        kernel-mode and user-mode spying. It is needless to say that, in case of 
        kernel-mode spying, the <CODE>Storage</CODE> structure must be allocated 
        from non-paged pool - our spying code may run at high IRQL.</P></LI></UL>
      <P>Armed with this theoretical knowledge, we can implement it in practice, 
      and proceed to the actual task of kernel-mode spying. I am sorry - I 
      forgot to tell you that overwriting the addresses of functions, imported 
      by kernel-mode driver, is a bit different from modifying user-mode 
      module's IAT.</P>
      <H2>Kernel-Mode Spying</H2>
      <P>First of all, let's look at how IAT is filled with the addresses of 
      imported functions at load time. As a first step, the loader has to locate 
      the module's import directory, i.e. the array of 
      <CODE>IMAGE_IMPORT_DESCRIPTOR</CODE> structures, from which it can obtain 
      the pointers to Import Name and Import Address tables. After having 
      obtained the name of the imported function from the Import Name Table, the 
      loader can get its address from the <CODE>IMAGE_EXPORT_DIRECTORY</CODE> of 
      the module that exports the given function, and write this address to the 
      Import Address Table, so that the program can call the imported function. 
      It is understandable that the Import Address Table is needed as long as 
      the program runs, but what about the Import Name Table and the array of 
      <CODE>IMAGE_IMPORT_DESCRIPTOR</CODE> structures? Are they needed after the 
      loader fills the Import Address Table with the addresses of imported 
      functions? Not really - they are needed only at the load time. What is the 
      point of keeping them in memory after the module gets loaded?</P>
      <P>As long as they reside in pageable memory, this is not really a big 
      deal - they will be normally swapped to the disk, and get loaded into RAM 
      only if we want to access them, i.e. they are not going to take up space 
      in RAM anyway. Once user-mode modules can be paged to the disk, the loader 
      just cannot be bothered to discard the Import Name Table and the array of 
      <CODE>IMAGE_IMPORT_DESCRIPTOR</CODE> structures from memory after the user 
      module gets loaded - it is not worth an effort. Therefore, the pointer to 
      the array of <CODE>IMAGE_IMPORT_DESCRIPTOR</CODE> structures, available 
      from the target user module's <CODE>IMAGE_OPTIONAL_HEADER</CODE>, is 
      always valid.</P>
      <P>However, the kernel-mode driver, apart from its code that has been 
      explicitly marked as pageable, has to be constantly loaded in RAM, which, 
      compared to virtual memory, is scarce. Under such circumstances, keeping 
      the Import Name Table and the array of 
      <CODE>IMAGE_IMPORT_DESCRIPTOR</CODE> structures in memory is just an 
      unreasonable waste of resources. In order to solve this problem, the 
      linker may place the Import Name Table and the array of 
      <CODE>IMAGE_IMPORT_DESCRIPTOR</CODE> structures to the driver's INIT 
      section, along with <CODE>DriverEntry()</CODE> and 
      <CODE>DriverReinitialize()</CODE> routines, i.e. the code that is needed 
      only during driver's initialization. After the driver is loaded, the 
      loader simply discards its <I>.INIT</I> section from memory, because it 
      does not contain any information that may be needed after driver's 
      initialization. As a result, after the driver is loaded, the pointer to 
      the array of <CODE>IMAGE_IMPORT_DESCRIPTOR</CODE> structures, available 
      from the target driver's <CODE>IMAGE_OPTIONAL_HEADER</CODE>, may point 
      right to the middle of nowhere, and, hence, should not be accessed - in 
      order to figure it out, I had to spend two evenings in "blue screen - 
      reboot loop".</P>
      <P>However, the array of <CODE>IMAGE_IMPORT_DESCRIPTOR</CODE> structures 
      contains information, crucial for locating the Import Address Table. What 
      are we going to do? We will map the target driver's file into the memory, 
      and obtain all necessary information from the file mapping. This can be 
      done by the user-mode controller application. Look at the code below:</P><PRE lang=mc++><SPAN class=code-keyword>typedef</SPAN> <SPAN class=code-keyword>struct</SPAN> tagSYSTEM_MODULE_INFORMATION {
    ULONG Reserved[<SPAN class=code-digit>2</SPAN>];
    PVOID Base;
    ULONG Size;
    ULONG Flags;
    USHORT Index;
    USHORT Unknown;
    USHORT LoadCount;
    USHORT ModuleNameOffset;
    CHAR ImageName[<SPAN class=code-digit>256</SPAN>];
} SYSTEM_MODULE_INFORMATION, *PSYSTEM_MODULE_INFORMATION;

<SPAN class=code-keyword>int</SPAN> spy(<SPAN class=code-keyword>char</SPAN>*path)
{
    DWORD a,dw,x,num; 
    SYSTEM_MODULE_INFORMATION info;<SPAN class=code-keyword>char</SPAN> buff[<SPAN class=code-digit>256</SPAN>]; 
    DWORD* base=0;<SPAN class=code-keyword>char</SPAN>* fullname; <SPAN class=code-keyword>char</SPAN>* drivername1;<SPAN class=code-keyword>char</SPAN>* drivername2;

    <SPAN class=code-comment>//</SPAN><SPAN class=code-comment>get the name of the target driver
</SPAN>    a=strlen(path);

    <SPAN class=code-keyword>while</SPAN>(<SPAN class=code-digit>1</SPAN>)
    {
        <SPAN class=code-keyword>if</SPAN>(path[a]==<SPAN class=code-string>'</SPAN><SPAN class=code-string>/'</SPAN>||path[a]==<SPAN class=code-string>'</SPAN><SPAN class=code-string>\\'</SPAN> )
            <SPAN class=code-keyword>break</SPAN>;
        a--;
    }
    a++;
    drivername1=&amp;path[a];

    <SPAN class=code-comment>//</SPAN><SPAN class=code-comment>get the list of all loaded drivers
</SPAN>    <SPAN class=code-keyword>typedef</SPAN> DWORD (<SPAN class=code-keyword>__stdcall</SPAN>*func)(DWORD,LPVOID,DWORD,DWORD*);

    func ZwQuerySystemInformation=
      (func)GetProcAddress(GetModuleHandle(<SPAN class=code-string>"</SPAN><SPAN class=code-string>ntdll.dll"</SPAN>),
      <SPAN class=code-string>"</SPAN><SPAN class=code-string>ZwQuerySystemInformation"</SPAN>);

    ZwQuerySystemInformation(<SPAN class=code-digit>11</SPAN>,&amp;info,
        <SPAN class=code-keyword>sizeof</SPAN>(SYSTEM_MODULE_INFORMATION),&amp;dw);
    <SPAN class=code-SDKkeyword>BYTE</SPAN> *array=new <SPAN class=code-SDKkeyword>BYTE</SPAN>[dw];
    ZwQuerySystemInformation(<SPAN class=code-digit>11</SPAN>,<SPAN class=code-keyword>array</SPAN>,dw,&amp;dw);
    SYSTEM_MODULE_INFORMATION *sys=(PSYSTEM_MODULE_INFORMATION)&amp;array[<SPAN class=code-digit>4</SPAN>];
    num=dw/(<SPAN class=code-keyword>sizeof</SPAN>(SYSTEM_MODULE_INFORMATION));

    <SPAN class=code-comment>//</SPAN><SPAN class=code-comment> check if the target driver is loaded
</SPAN>    <SPAN class=code-keyword>for</SPAN>(x=0;x<SPAN class=code-keyword>&lt;</SPAN>num;x++)
    {
        fullname=(<SPAN class=code-keyword>char</SPAN>*)sys-<SPAN class=code-keyword>&gt;</SPAN>ImageName;
        a=strlen(fullname);
        <SPAN class=code-keyword>while</SPAN>(fullname[a]!=<SPAN class=code-string>'</SPAN><SPAN class=code-string>\\'</SPAN>)
        {
            <SPAN class=code-keyword>if</SPAN>(a==0)<SPAN class=code-keyword>break</SPAN>;a--;
        }
        a++;
        <SPAN class=code-keyword>if</SPAN>(a==1)
            drivername2=fullname;
        <SPAN class=code-keyword>else</SPAN>
            drivername2=&amp;fullname[a];

        <SPAN class=code-keyword>if</SPAN>(!stricmp(drivername1,drivername2))
        {
            base=(DWORD*)sys-<SPAN class=code-keyword>&gt;</SPAN>Base;<SPAN class=code-keyword>break</SPAN>;
        }
        sys++;
    }

    <SPAN class=code-keyword>if</SPAN>(!base)
    {
        MessageBox(GetDesktopWindow(),
            <SPAN class=code-string>"</SPAN><SPAN class=code-string>This driver is not loaded"</SPAN>,
            <SPAN class=code-string>"</SPAN><SPAN class=code-string>spy"</SPAN>,MB_OK);<SPAN class=code-keyword>return</SPAN> <SPAN class=code-digit>0</SPAN>;
    }
 
    <SPAN class=code-comment>//</SPAN><SPAN class=code-comment> map the target driver's file into memory
</SPAN>    <SPAN class=code-comment>//</SPAN><SPAN class=code-comment> and get the pointer to import directory
</SPAN>    HANDLE filehandle=CreateFile(path,GENERIC_READ|GENERIC_WRITE,
                     <SPAN class=code-digit>0</SPAN>,<SPAN class=code-digit>0</SPAN>,OPEN_EXISTING,FILE_ATTRIBUTE_SYSTEM,<SPAN class=code-digit>0</SPAN>);
    HANDLE maphandle=CreateFileMapping(filehandle,<SPAN class=code-digit>0</SPAN>,
                       PAGE_READONLY|SEC_IMAGE,<SPAN class=code-digit>0</SPAN>,<SPAN class=code-digit>0</SPAN>,<SPAN class=code-string>"</SPAN><SPAN class=code-string>drivermap"</SPAN>);
    readbuff=(<SPAN class=code-keyword>char</SPAN>*)MapViewOfFile(maphandle,FILE_MAP_READ,<SPAN class=code-digit>0</SPAN>,<SPAN class=code-digit>0</SPAN>,<SPAN class=code-digit>0</SPAN>);
  
    IMAGE_DOS_HEADER * dosheader=(IMAGE_DOS_HEADER *)readbuff;
    IMAGE_OPTIONAL_HEADER * opthdr =(IMAGE_OPTIONAL_HEADER *) 
                     ((<SPAN class=code-SDKkeyword>BYTE</SPAN>*)dosheader+dosheader-<SPAN class=code-keyword>&gt;</SPAN>e_lfanew+24);

    IMAGE_IMPORT_DESCRIPTOR * descriptor=(IMAGE_IMPORT_DESCRIPTOR *)
     ((<SPAN class=code-SDKkeyword>BYTE</SPAN>*)dosheader+ 
     opthdr-<SPAN class=code-keyword>&gt;</SPAN>DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress);

    <SPAN class=code-keyword>int</SPAN> totalcount=0;DWORD*ptr=(DWORD*)&amp;buff[<SPAN class=code-digit>16</SPAN>];

    <SPAN class=code-comment>//</SPAN><SPAN class=code-comment> now we are filling the control array with offsets to IATs
</SPAN>    <SPAN class=code-comment>//</SPAN><SPAN class=code-comment> and numbers of entries in each IAT
</SPAN>    <SPAN class=code-keyword>while</SPAN>(descriptor-<SPAN class=code-keyword>&gt;</SPAN>FirstThunk)
    {

        IMAGE_THUNK_DATA* thunk=( IMAGE_THUNK_DATA*)
            ((<SPAN class=code-SDKkeyword>BYTE</SPAN>*)dosheader+descriptor-<SPAN class=code-keyword>&gt;</SPAN>OriginalFirstThunk);
        DWORD firstthunk=descriptor-<SPAN class=code-keyword>&gt;</SPAN>FirstThunk;
        x=0;
        <SPAN class=code-keyword>while</SPAN>(thunk-<SPAN class=code-keyword>&gt;</SPAN>u1.Function)
        {
            <SPAN class=code-keyword>char</SPAN>*functionname=(<SPAN class=code-keyword>char</SPAN>*)((<SPAN class=code-SDKkeyword>BYTE</SPAN>*)dosheader+
                    (<SPAN class=code-keyword>unsigned</SPAN>)thunk-<SPAN class=code-keyword>&gt;</SPAN>u1.AddressOfData+2);
            functionbuff[totalcount]=functionname;
            x++;thunk++;totalcount++;
        }

        memmove(ptr,&amp;firstthunk,<SPAN class=code-digit>4</SPAN>);ptr++;
        memmove(ptr,&amp;x,<SPAN class=code-digit>4</SPAN>);ptr++;
        descriptor++;
    }

    <SPAN class=code-comment>//</SPAN><SPAN class=code-comment> create the thread and the pool
</SPAN>    writebuff=(<SPAN class=code-SDKkeyword>BYTE</SPAN>* )VirtualAllocEx(GetCurrentProcess(),
       <SPAN class=code-digit>0</SPAN>,<SPAN class=code-digit>4096</SPAN>,MEM_RESERVE,PAGE_EXECUTE_READWRITE);
    writebuff=(<SPAN class=code-SDKkeyword>BYTE</SPAN>* )VirtualAllocEx(GetCurrentProcess(),
        writebuff,<SPAN class=code-digit>4096</SPAN>,MEM_COMMIT,PAGE_EXECUTE_READWRITE);

    writebuff[<SPAN class=code-digit>0</SPAN>]=0xFF;writebuff[<SPAN class=code-digit>1</SPAN>]=0x25;<SPAN class=code-keyword>int</SPAN> i=(<SPAN class=code-keyword>int</SPAN>)&amp;writebuff[<SPAN class=code-digit>6</SPAN>];
    memmove(&amp;writebuff[<SPAN class=code-digit>2</SPAN>],&amp;i,<SPAN class=code-digit>4</SPAN>);i=(<SPAN class=code-keyword>int</SPAN>)&amp;writebuff[<SPAN class=code-digit>0</SPAN>];
    memmove(&amp;writebuff[<SPAN class=code-digit>6</SPAN>],&amp;i,<SPAN class=code-digit>4</SPAN>);
    HANDLE threadhandle=CreateThread(<SPAN class=code-digit>0</SPAN>,<SPAN class=code-digit>0</SPAN>,
        (LPTHREAD_START_ROUTINE)&amp;writebuff[<SPAN class=code-digit>0</SPAN>],<SPAN class=code-digit>0</SPAN>,<SPAN class=code-digit>0</SPAN> ,&amp;dw);

    structbuff[<SPAN class=code-digit>0</SPAN>]=0;structbuff[<SPAN class=code-digit>1</SPAN>]=(DWORD)&amp;logthread;

    <SPAN class=code-comment>//</SPAN><SPAN class=code-comment> keep on filling the control array with relevant info
</SPAN>    memmove(&amp;buff[<SPAN class=code-digit>12</SPAN>],&amp;totalcount,<SPAN class=code-digit>4</SPAN>);
    memmove(&amp;buff[<SPAN class=code-digit>8</SPAN>],&amp;base,<SPAN class=code-digit>4</SPAN>);
    i=(<SPAN class=code-keyword>int</SPAN>)&amp;structbuff[<SPAN class=code-digit>0</SPAN>];
    memmove(&amp;buff[<SPAN class=code-digit>4</SPAN>],&amp;i,<SPAN class=code-digit>4</SPAN>);
    i=(<SPAN class=code-keyword>int</SPAN>)&amp;writebuff[<SPAN class=code-digit>0</SPAN>];
    memmove(&amp;buff[<SPAN class=code-digit>0</SPAN>],&amp;i,<SPAN class=code-digit>4</SPAN>);

    <SPAN class=code-comment>//</SPAN><SPAN class=code-comment> open the spying driver
</SPAN>    device=CreateFile(<SPAN class=code-string>"</SPAN><SPAN class=code-string>\\\\.\\SPY1"</SPAN>,GENERIC_READ|GENERIC_WRITE,
        <SPAN class=code-digit>0</SPAN>,<SPAN class=code-digit>0</SPAN>,OPEN_EXISTING,FILE_ATTRIBUTE_NORMAL,<SPAN class=code-digit>0</SPAN>);
    <SPAN class=code-keyword>if</SPAN>((HANDLE)0xffffffff==device)
    {
        MessageBox(GetDesktopWindow(),
            <SPAN class=code-string>"</SPAN><SPAN class=code-string>Spying driver is not loadeded"</SPAN>,<SPAN class=code-string>"</SPAN><SPAN class=code-string>spy"</SPAN>,MB_OK);<SPAN class=code-keyword>return</SPAN> <SPAN class=code-digit>0</SPAN>;
    }

    <SPAN class=code-comment>//</SPAN><SPAN class=code-comment>create the logfile
</SPAN>    <SPAN class=code-keyword>char</SPAN> namebuff[<SPAN class=code-digit>256</SPAN>]; 
    GetModuleFileName(<SPAN class=code-digit>0</SPAN>,namebuff,<SPAN class=code-digit>256</SPAN>);
    a=strlen(namebuff);
    <SPAN class=code-keyword>while</SPAN>(<SPAN class=code-digit>1</SPAN>)
    {
        <SPAN class=code-keyword>if</SPAN>(namebuff[a]==<SPAN class=code-string>'</SPAN><SPAN class=code-string>\\'</SPAN>)
            <SPAN class=code-keyword>break</SPAN>;
        a--;
    }
    a++;
    strcpy(&amp;namebuff[a], <SPAN class=code-string>"</SPAN><SPAN class=code-string>spylogfile.txt"</SPAN>);

    logfile=CreateFile(namebuff,GENERIC_READ|GENERIC_WRITE,
        <SPAN class=code-digit>0</SPAN>,<SPAN class=code-digit>0</SPAN>,CREATE_ALWAYS,FILE_ATTRIBUTE_NORMAL,<SPAN class=code-digit>0</SPAN>);

    <SPAN class=code-comment>//</SPAN><SPAN class=code-comment> send the control array to the spying driver
</SPAN>    DeviceIoControl(device,IOCTL_START_SPYING,
                    buff,<SPAN class=code-digit>256</SPAN>,buff,<SPAN class=code-digit>256</SPAN>,&amp;dw,<SPAN class=code-digit>0</SPAN>);

    <SPAN class=code-keyword>return</SPAN> <SPAN class=code-digit>1</SPAN>;
}</PRE>
      <P>As a first step, we find the address at which our target driver is 
      loaded in memory. We do it by calling 
      <CODE>ZwQuerySystemInformation()</CODE> native API function, which can 
      return information about all currently loaded drivers. 
      <CODE>ZwQuerySystemInformation()</CODE> returns this information as an 
      array of <CODE>SYSTEM_MODULE_INFORMATION</CODE> structures. 
      <CODE>Base</CODE> field of <CODE>SYSTEM_MODULE_INFORMATION</CODE> 
      structure indicates the address at which the given driver is loaded, and 
      <CODE>ImageName</CODE> field may contain either the name of the driver, or 
      the whole path to the driver's file. If <CODE>ImageName</CODE> field 
      contains the path, we extract the name of the driver from the path, and 
      compare it to the target driver's name, which has also been extracted from 
      the path that was received by <CODE>spy()</CODE> as an argument. We do it 
      until we locate the target driver, and save the <CODE>Base</CODE> field of 
      its corresponding <CODE>SYSTEM_MODULE_INFORMATION</CODE> structure in 
      local variable.</P>
      <P>Then we map the target driver's file into the memory, and locate its 
      import directory, i.e. the array of <CODE>IMAGE_IMPORT_DESCRIPTOR</CODE> 
      structures. The <CODE>FirstThunk</CODE> field of every 
      <CODE>IMAGE_IMPORT_DESCRIPTOR</CODE> structure indicates the offset to the 
      beginning of Import Address Table that corresponds to the given imported 
      module, and the <CODE>OriginalFirstThunk</CODE> field indicates the offset 
      to the beginning of the array of <CODE>IMAGE_THUNK_DATA</CODE> structures. 
      By counting the number of <CODE>IMAGE_THUNK_DATA</CODE> structures that 
      have non-zero value of the <CODE>Function</CODE> field, we can find the 
      number of entries in IAT that corresponds to the given imported module. 
      For every imported module, we get the offset to the beginning of its 
      corresponding Import Address Table, and count the number of entries in 
      this table. We write these values into the control array, starting from 
      control array's 16th byte. We also save pointers to the names of imported 
      functions in global <CODE>functionbuff</CODE> array.</P>
      <P>Then we allocate a page of virtual memory, fill first 10 bytes of it 
      with the machine codes, and create the thread which will process our 
      asynchronous messages - it is going to spin in infinite loop until the 
      message arrives. We also write the current value of our offset index 
      (which is currently zero), and address of the logging function to be 
      invoked asynchronously by the spying driver, into <CODE>structbuff</CODE> 
      array. This function is too simple to be listed here - it just takes the 
      return value of the API function and the position of its name in 
      <CODE>functionbuff</CODE> array as parameters, formats the null-terminated 
      string in the form <CODE>ApiFunctionXXX</CODE> - returned 
      <CODE>YYY</CODE>, and writes it to the log file. The only thing worth 
      mentioning is that this logging function definitely has to be declared 
      with <CODE><SPAN class=code-keyword>__stdcall</SPAN></CODE> calling 
      convention, so that it pops its arguments off the stack.</P>
      <P>Then we fill the first 16 bytes of the control array with the remaining 
      relevant data. This includes the address at which the target driver is 
      loaded, the number of functions imported by the target driver, the address 
      of the pool, and the address of the array that stores the address of the 
      target function and the offset index. Then we create the log file in the 
      folder where the controller application's <I>.exe</I> file resides. 
      Finally, we send the control array to the spying driver by calling 
      <CODE>DeviceIoControl()</CODE> with our user-defined 
      <CODE>IOCTL_START_SPYING</CODE> command.</P>
      <P>Now, let's look at what happens in the kernel mode after our spying 
      driver receives <CODE>IOCTL_START_SPYING</CODE> command:</P><PRE lang=mc++><SPAN class=code-keyword>typedef</SPAN> <SPAN class=code-keyword>struct</SPAN> tagRelocatedFunction{
LONG address;
LONG function;
} RelocatedFunction,*PRelocatedFunction;


<SPAN class=code-keyword>typedef</SPAN> <SPAN class=code-keyword>struct</SPAN> tagStorage{
    DWORD isfree;
    DWORD retaddress;
    DWORD prevEBP;
    RelocatedFunction* ptr;
}Storage,*PStorage;

<SPAN class=code-comment>//</SPAN><SPAN class=code-comment>global variables
</SPAN><SPAN class=code-keyword>char</SPAN> savebuff[<SPAN class=code-digit>64</SPAN>];KEVENT event1,event2;
<SPAN class=code-keyword>long</SPAN> totalcount=0,base,userbuff,userstruct;
<SPAN class=code-keyword>unsigned</SPAN> <SPAN class=code-keyword>char</SPAN> *replacementchunks;DWORD *functionarray;
Storage storagearray[<SPAN class=code-digit>256</SPAN>];
<SPAN class=code-SDKkeyword>BYTE</SPAN> retbuff[<SPAN class=code-digit>16</SPAN>];<SPAN class=code-SDKkeyword>BOOLEAN</SPAN> ishooking;
DWORD * userstructptr; <SPAN class=code-SDKkeyword>BYTE</SPAN> * userbuffptr;

NTSTATUS DrvDispatch(IN PDEVICE_OBJECT  devobject,IN PIRP irp)
{
    <SPAN class=code-keyword>char</SPAN>*buff=NULL;PIO_STACK_LOCATION loc;
    DWORD thunk, count,x,a;<SPAN class=code-keyword>long</SPAN> num,addr;DWORD * ptr;
    <SPAN class=code-SDKkeyword>BYTE</SPAN>*byteptr; <SPAN class=code-SDKkeyword>BYTE</SPAN> *array=0; RelocatedFunction * reloc;

    loc=IoGetCurrentIrpStackLocation(irp);

    <SPAN class=code-keyword>if</SPAN>(loc-<SPAN class=code-keyword>&gt;</SPAN>Parameters.DeviceIoControl.IoControlCode==IOCTL_START_SPYING)
    {
        buff=(<SPAN class=code-keyword>char</SPAN>*)irp-<SPAN class=code-keyword>&gt;</SPAN>AssociatedIrp.SystemBuffer;

        <SPAN class=code-comment>//</SPAN><SPAN class=code-comment>free resources that might be allocated 
</SPAN>        <SPAN class=code-comment>//</SPAN><SPAN class=code-comment>by our previous call to DrvDispatch
</SPAN>        <SPAN class=code-keyword>if</SPAN>(totalcount)
        {
            MmUnmapIoSpace(userbuffptr,<SPAN class=code-digit>4096</SPAN>);
            MmUnmapIoSpace(userstructptr,<SPAN class=code-digit>8</SPAN>);
            ExFreePool(replacementchunks);ExFreePool(functionarray);
            totalcount=0;
        }

        <SPAN class=code-comment>//</SPAN><SPAN class=code-comment>map the addresses of user -mode writebuff and structbuff
</SPAN>        <SPAN class=code-comment>//</SPAN><SPAN class=code-comment>arrays into the kernel address space
</SPAN>        memmove(&amp;userbuff,&amp;buff[<SPAN class=code-digit>0</SPAN>],<SPAN class=code-digit>4</SPAN>);
        memmove(&amp;userstruct,&amp;buff[<SPAN class=code-digit>4</SPAN>],<SPAN class=code-digit>4</SPAN>);
        userbuffptr= (<SPAN class=code-SDKkeyword>BYTE</SPAN> *) 
            MmMapIoSpace(MmGetPhysicalAddress((<SPAN class=code-keyword>void</SPAN>*)userbuff),
            <SPAN class=code-digit>4096</SPAN>,FALSE);
        userstructptr=(DWORD *)
            MmMapIoSpace(MmGetPhysicalAddress((<SPAN class=code-keyword>void</SPAN>*)userstruct),
            <SPAN class=code-digit>8</SPAN>,FALSE);

        <SPAN class=code-comment>//</SPAN><SPAN class=code-comment>save the remaining relevant data
</SPAN>        memmove(&amp;base,&amp;buff[<SPAN class=code-digit>8</SPAN>],<SPAN class=code-digit>4</SPAN>);
        memmove(&amp;totalcount,&amp;buff[<SPAN class=code-digit>12</SPAN>],<SPAN class=code-digit>4</SPAN>);
        memmove(&amp;savebuff,&amp;buff[<SPAN class=code-digit>16</SPAN>],<SPAN class=code-digit>64</SPAN>);

        <SPAN class=code-comment>//</SPAN><SPAN class=code-comment>allocate function replacement chunks
</SPAN>        replacementchunks=(<SPAN class=code-keyword>unsigned</SPAN> <SPAN class=code-keyword>char</SPAN>*)ExAllocatePool(NonPagedPool,
                                                    totalcount*<SPAN class=code-digit>16</SPAN>);

        <SPAN class=code-comment>//</SPAN><SPAN class=code-comment>allocate the array that holds addresses of actual functions
</SPAN>        functionarray=(DWORD*)ExAllocatePool(NonPagedPool,totalcount*<SPAN class=code-digit>4</SPAN>);

        <SPAN class=code-comment>//</SPAN><SPAN class=code-comment> overwrite IAT entries
</SPAN>        count=0;ptr=(DWORD*)savebuff;
        <SPAN class=code-keyword>while</SPAN>(<SPAN class=code-digit>1</SPAN>)
        {
            <SPAN class=code-keyword>if</SPAN>(count==totalcount)
                <SPAN class=code-keyword>break</SPAN>;
            memmove(&amp;thunk,ptr,<SPAN class=code-digit>4</SPAN>);ptr++;
            memmove(&amp;num,ptr,<SPAN class=code-digit>4</SPAN>);ptr++;

            <SPAN class=code-keyword>for</SPAN>(x=0;x<SPAN class=code-keyword>&lt;</SPAN>num;x++)
            {

                DWORD*IATentryaddress=(DWORD*)(base+thunk)+x;
                memmove(&amp;functionarray[count],IATentryaddress,<SPAN class=code-digit>4</SPAN>);
                byteptr=&amp;replacementchunks[count*<SPAN class=code-digit>16</SPAN>];

                reloc=(RelocatedFunction *)&amp;byteptr[<SPAN class=code-digit>6</SPAN>];
                byteptr[<SPAN class=code-digit>0</SPAN>]=255;byteptr[<SPAN class=code-digit>1</SPAN>]=21;memmove(&amp;byteptr[<SPAN class=code-digit>2</SPAN>],&amp;reloc,<SPAN class=code-digit>4</SPAN>);
                reloc-<SPAN class=code-keyword>&gt;</SPAN>function=count;

                a=(DWORD)&amp;ProxyProlog;
                memmove(&amp;reloc-<SPAN class=code-keyword>&gt;</SPAN>address,&amp;a,<SPAN class=code-digit>4</SPAN>);

                a=(DWORD)byteptr;memmove(IATentryaddress,&amp;a,<SPAN class=code-digit>4</SPAN>);
                count++;
            }
        }
        ishooking=TRUE;
    }

    irp-<SPAN class=code-keyword>&gt;</SPAN>IoStatus.Information=strlen(buff);
    IoCompleteRequest(irp,IO_NO_INCREMENT);

    <SPAN class=code-keyword>return</SPAN> STATUS_SUCCESS;
}</PRE>
      <P>As a first step, we map the addresses of user-mode pool, and of the 
      array which holds the current value of offset index and the address of the 
      target function, into the kernel address space. We save these pointers in 
      <CODE>userstructptr</CODE> and <CODE>userbuffptr</CODE> global variables - 
      we must make them available to <CODE>Epilog()</CODE>, which would need 
      them. We also save their virtual addresses, as they are known to the 
      user-mode code, in <CODE>userstruct</CODE> and <CODE>userbuff</CODE> 
      global variables - <CODE>Epilog()</CODE> would need them when it fills the 
      pool with the machine instructions.</P>
      <P>Then we save the remaining data received in the control array, in 
      global variables. We would need this data in order to unhook the functions 
      that we are about to hook now, so we must make sure that it is available 
      to <CODE>DrvClose()</CODE>, which is going to do this job. Then we 
      allocate the arrays that are going to hold function replacement chunks and 
      the addresses of actual functions - we already know the number of 
      functions we need to hook, and, hence, the number of bytes to allocate. We 
      save these pointers in <CODE>replacementchunks</CODE> and 
      <CODE>functionarray</CODE> global variables - we must make them available 
      to <CODE>Prolog()</CODE> and <CODE>DrvClose()</CODE>.</P>
      <P>At this point, we can proceed to the actual task of overwriting IAT 
      entries. We don't even have to process PE-related structures - the 
      user-mode controller application has provided us with all information we 
      need. I hope that, after having read my previous article, you are able to 
      understand how we do it, so I don't go into details here - the only 
      difference is that <CODE>RelocatedFunction</CODE> structure stores not the 
      actual address of imported function, but the position at which this 
      address can be found in <CODE>functionarray</CODE> table.</P>
      <P>Now, let's look at modifications that have to be applied to 
      <CODE>Prolog()</CODE> and <CODE>Epilog()</CODE>. 
      <CODE>ProxyProlog()</CODE> and <CODE>ProxyEpilog()</CODE> don't need any 
      modifications, so we don't discuss them here.</P><PRE lang=mc++> <SPAN class=code-keyword>void</SPAN> <SPAN class=code-keyword>__stdcall</SPAN> Prolog(DWORD * relocptr)
{

    DWORD x;DWORD *ebpptr; <SPAN class=code-keyword>int</SPAN> a=0;
    RelocatedFunction * reloc=(RelocatedFunction*)relocptr[<SPAN class=code-digit>0</SPAN>];
    DWORD *retaddessptr=relocptr+1;
    Storage*storptr;
    KIRQL irql=KeGetCurrentIrql( );

    <SPAN class=code-comment>//</SPAN><SPAN class=code-comment>find the first available Storage structure
</SPAN>    <SPAN class=code-keyword>if</SPAN>(irql<SPAN class=code-keyword>&lt;</SPAN>DISPATCH_LEVEL)
        KeWaitForSingleObject (&amp;event1,Executive,KernelMode,<SPAN class=code-digit>0</SPAN>,<SPAN class=code-digit>0</SPAN>);

    _asm {
            cli
            lea ebx,storagearray
start:                  mov ecx,dword ptr[ebx]
            cmp ecx,<SPAN class=code-digit>100</SPAN>
            jne fin
            add ebx,<SPAN class=code-digit>16</SPAN>
            jmp start
fin:                  mov dword ptr[ebx],<SPAN class=code-digit>100</SPAN>
            mov storptr,ebx
            sti
          }

    <SPAN class=code-keyword>if</SPAN>(irql<SPAN class=code-keyword>&lt;</SPAN>DISPATCH_LEVEL)
        KeSetEvent(&amp;event1,<SPAN class=code-digit>0</SPAN>,<SPAN class=code-digit>0</SPAN>);

    <SPAN class=code-comment>//</SPAN><SPAN class=code-comment>store all relevant information in the Storage structure
</SPAN>    _asm mov ebpptr,ebp
    storptr-<SPAN class=code-keyword>&gt;</SPAN>retaddress=(*retaddessptr);
    storptr-<SPAN class=code-keyword>&gt;</SPAN>ptr=reloc;
    storptr-<SPAN class=code-keyword>&gt;</SPAN>prevEBP=ebpptr[<SPAN class=code-digit>0</SPAN>];

    <SPAN class=code-comment>//</SPAN><SPAN class=code-comment>modify the CPU stack
</SPAN>    relocptr[<SPAN class=code-digit>0</SPAN>]=functionarray[reloc-<SPAN class=code-keyword>&gt;</SPAN>function];
    retaddessptr[<SPAN class=code-digit>0</SPAN>]=(DWORD)&amp;retbuff;
    ebpptr[<SPAN class=code-digit>0</SPAN>]=(DWORD)storptr;

}</PRE>
      <P>As a first step, <CODE>Prolog()</CODE> locates the first available 
      <CODE>Storage</CODE> structure in <CODE>storagearray</CODE> table, and 
      sets its <CODE>isfree</CODE> field to 100, i.e. marks it as having been 
      occupied. We have to synchronize this operation, so we wait on 
      synchronization event that has been initialized in 
      <CODE>DriverEntry()</CODE> (<CODE>DriverEntry()</CODE> initializes two 
      synchronization events and fills the <CODE>retbuff</CODE> array with the 
      instructions that call <CODE>ProxyEpilog()</CODE>, i.e. does pretty much 
      the same things as <CODE>DllMain()</CODE> in the previous article). Once 
      we are about to wait until our event is set to the signaled state, i.e. 
      possibly for non-zero interval, we must make sure that we do it if and 
      only if current IRQL is below the <CODE>DISPATCH_LEVEL</CODE>. We also 
      have to make sure that this operation does not get interrupted, so we 
      disable interrupts by clearing <CODE>IF</CODE> flag. Once we must 
      re-enable them as quickly as possible, the code that locates the first 
      available <CODE>Storage</CODE> structure is written in pure assembly.</P>
      <P>Then we store all relevant information in the <CODE>Storage</CODE> 
      structure. This includes the original return address, the value pointed to 
      by <CODE lang=asm>EBP</CODE> register, and the pointer to 
      <CODE>RelocatedFunction</CODE> structure. Finally, we modify the CPU stack 
      the way we did it in the previous article, and write the pointer to the 
      <CODE>Storage</CODE> structure to the location, pointed to by <CODE 
      lang=asm>EBP</CODE> register, i.e., one stack entry above 
      <CODE>Prolog()</CODE>'s return address.</P>
      <P>Now, let's look at <CODE>Epilog()</CODE>:</P><PRE lang=mc++><SPAN class=code-keyword>void</SPAN>  <SPAN class=code-keyword>__stdcall</SPAN> Epilog(DWORD*retvalptr)
{

    DWORD *ebpptr;
    DWORD*retaddessptr=retvalptr+1;DWORD retval=retvalptr[<SPAN class=code-digit>0</SPAN>];
    Storage*storptr;RelocatedFunction * reloc;
    DWORD i,a,b,pos,n;    KIRQL irql;


    <SPAN class=code-comment>//</SPAN><SPAN class=code-comment> get the pointer to the Storage structure
</SPAN>    _asm mov ebpptr,ebp
    storptr=(Storage*)ebpptr[<SPAN class=code-digit>0</SPAN>];

    reloc=(RelocatedFunction*)storptr-<SPAN class=code-keyword>&gt;</SPAN>ptr;

    <SPAN class=code-comment>//</SPAN><SPAN class=code-comment>modify the CPU stack
</SPAN>    retaddessptr[<SPAN class=code-digit>0</SPAN>]=storptr-<SPAN class=code-keyword>&gt;</SPAN>retaddress;
    ebpptr[<SPAN class=code-digit>0</SPAN>]=storptr-<SPAN class=code-keyword>&gt;</SPAN>prevEBP;

    <SPAN class=code-comment>//</SPAN><SPAN class=code-comment> mark the Storage structure as free
</SPAN>    storptr-<SPAN class=code-keyword>&gt;</SPAN>isfree=0;

    <SPAN class=code-keyword>if</SPAN> (!ishooking)
        <SPAN class=code-keyword>return</SPAN>;

    <SPAN class=code-comment>//</SPAN><SPAN class=code-comment> now we are going to send data to
</SPAN>    <SPAN class=code-comment>//</SPAN><SPAN class=code-comment> the controller application:
</SPAN>    irql=KeGetCurrentIrql();
    <SPAN class=code-keyword>if</SPAN>(irql<SPAN class=code-keyword>&lt;</SPAN>DISPATCH_LEVEL)
        KeWaitForSingleObject(&amp;event2,Executive,
        KernelMode,<SPAN class=code-digit>0</SPAN>,<SPAN class=code-digit>0</SPAN>);

_asm{
cli
mov ebx,userstructptr
mov ecx,dword ptr[ebx]
mov a,ecx
add ecx,<SPAN class=code-digit>32</SPAN>
cmp ecx,<SPAN class=code-digit>4096</SPAN>
jl skip
sub ecx,<SPAN class=code-digit>4096</SPAN>
skip: mov pos,ecx
mov dword ptr[ebx],ecx

mov ebx,userbuffptr
add ebx,ecx
add ebx,<SPAN class=code-digit>6</SPAN>

mov edx,userbuff
add edx,ecx
mov dword ptr[ebx],edx
sti
}

    <SPAN class=code-keyword>if</SPAN>(irql<SPAN class=code-keyword>&lt;</SPAN>DISPATCH_LEVEL)
        KeSetEvent(&amp;event2,<SPAN class=code-digit>0</SPAN>,<SPAN class=code-digit>0</SPAN>);


    <SPAN class=code-comment>//</SPAN><SPAN class=code-comment> keep on filling the array with machine codes
</SPAN>
    <SPAN class=code-comment>//</SPAN><SPAN class=code-comment> instructions to spin 
</SPAN>    userbuffptr[pos]=0xFF;userbuffptr[pos+1]=0x25;
    i=userbuff+pos+6;
    memmove(&amp;userbuffptr[pos+2],&amp;i,<SPAN class=code-digit>4</SPAN>);

    <SPAN class=code-comment>//</SPAN><SPAN class=code-comment> instructions to push arguments
</SPAN>    userbuffptr[pos+10]=0x68;
    memmove(&amp;userbuffptr[pos+11],&amp;reloc-<SPAN class=code-keyword>&gt;</SPAN>function,<SPAN class=code-digit>4</SPAN>);
    userbuffptr[pos+15]=0x68;
    memmove(&amp;userbuffptr[pos+16],&amp;retval,<SPAN class=code-digit>4</SPAN>);
    userbuffptr[pos+20]=0x68;i=userbuff+pos;
    memmove(&amp;userbuffptr[pos+21],&amp;i,<SPAN class=code-digit>4</SPAN>);

    <SPAN class=code-comment>//</SPAN><SPAN class=code-comment>instruction to jump to the target function
</SPAN>    userbuffptr[pos+25]=0xFF;
    userbuffptr[pos+26]=0x25;i=userstruct+4;
    memmove(&amp;userbuffptr[pos+27],&amp;i,<SPAN class=code-digit>4</SPAN>);

    <SPAN class=code-comment>//</SPAN><SPAN class=code-comment>finally, schedule the target function for execution
</SPAN>    i=userbuff+pos+10;
    memmove(&amp;userbuffptr[a+6],&amp;i,<SPAN class=code-digit>4</SPAN>);
}</PRE>
      <P><CODE>Epilog()</CODE> gets the pointer to the <CODE>Storage</CODE> 
      structure from the location pointed to by <CODE lang=asm>EBP</CODE> 
      register, obtains the original return address and the original value of 
      <CODE lang=asm>EBP</CODE> from this structure, and modifies the CPU stack 
      - it stores the original value of <CODE lang=asm>EBP</CODE> one stack 
      entry above its return address, and replaces the address to which 
      <CODE>ProxyEpilog()</CODE> would otherwise return control, with the 
      original return address. Then sets the <CODE>isfree</CODE> field of the 
      <CODE>Storage</CODE> structure to 0, i.e. marks it as free. Finally, it 
      informs the controller application that the given API function has 
      returned, and sends it the return value of this function. The way it is 
      being done requires a little bit more attention.</P>
      <P>We schedule the thread, which runs in the controller application's 
      process, for asynchronous execution of the target function, by writing the 
      machine codes to the pool the way it was explained in introduction. First 
      of all, we need to get the current value of offset index in order to find 
      the address of the chunk where we are going to write data, to write the 
      address of this chunk (as it is known to the controller application) 6 
      bytes above its beginning, and to update the value of offset index. We 
      must synchronize this operation, and make sure that it does not get 
      interrupted. Therefore, we wait until the synchronization event is set to 
      the signaled state (certainly, if and only if current IRQL is below the 
      <CODE>DISPATCH_LEVEL</CODE>), and then disable interrupts. Once we must 
      re-enable them as quickly as possible, the code that executes the above 
      tasks is, again, written in pure assembly.</P>
      <P>After having accomplished the above, we must fill the remaining part of 
      the chunk with handcrafted instructions to push the index of real callee's 
      address in <CODE>functionarray</CODE> table (which is available from 
      <CODE>RelocatedFunction</CODE> structure, pointer to which was saved in 
      <CODE>Storage</CODE> structure), the real callee's return value, and the 
      address of the current chunk (as it is known to the controller 
      application), on the stack, and then to jump to the logging function. At 
      this point, we already don't have to worry about either interrupts or 
      context switches - the concurrent threads are already unable to overwrite 
      our data anyway. Therefore, before proceeding to the above task, we 
      re-enable interrupts and set the synchronization event to the signaled 
      state, so that other threads don't need to wait until we finish filling 
      the chunk with the machine codes. Once the remaining part of the job is 
      not so time-critical, we can afford to do it in C, rather than 
      assembly.</P>
      <P>Finally, we schedule the logging function, which resides in 
      controller's application address space, for execution, by writing the 
      address of the current chunk's 10th byte (as it is known to the controller 
      application) 6 bytes above the address of the previous chunk.</P>
      <P>As a result, when the logging function starts execution, it will 
      receive the index of real callee's address in <CODE>functionarray</CODE> 
      table and its return value as parameters. Once the 
      <CODE>functionbuff</CODE> table in controller application's address space 
      stores names of functions imported by target driver, in the same order as 
      <CODE>functionarray</CODE> table in kernel address space stores their 
      addresses, the former parameter is sufficient for locating the name of the 
      real callee. Therefore, the logging function formats the null-terminated 
      string in the form <CODE>ApiFunctionXXX</CODE> - returned 
      <CODE>YYY</CODE>, and writes it to the log file.</P>
      <P>As you can see, kernel-mode spying is a not so terribly complex task, 
      although it makes us worry about things we don't even have to know about 
      when spying in user-mode. The funniest thing is that this model is 
      suitable for user-mode spying as well. Therefore, the source code, 
      provided with this article, applies to my previous article as well.</P>
      <P>In order to run the sample application, you have to copy the spying 
      driver into the <I>C://WINNT/system32/drivers</I> directory. And to create 
      an on-demand-start service, it can be done either manually, or with the 
      following lines:</P><PRE land="mc++">SC_HANDLE manager=OpenSCManager(<SPAN class=code-digit>0</SPAN>,<SPAN class=code-digit>0</SPAN>,SC_MANAGER_ALL_ACCESS);
CreateService(manager,<SPAN class=code-string>"</SPAN><SPAN class=code-string>spyservice"</SPAN>,<SPAN class=code-string>"</SPAN><SPAN class=code-string>spyservice"</SPAN>, 
   SERVICE_START|SERVICE_STOP,SERVICE_KERNEL_DRIVER,
   SERVICE_DEMAND_START,SERVICE_ERROR_NORMAL,
   <SPAN class=code-string>"</SPAN><SPAN class=code-string>C://WINNT/system32/drivers/spydriver.sys"</SPAN>,<SPAN class=code-digit>0</SPAN>,<SPAN class=code-digit>0</SPAN>,<SPAN class=code-digit>0</SPAN>,<SPAN class=code-digit>0</SPAN>,<SPAN class=code-digit>0</SPAN>);</PRE>
      <P>You must manually start the spying service by typing <I>net start 
      spyservice</I> line on the command prompt before running the application. 
      Click on <I>Start</I> button in the <I>Spy</I> menu, choose the driver you 
      want to spy on, relax for a while, and then either click on <I>Stop 
      </I>button, or just close the program. After that, you can open the log 
      file in the text editor, and examine its contents.</P>
      <P><B>Warning:</B> The spying driver has been built by Windows 2000 DDK, 
      and tested on Windows 2000. I really don't know what happens if you run it 
      on any other NT platform - it is your task to find it out. If it does not 
      work, you can always rebuild the spying driver for your platform - the 
      source code would not need any modifications for sure.</P>
      <P>Furthermore, I would not advise you to hook <I>Ntfs.sys</I> with this 
      sample. I still have to figure out why it happens, but if you try to hook 
      <I>Ntfs.sys</I>, the system starts slowing down, stops responding pretty 
      shortly, and, finally, goes off after a while. This is not an issue when 
      hooking all other drivers. I tried to hook keyboard and mouse class 
      drivers, i8042prt, atapi, disk, CDROM, floppy, videoport and display - it 
      works fine everywhere. I think that all problems with <I>Ntfs.sys</I> 
      arise because, once our spying code synchronizes all calls that are made 
      by different threads in different systems and user processes, the system 
      cannot cope with the resulting slowdown - in case of <I>Ntfs.sys</I>, some 
      of these calls are made by system threads of high priority, but our spying 
      code currently does not take priority into the account. Probably, we 
      should also take the priority of the calling thread into the account when 
      we synchronize calls and disable interrupts. However, this is only the 
      suggestion - I am not yet in a position to make a definite conclusion 
      (otherwise, instead of speaking about this problem, I would just fix it, 
      wouldn't I?)</P>
      <P>I would highly appreciate if you send me an e-mail with your comments 
      and suggestions.</P>
      <H2>Conclusion</H2>
      <P>In conclusion, I must say that, although we are able to hook the API 
      calls that are made by both user-mode modules and kernel-mode drivers, our 
      exploration of Windows is far from being over. Would not it be interesting 
      to hook the calls that are made by the system <B>to</B> the target driver? 
      It is obvious that the system has to store the addresses of all functions 
      exported by the driver, in some kind of service table, so that it can call 
      the driver. Therefore, we have to locate this table somehow.</P>
      <P>Furthermore, even our process-wide API spying is far from being 
      complete - we can hook only the old-fashioned functional API. Would not it 
      be interesting to spy on COM interfaces as well? In the forthcoming 
      articles, we will try to do the above mentioned things.</P><!-- Article Ends --><!-- Main Page Contents End --></DIV></SPAN>
      <H2>License</H2>
      <P>This article has no explicit license attached to it but may contain 
      usage terms in the article text or the download files themselves. If in 
      doubt please contact the author via the discussion board below.</P>
      <P>A list of licenses authors might use can be found <A 
      href="http://www.codeproject.com/info/Licenses.aspx">here</A></P>
      <H2>About the Author</H2>
      <TABLE cellSpacing=5 cellPadding=0 width="100%" border=0>
        <TBODY>
        <TR vAlign=top>
          <TD id=ctl00_AboutAuthorRptr_ctl00_AboutAuthor_memberPhotoTable 
          style="WIDTH: 155px" vAlign=top><B><A 
            id=ctl00_AboutAuthorRptr_ctl00_AboutAuthor_memberProfileLink 
            href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=846502">Anton 
            Bassov</A></B><BR><BR>
            <CENTER></CENTER><BR><SPAN class=SmallText 
            id=ctl00_AboutAuthorRptr_ctl00_AboutAuthor_memberType></SPAN></TD>
          <TD><BR>
            <TABLE>
              <TBODY>
              <TR id=ctl00_AboutAuthorRptr_ctl00_AboutAuthor_jobTitleRow>
                <TD class=SmallText noWrap>Occupation: </TD>
                <TD width="100%"><SPAN class=SmallText 
                  id=ctl00_AboutAuthorRptr_ctl00_AboutAuthor_memberJobTitle>Web 
                  Developer</SPAN></TD></TR>
              <TR id=ctl00_AboutAuthorRptr_ctl00_AboutAuthor_locationRow>
                <TD class=SmallText>Location: </TD>
                <TD width="100%"><SPAN class=SmallText 
                  id=ctl00_AboutAuthorRptr_ctl00_AboutAuthor_memberLocation><IMG 
                  height=11 alt=Luxembourg 
                  src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/LU.gif" 
                  width=16> 
      Luxembourg</SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE><BR>
      <TABLE id=ctl00_PopularArticlesRow cellSpacing=0 cellPadding=0 
      width="100%" border=0>
        <TBODY>
        <TR vAlign=top>
          <TD style="WIDTH: 100%">
            <H2>Other popular Hardware &amp; System articles:</H2>
            <UL>
              <LI><A 
              href="http://www.codeproject.com/KB/system/xyntservice.aspx">Start 
              Your Windows Programs From An NT Service</A>
              <DIV class=SmallText>Make your MFC, VB and other Windows programs 
              behave like NT services.</DIV>
              <LI><A 
              href="http://www.codeproject.com/KB/system/serial.aspx">Serial 
              library for C++</A>
              <DIV class=SmallText>A high-performance, complete and compact 
              serial library for C++</DIV>
              <LI><A 
              href="http://www.codeproject.com/KB/system/hooksys.aspx">API 
              hooking revealed</A>
              <DIV class=SmallText>The article demonstrates how to build a user 
              mode Win32 API spying system</DIV>
              <LI><A 
              href="http://www.codeproject.com/KB/system/driverdev.aspx">Driver 
              Development Part 1: Introduction to Drivers</A>
              <DIV class=SmallText>This article will go into the basics of 
              creating a simple driver.</DIV>
              <LI><A 
              href="http://www.codeproject.com/KB/system/NoDeleteDelay.aspx">Eliminating 
              Explorer's delay when deleting an in-use file</A>
              <DIV class=SmallText>How to track down and patch an annoyance in 
              Windows Explorer's code.</DIV></LI></UL>
            <H2></H2></TD>
          <TD><IFRAME 
            src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\ServeHTML(1).htm" 
            frameBorder=0 width=300 scrolling=no 
        height=250></IFRAME></TD></TR></TBODY></TABLE>
      <DIV id=ctl00_AddTo style="MARGIN: 10px">
      <SCRIPT language=JavaScript type=text/javascript>
			var addtoMethod=1;
			var AddURL = document.location.href;
			var AddTitle = escape(document.title);
			DrawLinks(100, 0, "SmallText Bold", "AddTo") 
			</SCRIPT>
      </DIV>
      <TABLE class=RatingBar id=ctl00_RateArticleRow cellSpacing=0 cellPadding=0 
      width="100%" border=0>
        <TBODY>
        <TR>
          <TD><A 
            href="http://www.codeproject.com/KB/system/kernelspying.aspx#_top">Article 
            Top</A></TD>
          <TD align=right>
            <FORM id=aspnetForm 
            style="PADDING-RIGHT: 0px; PADDING-LEFT: 0px; PADDING-BOTTOM: 0px; MARGIN: 0px; PADDING-TOP: 0px" 
            name=aspnetForm action=kernelspying.aspx method=post>
            <DIV><INPUT id=__VIEWSTATE type=hidden 
            value=/wEPDwULLTEwMDUyNjYzMjhkZNEzpWyIjMgWPR7MsjcZahsiQ05g 
            name=__VIEWSTATE> </DIV>
            <TABLE cellSpacing=0 cellPadding=0 width="100%">
              <TBODY>
              <TR>
                <TD class=SmallText style="WHITE-SPACE: nowrap" align=right>
                  <TABLE>
                    <TBODY>
                    <TR>
                      <TD id=ctl00_RateArticle_RateText 
                      style="PADDING-RIGHT: 5px"><I><B>Rate this Article for 
                        us!</B></I></TD>
                      <TD id=ctl00_RateArticle_StartForm 
                        align=right><I>&nbsp;&nbsp;Poor</I></TD>
                      <TD id=ctl00_RateArticle_VoteFormDiv 
                      style="WHITE-SPACE: nowrap" align=left>
                        <TABLE id=ctl00_RateArticle_VoteRBL border=0>
                          <TBODY>
                          <TR>
                            <TD><INPUT id=ctl00_RateArticle_VoteRBL_0 
                              type=radio value=1 
                            name=ctl00$RateArticle$VoteRBL></TD>
                            <TD><INPUT id=ctl00_RateArticle_VoteRBL_1 
                              type=radio value=2 
                            name=ctl00$RateArticle$VoteRBL></TD>
                            <TD><INPUT id=ctl00_RateArticle_VoteRBL_2 
                              type=radio value=3 
                            name=ctl00$RateArticle$VoteRBL></TD>
                            <TD><INPUT id=ctl00_RateArticle_VoteRBL_3 
                              type=radio value=4 
                            name=ctl00$RateArticle$VoteRBL></TD>
                            <TD><INPUT id=ctl00_RateArticle_VoteRBL_4 
                              type=radio value=5 
                            name=ctl00$RateArticle$VoteRBL></TD></TR></TBODY></TABLE></TD>
                      <TD id=ctl00_RateArticle_EndForm 
                        align=left><I>Excellent</I> <INPUT class=FormButton id=ctl00_RateArticle_SubmitRateBtn type=submit value=Vote name=ctl00$RateArticle$SubmitRateBtn> 
                      </TD>
                      <TD><SPAN 
                    id=ctl00_RateArticle_ErrorMessage></SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE>
            <DIV><INPUT id=__EVENTVALIDATION type=hidden 
            value=/wEWCAKr99ipCALAlMXDBwLBlMXDBwLClMXDBwLDlMXDBwLElMXDBwLP+++tCwK5upDkC0pXZ6OAiNfeW3VgRrbb/RyvKaeb 
            name=__EVENTVALIDATION> </DIV></FORM></TD></TR></TBODY></TABLE>
      <DIV 
      style="PADDING-RIGHT: 10px; PADDING-LEFT: 10px; PADDING-BOTTOM: 10px; OVERFLOW: hidden; PADDING-TOP: 10px; WHITE-SPACE: nowrap; TEXT-ALIGN: center"><IFRAME 
      src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\ServeHTML(2).htm" 
      frameBorder=0 width=468 scrolling=no height=60></IFRAME><IFRAME 
      src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/ServeLinks.htm" 
      frameBorder=0 width=300 scrolling=no height=60></IFRAME></DIV><A 
      name=_comments></A><!-- Forum Start -->
      <DIV id=_MessageBoard onclick="return SwitchMessage(event, null)">
      <TABLE class=Frm_MainTable id=ForumTable cellSpacing=0 cellPadding=0>
        <FORM 
        action=/script/Forums/SetOptions.aspx?floc=%2fKB%2fsystem%2fkernelspying.aspx&amp;fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick 
        method=get>
        <TBODY>
        <TR>
          <TD><INPUT type=hidden value=38657 name=fid><INPUT type=hidden 
            value=?floc=%2fKB%2fsystem%2fkernelspying.aspx&amp;fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick 
            name=currentQS><INPUT type=hidden value=/KB/system/kernelspying.aspx 
            name=floc>
            <TABLE cellSpacing=0 cellPadding=3 width="100%" border=0>
              <TBODY>
              <TR class=Frm_HeaderRow1>
                <TD style="WHITE-SPACE: nowrap"><IMG height=16 
                  src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/forum_faq.gif" 
                  width=16 align=absMiddle border=0>&nbsp;<A 
                  href="http://www.codeproject.com/script/Forums/FAQ.aspx"><B>FAQ</B></A>&nbsp;</TD>
                <TD style="WHITE-SPACE: nowrap; TEXT-ALIGN: right">Noise 
                  Tolerance<SELECT class=Frm_DropDown size=1 name=noise> 
                    <OPTION value=1>Very High</OPTION><OPTION 
                    value=2>High</OPTION><OPTION value=3 
                    selected>Medium</OPTION><OPTION value=4>Low</OPTION><OPTION 
                    value=5>Very Low</OPTION></SELECT></TD>
                <TD style="WHITE-SPACE: nowrap; TEXT-ALIGN: right" 
                  colSpan=2><IMG height=15 
                  src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/forum_search.gif" 
                  width=16 align=absMiddle border=0>&nbsp;<A 
                  href="http://www.codeproject.com/script/Forums/Search.aspx?fid=38657">Search 
                  comments</A>&nbsp;</TD>
                <TD style="TEXT-ALIGN: right"><INPUT class=Frm_Button type=submit value="Set Options" name=submit></TD></TR>
              <TR class=Frm_HeaderRow2>
                <TD style="WIDTH: 100%">&nbsp;</TD>
                <TD 
                  style="WHITE-SPACE: nowrap; TEXT-ALIGN: right">Layout<SELECT 
                  class=Frm_DropDown size=1 name=view> <OPTION value=Quick 
                    selected>Normal</OPTION><OPTION value=Topic>Expand Root 
                    Messages</OPTION><OPTION value=Expanded>Expand All 
                    Messages</OPTION><OPTION value=Thread>Thread 
                    View</OPTION><OPTION value=Normal>No Javascript 
                    (slow)</OPTION><OPTION value=Preview>No Javascript 
                    Preview</OPTION></SELECT>&nbsp;&nbsp;</TD>
                <TD style="WHITE-SPACE: nowrap">Per page<SELECT 
                  class=Frm_DropDown size=1 name=mpp> <OPTION 
                    value=10>10</OPTION><OPTION value=25 
                    selected>25</OPTION><OPTION 
                  value=50>50</OPTION></SELECT>&nbsp;&nbsp;</TD>
                <TD colSpan=2>&nbsp;</TD></TR></TBODY></TABLE></TD></TR></FORM>
        <TR>
          <TD><A name=xx0xx></A>
            <TABLE cellSpacing=0 cellPadding=2 width="100%" border=0>
              <TBODY>
              <TR class=Frm_NavigationBar>
                <TD><IMG height=16 
                  src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/forum_newmsg.gif" 
                  width=16 align=top border=0><A class=Frm_HL 
                  title="Create a new message thread" 
                  href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;floc=/KB/system/kernelspying.aspx" 
                  target=_top name=Frm_HoverNL><B>New Message</B></A></TD>
                <TD>Msgs 1 to 25 of 57 (Total in Forum: 57) (<A 
                  href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick">Refresh</A>)</TD>
                <TD style="WHITE-SPACE: nowrap; TEXT-ALIGN: right"><SPAN 
                  class=Frm_HL>First</SPAN><SPAN class=Frm_HL>Prev</SPAN><A 
                  class=Frm_HL 
                  href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;fr=26#xx0xx" 
                  name=Frm_HoverNL>Next</A></TD></TR></TBODY></TABLE></TD></TR>
        <TR>
          <TD><!-- Column Headers -->
            <TABLE class=Frm_MsgTable cellSpacing=0 cellPadding=0 width="100%" 
            border=0>
              <TBODY>
              <TR class=Frm_ColumnHeaders>
                <TD style="WIDTH: 100%">
                  <TABLE cellSpacing=0 cellPadding=2 width="100%" border=0>
                    <TBODY>
                    <TR>
                      <TD>Subject&nbsp;</TD>
                      <TD class=Frm_MsgAuthor>&nbsp;Author&nbsp;</TD>
                      <TD 
              class=Frm_MsgDate>Date&nbsp;</TD></TR></TBODY></TABLE></TD></TR>
              <TR>
                <TD><IMG height=5 
                  src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\t(1).gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd LoVote Rt HdUnSel " id=1321791_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=16><A 
                        name=xx1321791xx></A><IMG height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_general.gif" 
                        width=16 valign="absmiddle"></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;select=1321791#xx1321791xx" 
                        name=1321791>HookAPI - WriteProcessMemory</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=1810219">Vitoto</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">12:16 1 
                        Jan '06 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=1321791_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 16px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Hi man, is posible using API Hook 
                                intercept any program using API 
                                WriteProcessMemory where in parameters use PID 
                                the my Game Program ?<BR><BR>I know PID the Game 
                                when launch from my code.<BR>Thank 
                                you.<BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: top">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1321791&amp;floc=/KB/system/kernelspying.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1321791&amp;floc=/KB/system/kernelspying.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;sort=Position&amp;tid=1321791">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=38657&amp;msg=1321791">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=1321791&amp;obtid=3">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF1321791 
                                style="WHITE-SPACE: nowrap">2.00/5 (2 votes)
                                <SCRIPT language=Javascript 
type=text/javascript>
												MsgVoteForm(1810219,1321791);
											</SCRIPT>
                                 
                        </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgRtDivide><IMG height=1 
                  src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\t(1).gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd Rt HdUnSel " id=1299859_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=16><A 
                        name=xx1299859xx></A><IMG height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_general.gif" 
                        width=16 valign="absmiddle"></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;select=1299859#xx1299859xx" 
                        name=1299859>prevent files I/O to USB disk driver</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=155213">hoangchau</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">23:28 7 
                        Dec '05 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=1299859_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 16px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>I don't want people copy files 
                                from my computer to USB driver, but can user 
                                that port for mouse and other device. So how i 
                                can do that??? <BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: top">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1299859&amp;floc=/KB/system/kernelspying.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1299859&amp;floc=/KB/system/kernelspying.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;sort=Position&amp;tid=1299859">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=38657&amp;msg=1299859">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=1299859&amp;obtid=3">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF1299859 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT language=Javascript 
type=text/javascript>
												MsgVoteForm(155213,1299859);
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgRtDivide><IMG height=1 
                  src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\t(1).gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd LoVote Rt HdUnSel " id=1289257_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=16><A 
                        name=xx1289257xx></A><IMG height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_general.gif" 
                        width=16 valign="absmiddle"></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;select=1289257#xx1289257xx" 
                        name=1289257>PE Graphical Area Access?</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=2207884">IslamianFalcon</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">23:56 
                        24 Nov '05 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=1289257_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 16px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Hello,<BR>anybody guide me about 
                                how to access the Portable Executable (PE) 
                                graphical area. plz also tell me it is possible 
                                or not?<BR>i want to access the PE graphical 
                                area that is going to display at screen.... 
                                <BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: top">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1289257&amp;floc=/KB/system/kernelspying.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1289257&amp;floc=/KB/system/kernelspying.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;sort=Position&amp;tid=1289257">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=38657&amp;msg=1289257">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=1289257&amp;obtid=3">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF1289257 
                                style="WHITE-SPACE: nowrap">2.00/5 (2 votes)
                                <SCRIPT language=Javascript 
type=text/javascript>
												MsgVoteForm(2207884,1289257);
											</SCRIPT>
                                 
                        </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 
                  src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\t(1).gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd LoVote HdUnSel " id=1296775_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=34><A 
                        name=xx1296775xx></A><IMG height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_general.gif" 
                        width=16 valign="absmiddle"></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;select=1296775#xx1296775xx" 
                        name=1296775>Re: PE Graphical Area Access?</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=484240">Vertexwahn</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">0:42 5 
                        Dec '05 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=1296775_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 34px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>A PE is a file format. It doesn't 
                                have a graphical area. I think what you want is 
                                to capture the screen - am i right? if so: its 
                                possible! All you have to do is to listen to 
                                BitBlt, CopyRect &amp; CO <BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: top">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1296775&amp;floc=/KB/system/kernelspying.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1296775&amp;floc=/KB/system/kernelspying.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;sort=Position&amp;tid=1289257">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=38657&amp;msg=1296775">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=1296775&amp;obtid=3">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF1296775 
                                style="WHITE-SPACE: nowrap">2.00/5 (1 vote)
                                <SCRIPT language=Javascript 
type=text/javascript>
												MsgVoteForm(484240,1296775);
											</SCRIPT>
                                 
                        </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 
                  src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\t(1).gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd LoVote HdUnSel " id=1297640_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=52><A 
                        name=xx1297640xx></A><IMG height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_general.gif" 
                        width=16 valign="absmiddle"></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;select=1297640#xx1297640xx" 
                        name=1297640>Re: PE Graphical Area Access?</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=2207884">IslamianFalcon</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">23:30 5 
                        Dec '05 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=1297640_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 52px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Dear,<BR>ya, u r right, but i want 
                                to capture the screen even it is out of focus or 
                                minimized, is it possible? plz explain a 
                                bit....<BR>Regards,<BR>Shahbaz Atta 
                                <BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: top">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1297640&amp;floc=/KB/system/kernelspying.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1297640&amp;floc=/KB/system/kernelspying.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;sort=Position&amp;tid=1289257">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=38657&amp;msg=1297640">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=1297640&amp;obtid=3">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF1297640 
                                style="WHITE-SPACE: nowrap">2.00/5 (1 vote)
                                <SCRIPT language=Javascript 
type=text/javascript>
												MsgVoteForm(2207884,1297640);
											</SCRIPT>
                                 
                        </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgRtDivide><IMG height=1 
                  src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\t(1).gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd Rt HdUnSel " id=1257406_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=16><A 
                        name=xx1257406xx></A><IMG height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_general.gif" 
                        width=16 valign="absmiddle"></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;select=1257406#xx1257406xx" 
                        name=1257406>This code vs your other code...</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        height=15 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/usersuss.gif" 
                        width=14></TD>
                      <TD class=Frm_MsgAuthor>Anonymous</TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">20:47 
                        18 Oct '05 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=1257406_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 16px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>What do mean that you can use this 
                                articles code and use for process-wide spying 
                                instead of the code in your process-wide 
                                article.<BR><BR>1. Is this code more superior to 
                                your other code?<BR><BR>1. What changes will 
                                need to be made to this code to spy on user-mode 
                                processes?<BR><BR>2. Can the spying functions 
                                like prevent stuff to happen eg.?? 
<BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: top">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1257406&amp;floc=/KB/system/kernelspying.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1257406&amp;floc=/KB/system/kernelspying.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;sort=Position&amp;tid=1257406">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=38657&amp;msg=1257406">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=1257406&amp;obtid=3">Bookmark</A></TD>
                                <TD class=Frm_MsgFt style="TEXT-ALIGN: right"><A 
                                class=Frm_MHL 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1257406&amp;floc=/KB/system/kernelspying.aspx&amp;fa=m">Edit</A>·<A 
                                class=Frm_MHL 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1257406&amp;floc=/KB/system/kernelspying.aspx&amp;fa=d">Delete</A><BR><SPAN 
                                id=MVF1257406 style="WHITE-SPACE: nowrap">
                                <SCRIPT language=Javascript 
type=text/javascript>
												MsgVoteForm(0,1257406);
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgRtDivide><IMG height=1 
                  src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\t(1).gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd Rt HdUnSel " id=1235511_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=16><A 
                        name=xx1235511xx></A><IMG height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_general.gif" 
                        width=16 valign="absmiddle"></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;select=1235511#xx1235511xx" 
                        name=1235511>Map</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=2301827">luolody</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">23:49 
                        23 Sep '05 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=1235511_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 16px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>how to map a physical address to 
                                virtual address under the ms windows 
                                98<BR>tk<IMG 
                                src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/smiley_smile.gif" 
                                align=absMiddle> <BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: top">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1235511&amp;floc=/KB/system/kernelspying.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1235511&amp;floc=/KB/system/kernelspying.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;sort=Position&amp;tid=1235511">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=38657&amp;msg=1235511">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=1235511&amp;obtid=3">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF1235511 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT language=Javascript 
type=text/javascript>
												MsgVoteForm(2301827,1235511);
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 
                  src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\t(1).gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=1235749_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=34><A 
                        name=xx1235749xx></A><IMG height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_general.gif" 
                        width=16 valign="absmiddle"></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;select=1235749#xx1235749xx" 
                        name=1235749>Re: Map</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=846502">Anton 
                        Bassov</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">10:05 
                        24 Sep '05 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=1235749_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 34px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Hi mate<BR><BR>Unfortunately, I 
                                dont work with Windows 9x, and,hence, I am just 
                                not in a position to say anything about 
                                it.<BR><BR>Therefore, cannot help you with your 
                                question<BR><BR>Sorry <BR><BR>Anton 
                                <BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: top">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1235749&amp;floc=/KB/system/kernelspying.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1235749&amp;floc=/KB/system/kernelspying.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;sort=Position&amp;tid=1235511">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=38657&amp;msg=1235749">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=1235749&amp;obtid=3">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF1235749 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT language=Javascript 
type=text/javascript>
												MsgVoteForm(846502,1235749);
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgRtDivide><IMG height=1 
                  src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\t(1).gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd Rt HdUnSel " id=1186793_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=16><A 
                        name=xx1186793xx></A><IMG height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_general.gif" 
                        width=16 valign="absmiddle"></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;select=1186793#xx1186793xx" 
                        name=1186793>kernell mode keylogger</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=1474746">Kristof 
                        VB</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">6:58 6 
                        Aug '05 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=1186793_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 16px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Hi,<BR>for a project i need to 
                                make a driver using the windows DDK.<BR>I 
                                allready have it so that's not the problem. But 
                                for my project i want to make a keylogger using 
                                a keyboardfilterdriver. Since i just started 
                                getting into driver programming, i was wondering 
                                if you could get me started with this keylogger 
                                thing.<BR>Thank you in advance for your 
                                help,<BR>Kristof <BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: top">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1186793&amp;floc=/KB/system/kernelspying.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1186793&amp;floc=/KB/system/kernelspying.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;sort=Position&amp;tid=1186793">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=38657&amp;msg=1186793">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=1186793&amp;obtid=3">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF1186793 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT language=Javascript 
type=text/javascript>
												MsgVoteForm(1474746,1186793);
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 
                  src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\t(1).gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=1187519_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=34><A 
                        name=xx1187519xx></A><IMG height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_general.gif" 
                        width=16 valign="absmiddle"></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;select=1187519#xx1187519xx" 
                        name=1187519>Re: kernell mode keylogger</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=846502">Anton 
                        Bassov</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">15:46 7 
                        Aug '05 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=1187519_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 34px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Hi Kristof<BR><BR>I am sorry, but 
                                I've got to disappoint you - your project has no 
                                future. I spent quite a while on writing 
                                software that detects and neutralizes keyloggers 
                                you are about to write, and I did it upon the 
                                request of one of the world's major software 
                                makers. The punch line is that detection and 
                                neutralization happens at the run-time upon the 
                                user's request - even if your logger is the 
                                service that starts with the system boot, it 
                                will get detected and blocked, no matter at 
                                which level it operates. Therefore, you are 
                                about to waste your time on writing software 
                                that will not work properly<BR><BR>In other 
                                words, try to write something more constructive 
                                than 
keylogger<BR><BR>Anton<BR><BR><BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: top">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1187519&amp;floc=/KB/system/kernelspying.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1187519&amp;floc=/KB/system/kernelspying.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;sort=Position&amp;tid=1186793">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=38657&amp;msg=1187519">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=1187519&amp;obtid=3">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF1187519 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT language=Javascript 
type=text/javascript>
												MsgVoteForm(846502,1187519);
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 
                  src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\t(1).gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=1198872_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=52><A 
                        name=xx1198872xx></A><IMG height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_general.gif" 
                        width=16 valign="absmiddle"></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;select=1198872#xx1198872xx" 
                        name=1198872>Re: kernell mode keylogger</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=70598">geek</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">6:18 18 
                        Aug '05 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=1198872_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 52px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Hi Anton,<BR><BR>I would be more 
                                interested in knowing the details of your work. 
                                Please can you provide me with some pointers on 
                                this?. Also, i would like to know that, whether 
                                is it possible to bypass a filter driver in a 
                                driver stack?.<BR>Thanks for you 
                                inputs.<BR><BR>Regards,<BR>g33k <BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: top">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1198872&amp;floc=/KB/system/kernelspying.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1198872&amp;floc=/KB/system/kernelspying.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;sort=Position&amp;tid=1186793">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=38657&amp;msg=1198872">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=1198872&amp;obtid=3">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF1198872 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT language=Javascript 
type=text/javascript>
												MsgVoteForm(70598,1198872);
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 
                  src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\t(1).gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=1198927_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=70><A 
                        name=xx1198927xx></A><IMG height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_general.gif" 
                        width=16 valign="absmiddle"></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;select=1198927#xx1198927xx" 
                        name=1198927>Re: kernell mode keylogger</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=846502">Anton 
                        Bassov</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">7:03 18 
                        Aug '05 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=1198927_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 70px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Hi Mate<BR><BR>It is possible to 
                                bypass the filter driver. However, I cannot 
                                provide you with the details of my work - this 
                                is a confidential information which I am not 
                                authorized to give away. If I do it, my client 
                                is not going to be happy at all - after all, 
                                they paid me quite a lot of money for my work, 
                                so that now intellectual ownership of the 
                                project belongs to 
                                them<BR><BR>Anton<BR><BR><BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: top">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1198927&amp;floc=/KB/system/kernelspying.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1198927&amp;floc=/KB/system/kernelspying.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;sort=Position&amp;tid=1186793">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=38657&amp;msg=1198927">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=1198927&amp;obtid=3">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF1198927 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT language=Javascript 
type=text/javascript>
												MsgVoteForm(846502,1198927);
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 
                  src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\t(1).gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=1285999_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=88><A 
                        name=xx1285999xx></A><IMG height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_general.gif" 
                        width=16 valign="absmiddle"></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;select=1285999#xx1285999xx" 
                        name=1285999>Re: kernell mode keylogger</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=2464407">Medus</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">12:24 
                        21 Nov '05 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=1285999_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 88px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Unfortunately, Anton Bassov's work 
                                is unlikely to prevent kernel-mode keylogging. 
                                I'm fairly certain it won't prevent reading of 
                                the BIOSes buffer. Some of the best work in this 
                                field I've seen in a certain popular crypto 
                                program and some upcoming home-banking 
                                clients.<BR><BR>Unfortunately, neither actually 
                                worked against anything but common 'by the book' 
                                keylogging : )<BR><BR>Whilst I understand 
                                Bassov's reluctance to encourage anything that 
                                may undermine his work, I would suggest 
                                wholeheartedly that the poster continues 
                                studying kernel-mode techniques... as it may be 
                                Bassov's work which proves to be 
                                'pointless'.<BR><BR>As a coder of true HAL 
                                rootkits I know for certain that Bassovs work 
                                would not have a hope in hell of stopping my 
                                clients reading systemwide keystrokes, 
                                regardless of how low he sits his filter. In 
                                fact, I've yet to see ANY such venture even 
                                fully cover the basics ... they tend to be all 
                                hype and no bite (With respect to Anton and his 
                                work, which I cannot be certain I have 
                                encountered unless he wishes to name a product) 
                                In a similar fashion, I cannot name a single 
                                hardware firewall that can detect the low level 
                                comms library I use although all make grand 
                                claims.<BR><BR><BR>I'd like to encourage the 
                                poster to continue in his endeavours as this 
                                race has NOT, as Anton seems to suggest, been 
                                won already. Indeed, it's not even 
                                begun.<BR><BR>-M@dus<BR><BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: top">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1285999&amp;floc=/KB/system/kernelspying.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1285999&amp;floc=/KB/system/kernelspying.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;sort=Position&amp;tid=1186793">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=38657&amp;msg=1285999">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=1285999&amp;obtid=3">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF1285999 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT language=Javascript 
type=text/javascript>
												MsgVoteForm(2464407,1285999);
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 
                  src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\t(1).gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=1286063_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=106><A 
                        name=xx1286063xx></A><IMG height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_general.gif" 
                        width=16 valign="absmiddle"></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;select=1286063#xx1286063xx" 
                        name=1286063>Re: kernell mode keylogger</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=846502">Anton 
                        Bassov</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">14:07 
                        21 Nov '05 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=1286063_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 106px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Hi mate<BR><BR>Could you please 
                                provide me with some sample (if you have any). 
                                As you say, my work would never prevent your 
                                clients from reading all keystrokes on 
                                system-wide basis. Apparently, you must be 
                                somehow able to read data BEFORE(!!!) keyboard 
                                interrupt gets raised. My software hooks kbd 
                                interrupt, reads scan code from the port (this 
                                task is normally supposed to be done by 
                                i8042prt.sys),removes it from the 
                                buffer,translates it into a virtual key, and, 
                                via some manipulations, injects it into keyboard 
                                input queue (this task is normally supposed to 
                                be done by kbdclass.sys).<BR>In other words, 
                                execution never reaches either 8042prt.sys or 
                                kbdclass.sys. <BR><BR>Therefore, if you want to 
                                read the keystroke, you have to do it 
                                BEFORE(!!!) keyboard interrupt gets raised. 
                                Judging from your tone, you must know a way of 
                                doing it. In fact, I would not get surprized if, 
                                as a "coder of true HAL rootkits" you manage to 
                                read the keystroke even before the key gets 
                                pressed <BR><BR>Regards<BR><BR>Anton 
                                <BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: top">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1286063&amp;floc=/KB/system/kernelspying.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1286063&amp;floc=/KB/system/kernelspying.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;sort=Position&amp;tid=1186793">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=38657&amp;msg=1286063">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=1286063&amp;obtid=3">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF1286063 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT language=Javascript 
type=text/javascript>
												MsgVoteForm(846502,1286063);
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 
                  src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\t(1).gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=1286912_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=116><A 
                        name=xx1286912xx></A><IMG height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_general.gif" 
                        width=16 valign="absmiddle"></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;select=1286912#xx1286912xx" 
                        name=1286912>Re: kernell mode keylogger</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=2464407">Medus</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">14:18 
                        22 Nov '05 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=1286912_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 116px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>&gt;Hi mate<BR>&gt;<BR>&gt;Could 
                                you please provide me with some sample (if you 
                                have any). As you say, my work would never 
                                prevent your clients from reading all keystrokes 
                                on a system-wide basis. Apparently, you must be 
                                somehow able to read data BEFORE(!!!) keyboard 
                                interrupt gets raised. My software hooks kbd 
                                interrupt, reads scan code from the port (this 
                                task is normally supposed to be done by 
                                i8042prt.sys),removes it from the 
                                buffer,translates it into a virtual key, and, 
                                via some manipulations, injects it into keyboard 
                                input queue (this task is normally supposed to 
                                be done by kbdclass.sys).<BR>&gt;In other words, 
                                execution never reaches either 8042prt.sys or 
                                kbdclass.sys.<BR><BR>You seem to think that by 
                                reading 'directly' from the 'port' upon 
                                'interrupt' that you're sitting on the hardware 
                                .... right ? Hence your certainty. Of course, 
                                thats not the case - You're sitting on an 
                                abstraction ... one of the many possibly HAL 
                                layers chosen dependent on architecture. You 
                                therefore must have faith in the integrity of 
                                the abstraction. Much as most sysadmins trust 
                                implicitly the integrity of IOS firmware and 
                                bootblock on their routers. The problem with 
                                this is when you hit a professional low-level 
                                tool. And, if you're on the russian scene you 
                                may well be aware of the fine work one group in 
                                particular has done in this area.<BR><BR>Now, 
                                why would someone want to sit in the HAL? 
                                Considering the complexity of the task and the 
                                fact that you appear to lose the comfort of 
                                drivers. Well, its part of a much bigger 
                                picture. (sidenote: In actual fact you can 
                                actually still leverage the usefulness of vendor 
                                drivers, without calling them in situ. Its 
                                messy, but we've had some successes with that 
                                before we switched to 
                                profiling)<BR><BR><BR>Firstly, you'll note the 
                                efforts made recently by firewall vendors. Some 
                                of whom have become quite aggressive in their 
                                monitoring of both the driver (and protocol) 
                                stacks. Bad news for conventional rootkits, no? 
                                Its become increasingly difficult to create 
                                unknown 'sockets' by getting in below the 
                                firewall hook. Fortunately, with very few vendor 
                                protocol differences one can actually profile 
                                the NIC from the actual (not abstracted) port 
                                data... and then, once profiled, inject packets. 
                                We also get to see and remove packets before 
                                they even get to the NDIS ... which renders all 
                                commercial firewall software ineffective. And, 
                                as usual, hardware walls can be similarly 
                                part-profiled by examining remote port/ip of 
                                successful TCP handshakes, although currently we 
                                don't do this. Essentially, HAL gets us in - 
                                even below the NDIS. The result? No software 
                                wall currently detects our kits.<BR><BR>But feel 
                                free to dismiss this as 
                                Voodoo.<BR><BR>Keystrokes are a no-brainer in 
                                comparison... and yes, they WILL be picked up 
                                before your code gets thrown 
                                interrupt.<BR><BR>The problem is, no commercial 
                                software protection is going to want to get this 
                                dirty. Even if you did, you prolly ain't going 
                                to find it marketable - particularly given the 
                                relatively low-sophistication of publicly 
                                available rootkits and loggers. After all, the 
                                market chases the 'percieved threat' and 
                                currently thats predominantly 
                                gutter-code.<BR><BR><BR>&gt;Therefore, if you 
                                want to read the keystroke, you have to do it 
                                BEFORE(!!!) keyboard interrupt gets raised. 
                                Judging from your tone, you must know a way of 
                                doing it.<BR>&gt;In fact, I would not get 
                                surprized if, as a "coder of true HAL rootkits" 
                                you manage to read the keystroke even before the 
                                key gets pressed<BR><BR>You laugh, thats funny. 
                                Actually, we CAN get the key before the mobo 
                                without something as obvious as a barrel-logger. 
                                Or don't you rate hacked keyboards?... I wrote a 
                                PIC solution for keyboard-embedded logging with 
                                timed RF data-bursting. I drive past and aim my 
                                VAGI at the site... My handheld synchronises and 
                                tells me when the bugs next databurst is 
                                scheduled so I dont hang around looking 
                                suspicious... And then I can drop by as my 
                                counter hits zero to get all the keystrokes from 
                                the system. You can laugh again... And I'll 
                                point you to a site with a 4-part article 
                                outlining the schematics, firmware and various 
                                build options.<BR><BR>Essentially, its the 
                                ultimate keylogger because it will survive 
                                complete reformatting, visual inspection, and 
                                even stands a good chance of defeating a 
                                professional RF bugsweep due to its bursty 
                                nature (Which can be anything from hourly to 
                                weekly)<BR><BR>Whilst thats not a fair attack on 
                                your software, as it's not designed to thwart 
                                hardware-based logging, it's still a great 
                                example of how the 'book' on security is sadly 
                                lacking ... most admins are blissfully aware of 
                                such a possibility - which is precisely why they 
                                are so valuable in corporate espionage... moreso 
                                infact, than software loggers and 
                                rootkits.<BR><BR>But you're right - I ain't 
                                omniscient. How very clever of you notice : 
                                )<BR><BR><BR>Sorry no, I ain't throwing out any 
                                example code. But if you need a demonstration of 
                                a rootkit that will undoubtedly foil your keying 
                                safeguards, then I'd be happy to oblige you 
                                privately at a Con of your choice (within 
                                reason). I'll even show you what you can do 
                                about it - but I garauntee your clients won't 
                                like the solution - and you can definately 
                                forget the possibility microsoft logo 
                                certification : )<BR><BR><BR>What we do is NOT 
                                mainsteam.<BR><BR>In fact, we even build 
                                clip-over FPGA based devices for bugging network 
                                printers that rebroadcast on freq-shifted Wi-Fi 
                                giving us 'private spectrum' (Not exactly FCC 
                                approved, but WTH) - And we can use Selective 
                                Call Intercept boxes placed an the CP to get 
                                into a site to plant them too : ) .... for 
                                example, you position a low-wage phone-monkey 
                                who at some point nail-varnishes the jack... 
                                Despite the IT dept lasers are always an outside 
                                job... so, they make the call, it's diverted at 
                                the CP (either via DECT to a van, or by circuit 
                                from the CP) and we run a DTMF-driven soundboard 
                                to simulated the expected Call-Steering... Thats 
                                how we get our 'engineer' invited through the 
                                door, given a visitor pass and allowed to open 
                                and inspect the printer. The device is Then, not 
                                only do we have all your contracts, proposals, 
                                etc... but if we placed a 2-way then we also 
                                have a node on your LAN too. A parabolic on one 
                                side can often get a 1km link (If we lifted the 
                                FCC limiter on the 802.11 module) even in 
                                'noisy' environments. For shielded buildings we 
                                can instead burst-reinject back through the 
                                local LAN as a poorer non-wireless 
                                solution.<BR><BR>So, from our POV 'security by 
                                the book' doesn't mean a great deal, nor does 
                                conventional approaches to ANY problem - 
                                including kernel-mode drivers as a security 
                                component. I hope you realise the great 
                                difference between a tiger-team and a 
                                script-monkey - like most security professionals 
                                you're possibly only aware of the latter 
                                threat.<BR><BR><BR>Just to fill you in - our 
                                group is international, corporate and 
                                distinctively grey-hatted. We perform everything 
                                from OSCOR sweeps and Hi-Res Time-Domain 
                                Reflectrometry of private circuits to Pen-Tests 
                                and full blackhat/tiger services. Our diverse 
                                and talented membership includes people with 
                                extensive SIG-INT experience. We're all mature - 
                                I myself, though now retired, have ASM 
                                experience far predating the Zilog80 and have 
                                designed and built a high-speed, ultra-low-cost, 
                                supercluster leveraging the high-parallelism and 
                                low-cost of FPGA's into a 
                                'flat-shared-everything cluster' which actually 
                                gives over 1000 times more bang-for-the-buck 
                                than a modern Cray SC or PC/SBC cluster in a 
                                semi-dedicated system... and can easily 
                                outperform one on many computing-tasks in a much 
                                smaller physical and logistical footprint (Once 
                                you take into account the Crays cooling and 
                                power supply requirements) - Feel free to laugh 
                                again, and again I can discuss details and post 
                                you various Cray specs for your own comparison. 
                                Because of this, we currently boast one of the 
                                most complete private rainbow-tables for NTLM/LM 
                                hashes.<BR><BR>Still want more Voodoo... 
                                ?<BR><BR>We also have a method of creating 
                                'undetectable' code - in that a *conventional* 
                                AV signature cannot be formed. Indeed, the type 
                                of dedicated detection engine required to detect 
                                our multipass obfuscation of the decryption 
                                header (The weak link in any encrypted malware) 
                                would take long enough to perform a scan to 
                                render it prohibitively slow if used systemwide 
                                - and certainly too slow for a filesystem scan. 
                                Again, you can call 'BS' on this... yet sophos 
                                have had an example of this code for over 5 
                                years now and, despite an annual prodding, it is 
                                YET to be detected in any AV product so forgive 
                                us if we feel we have the high-ground here 
                                too.<BR><BR>Now, you've had your laugh, 
                                in-fact... you're probably rolling around on the 
                                floor with tears running down your face - I'd 
                                now suggest you 'call me' on these points, I've 
                                certainly given you enough ammunition. But 
                                please don't continue to make fun of me unless 
                                you are similarly prepared to place your 
                                reputation on the line and your cards on the 
                                table. You can consider this a cordial 
                                invitation to a public peeing competition : 
                                )<BR><BR>(Oh, BTW, despite all the sarcastic 
                                jibes - I'd buy you a beer 
                                anytime)<BR><BR>&gt;Regards<BR>&gt;Anton<BR><BR>Apologies 
                                if I sound a bit sharp - But telling someone to 
                                give up cus they don't stand a chance always 
                                gets me fired up : ) Its arrogant, impolite and 
                                is very much against everything my group and I 
                                stand for. Making sarcastic comments certainly 
                                doesn't help - and generally invites more of the 
                                same.<BR><BR>Your article here is to be 
                                applauded. There is precious little information 
                                out there for those wishing to learn to code 
                                below userspace on M$ boxes... and this is 
                                undoubtedly a fine example. But your arrogance 
                                in shooting down the original poster simply to 
                                bolster your work in that particular 
                                professional area is, I believe, a little 
                                off.<BR><BR>And THAT, Anton, is the point I 
                                tried to make earlier before things got heated : 
                                )<BR><BR>After all, despite how much you may 
                                detest rootkit and keylogger authors, its 
                                precisely people like myself and the OP that 
                                keep the IT security industry a billion-dollar 
                                baby at a time all the other IT disciplines are 
                                going through an economic slowdown. Indeed, many 
                                professionals have learned to feed from both 
                                ends.<BR><BR><BR>Best 
                                regards,<BR>-Medus<BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: top">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1286912&amp;floc=/KB/system/kernelspying.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1286912&amp;floc=/KB/system/kernelspying.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;sort=Position&amp;tid=1186793">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=38657&amp;msg=1286912">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=1286912&amp;obtid=3">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF1286912 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT language=Javascript 
type=text/javascript>
												MsgVoteForm(2464407,1286912);
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 
                  src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\t(1).gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=1287046_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=126><A 
                        name=xx1287046xx></A><IMG height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_general.gif" 
                        width=16 valign="absmiddle"></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;select=1287046#xx1287046xx" 
                        name=1287046>Re: kernell mode keylogger</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=846502">Anton 
                        Bassov</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">17:47 
                        22 Nov '05 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=1287046_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 126px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Hi mate<BR><BR>Looks like we are 
                                talking about quite different things - I am 
                                talking about kernel-mode keylogging, and you 
                                seem to be talking about placing rootkits in 
                                microcontrollers, i.e. hardware rootkits that 
                                can survive system reinstallation, as well as 
                                hard-disk format. I am afraid that this topic, 
                                although EXTREMELY(!!!)interesting, has nothing 
                                to do with actual Windows kernel-mode 
                                programming<BR><BR>Now look at the question that 
                                has started off our debate - the bloke asks how 
                                to write a kernel-mode filter driver in order to 
                                record keystrokes. This is why I told him that 
                                his logger has no chance. Concerning detection 
                                of hardware rootkits, I am afraid my software is 
                                out of luck,I admit.<BR>I am really glad that 
                                you mentioned them - you offered me really 
                                exciting puzzle which I will try to 
                                solve.<BR><BR>Concerning the rest of your 
                                message..... to be honest, I do not like your 
                                pathetic and ridiculous show-off. For example, 
                                what is the point of mentioning Cray 
                                supercomputers on Windows forum??? <BR><BR>Now 
                                let's look at your other statements. On one 
                                hand,<BR>"I hope you realise the great 
                                difference between a tiger-team and a 
                                script-monkey..."; "... no commercial software 
                                protection is going to want to get this 
                                dirty.... After all, the market chases the 
                                'percieved threat' and currently thats 
                                predominantly gutter-code." On the other hand, 
                                "Sorry no, I ain't throwing out any example 
                                code..." Are you 100% sure you've got one, 
                                matie??? Me neither<BR><BR>Let's face it - this 
                                site is supposed to be the place where<BR>people 
                                can share their code and ideas with other 
                                people. If you really want to prove your point, 
                                you can write an article about hardware rootkits 
                                - I will be just delighted to give you 5. 
                                Otherwise, you just make a fool out of yourself 
                                - you make huge claims, critisize the whole IT 
                                security inductry, as well as writers of 
                                publicly available rootkits.... without posting 
                                a single line of code<BR><BR>BTW, could you 
                                please "point me to a site with a 4-part article 
                                outlining the schematics, firmware and various 
                                build options" - I just love stuff like that. 
                                You said that you can do it, but somehow failed 
                                to mention the 
                                link<BR><BR>Regards<BR><BR>Anton<BR><BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: top">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1287046&amp;floc=/KB/system/kernelspying.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1287046&amp;floc=/KB/system/kernelspying.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;sort=Position&amp;tid=1186793">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=38657&amp;msg=1287046">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=1287046&amp;obtid=3">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF1287046 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT language=Javascript 
type=text/javascript>
												MsgVoteForm(846502,1287046);
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 
                  src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\t(1).gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=1287755_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=136><A 
                        name=xx1287755xx></A><IMG height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_general.gif" 
                        width=16 valign="absmiddle"></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;select=1287755#xx1287755xx" 
                        name=1287755>Re: kernell mode keylogger</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=2464407">Medus</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">9:05 23 
                        Nov '05 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=1287755_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 136px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>&gt; Looks like we are talking 
                                about quite different things - I am talking 
                                about kernel-mode<BR>&gt; keylogging, and you 
                                seem to be talking about placing rootkits in 
                                microcontrollers, i.e.<BR>&gt; hardware rootkits 
                                that can survive system reinstallation, as well 
                                as hard-disk format.<BR>&gt; I am afraid that 
                                this topic, although EXTREMELY(!!!)interesting, 
                                has nothing to do with<BR>&gt; actual Windows 
                                kernel-mode programming<BR><BR>No, you made a 
                                sarcastic comment about me being able to read 
                                the key before it was even pressed - So, for 
                                making fun of me I decided to open your eyes a 
                                little. A gift. Me to you.<BR><BR>But, as I 
                                originally said, I have a rootkit (software) 
                                that WILL bypass your protection. I can say this 
                                because I write HAL rootkits (Something else you 
                                laughed at me about). Usermode coders rely on 
                                the OS as a Trusted Base .... And Driver coders 
                                rely on the abstractions below them. You DONT 
                                talk directly to hardware... Your PORT and 
                                REGISTER operations go through the HAL - So 
                                where the hell is your safetynet when the HAL 
                                ain't friendly ? Native calls ? Nope!<BR><BR>Try 
                                to think in terms of what occurs when the 
                                driverspace uses platform abstractions such as 
                                READ_PORT_xxx/WRITE_PORT_xxx/READ_REGISTER_xxx/WRITE_REGISTER_xxx 
                                to communicate with the hardware. HAL converts 
                                this to the appropriate CPU PORT operations (Or 
                                the standard memory LOAD/STORE 'indirect' 
                                operations if the CPU doesn't support the native 
                                port ops) - In this sense the kernel and the 
                                drivers sit on a comfortable abstraction of the 
                                hardware. Now, since this abstraction is 
                                implimented in SOFTWARE - a HAL-Based rootkit 
                                can read, write and delay these operations as 
                                long as it does so carefully. This allows us 
                                complete control over such things as the 
                                injection and interception of NIC data below 
                                even an NDIS wrapper firewall hook (Or even a 
                                vendor-driver-embedded firewall hook) ... And, 
                                despite the Apparent Voodoo, its quite simple to 
                                profile the NICs BUS location and vendor 
                                protocol owing to the limited categories and 
                                manufacturers of NIC chipsets.<BR><BR>I know 
                                this because I come from an embedded systems 
                                background and frequently have to make do 
                                WITHOUT drivers... instead, coding FPGAs in 
                                VHDL/Verilog to form hardware-specific ASICs to 
                                handle the task. So, in that sense subverting 
                                the HAL is actually a richer and more flexible 
                                playground than I'm used to. Unlike platform 
                                drivers it really is ONE layer above the onboard 
                                hardware. And IMO theres no way your code is 
                                going to get underneath this, particularly since 
                                the exposed HAL interface you see on an infected 
                                system is just a mock-up. Also, protective 
                                software is unlikely to attempt anthing so 
                                dangerously invasive in the foreseeable future - 
                                not while vendors have liability concerns and 
                                clients require platform certification and 
                                driver signing.<BR><BR>You can consider that the 
                                natives found through KiSystemService are also 
                                compromised and associated Ki-structures in 
                                phymem are compromised too. And, just to top it 
                                all off, if the kit wants to run a ring-3 
                                process you're NOT going to find it without 
                                exhaustive manual examination... even if you 
                                walk the PsActiveProcessHead's _EPROCESS APL 
                                structures in physical memory our process simply 
                                isn't there (Most conventional rootkits are 
                                spotted this way, but then, they normally rely 
                                on tampering the APIs to simply filter 
                                returns)<BR><BR>So, as you can see - I'm talking 
                                about a SOFTWARE wall that pulls your Trusted 
                                Computing Base out from under your feet. Just as 
                                a kernel-mode coder can pull the rug out from 
                                under a userland app.<BR><BR>The reason you 
                                think I'm talking about hardware is that you 
                                seem unable to seperate what I said about 
                                'hacked keyboards' and my comments about HAL 
                                rootkits ... You appear to think theres nothing 
                                below your kernel code except the hardware 
                                itself which, as I point out, is a little 
                                silly.<BR><BR>&gt; Now look at the question that 
                                has started off our debate - the bloke asks how 
                                to write a kernel-mode filter driver in order to 
                                record keystrokes. This is why I told him that 
                                his logger has no chance.<BR><BR>Lets assume you 
                                are right (and you ain't)<BR>- Does every PC 
                                have your wonderous code installed, protecting 
                                all apps systemwide ? No!<BR>- Does it protect 
                                all apps, or just a single app like PGP or a 
                                Sharedealing client? Prolly not!<BR>- So, Will 
                                his keylogging efforts work on the majority of 
                                systems? Yep!<BR>- Will they work against the 
                                majority of Apps, despite your code protecting 
                                others? Yep!<BR>- Will it be a great learning 
                                experience for the poster, and one that he 
                                should be encouraged to pursue ? I think 
                                so.<BR><BR>I don't see your problem, unless its 
                                a moral objection. Still, it has no place in 
                                academia - if this guy wants to understand the 
                                anatomy of a keylogger who are we to discourage 
                                him ? If he wants to join the eternal battle 
                                between good'n'evil then fine. People grow, and 
                                its fair to say that some of the best defenders 
                                started out as crackers.<BR><BR>&gt; Concerning 
                                detection of hardware rootkits, I am afraid my 
                                software is out of luck,I admit.<BR><BR>No such 
                                thing as a hardware rootkit. The others are 
                                essentially databugging systems designed for 
                                embedding in 
                                keyboards/routers-consoles/terminals etc... or 
                                ethernet taps to be places in the HCC, Wiring 
                                closet or inside networked devices such as 
                                LaserPrinters. Hell, one of the best places is 
                                dangling from the jack inside a cavity wall. But 
                                rootkits? No! Unless by hardware you are 
                                referring to firmware - anyway, its of little 
                                importance.<BR><BR>I mention them in response to 
                                your dismissive attitude and flippant remarks 
                                about my apparent omniscience. You made a 
                                comment and you got a rise out of me. And yes, I 
                                should know better - so should you : 
                                )<BR><BR>&gt; I am really glad that you 
                                mentioned them - you offered me really exciting 
                                puzzle which I<BR>&gt; will try to 
                                solve.<BR>&gt;<BR>&gt; Concerning the rest of 
                                your message..... to be honest, I do not like 
                                your pathetic and<BR>&gt; ridiculous show-off. 
                                For example, what is the point of mentioning 
                                Cray supercomputers on<BR>&gt; Windows 
                                forum???<BR><BR>You seemed to prefer to make fun 
                                of me. I've deliberately given you all the 
                                ammunition you want if that IS your aim. If you 
                                don't believe me on any of this, please call me 
                                out - And I'll publicly prove you wrong. Don't 
                                just snigger behind your hand like a little kid, 
                                it doesn't suit you.<BR><BR>&gt; Now let's look 
                                at your other statements. On one hand,<BR>&gt; 
                                "I hope you realise the great difference between 
                                a tiger-team and a script-monkey...";<BR>&gt; 
                                "... no commercial software protection is going 
                                to want to get this dirty.... After all,<BR>&gt; 
                                the market chases the 'percieved threat' and 
                                currently thats predominantly 
                                gutter-code."<BR>&gt; On the other hand, "Sorry 
                                no, I ain't throwing out any example code..." 
                                Are you 100% sure<BR>&gt; you've got one, 
                                matie??? Me neither<BR><BR>Like I said, I'll 
                                quite happily let you install your product on 
                                one of my machines at a Con of your choice... 
                                And from another I will tell you everything you 
                                type to your protected app. No trick KBs, no 
                                tricked out BIOS.... I'll show you how, why and 
                                what you can do about it.<BR><BR>But code, you 
                                ain't getting. Its not just mine, its a 
                                collaborative effort and it has much diminished 
                                value to us if revealed. We're a closed-code 
                                group. I notice that your claims that the 
                                original poster should give up before he even 
                                starts because you got keylogging completely 
                                solved didn't come with code either - a 
                                situation which I completely understand. Since 
                                you are obviously aware of the need to protect 
                                proprietary methods you really have no excuse to 
                                use this against me. Personally I wouldn't even 
                                reveal this particular code under a strict 
                                NDA.<BR><BR>&gt; Let's face it - this site is 
                                supposed to be the place where people can 
                                share<BR>&gt; their code and ideas with other 
                                people. If you really want to prove your 
                                point,<BR>&gt; you can write an article about 
                                hardware rootkits - I will be just delighted 
                                to<BR>&gt; give you 5. Otherwise, you just make 
                                a fool out of yourself - you make huge<BR>&gt; 
                                claims, critisize the whole IT security 
                                inductry, as well as writers of publicly<BR>&gt; 
                                available rootkits.... without posting a single 
                                line of code<BR><BR>And you told the original 
                                poster not to bother coding because you've sewn 
                                up the whole 'keylogging' problem in your latest 
                                and greatest gift to the industry (code unseen). 
                                I'm telling you that you are wrong, that an 
                                existing rootkit can demonstrate this, and I'm 
                                quite willing to show you.<BR><BR>Most 
                                Blackhatter groups DO NOT publish their malware 
                                till they have something better... I think 
                                you'll find that all rootkits are pretty old 
                                news by the time they go public. Thats not just 
                                my view, its pretty much how the scene goes. 
                                Unreleased tools and exploits are far more 
                                useful than the brief ego-boost of publishing. 
                                So, you only publish when you have something 
                                better. Same is true of exploits.<BR><BR>&gt; 
                                BTW, could you please "point me to a site with a 
                                4-part article outlining the schematics<BR>&gt; 
                                firmware and various build options" - I just 
                                love stuff like that. You said that you 
                                can<BR>&gt; do it, but somehow failed to mention 
                                the link<BR><BR>OK, Here you 
                                go:<BR>http://www.security-forums.com/forum/viewtopic.php?t=18949<BR>And, 
                                the same framework, applied 
                                differently...<BR>http://www.security-forums.com/forum/viewtopic.php?t=24676<BR><BR>Now, 
                                is there anything else you'd like to call me out 
                                on ? Or are you just going to snigger behind 
                                your hand some more ? Anton, you got my offer. 
                                We both have code to protect - But I'll give you 
                                proof of the concept and show you how and why it 
                                works.<BR><BR>Personally, I'd like to think 
                                theres not much could be done to get under it or 
                                detect it whilst the system is running, short of 
                                snapshotting phymem and physically working 
                                through the code. But then, you might have other 
                                ideas and I'd be very happy to hear them - I 
                                don't consider our rootkit (as proud as we are 
                                of it) to be the ultimate answer either, 
                                everything evolves.<BR><BR>You have my respect 
                                as a coder - But don't ridicule me unless you're 
                                committed enough to put your own reputation on 
                                the line with it. You're telling people not to 
                                climb because you already conquered the 
                                mountain. Well, whats wrong with letting the new 
                                guy see how far he can take the concept 
                                ?<BR><BR>But telling people not to bother 
                                because you've already solved the problem. Its 
                                crass, arrogant and almost always completely 
                                wrong. <BR><BR>&gt; Regards<BR>&gt;<BR>&gt; 
                                Anton<BR><BR>Now I really must apologise. I'm 
                                way off topic and certainly abusing the nature 
                                of this board... so unless you want to laugh, 
                                snigger, and tell me I don't have a clue what 
                                I'm talking about - and maintain that you've 
                                solved the great keylogging issue... then I 
                                won't write any more on the subject. I don't 
                                release code because its not in my interests, 
                                you don't release code because its not in your 
                                clients interests ... but if you want to arrange 
                                to hook up and see exactly what I'm talking 
                                about I will happily do that. We'll install your 
                                clients App and you can see the depth of my 
                                rootkit firsthand. Of course, I can't let you 
                                keep the drive afterwards : )<BR><BR>Mail me if 
                                you like and we can hook up, and I'll buy you 
                                that beer I mentioned. Or, if you want to tell 
                                me off - well, you can do that too : ) Also, if 
                                the original poster needs any help with K-Mode 
                                keylogging he can mail me and I'll be happy to 
                                help.<BR><BR>Best 
                                regards,<BR>-Medus<BR><BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: top">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1287755&amp;floc=/KB/system/kernelspying.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1287755&amp;floc=/KB/system/kernelspying.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;sort=Position&amp;tid=1186793">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=38657&amp;msg=1287755">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=1287755&amp;obtid=3">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF1287755 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT language=Javascript 
type=text/javascript>
												MsgVoteForm(2464407,1287755);
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 
                  src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\t(1).gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=1288107_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=146><A 
                        name=xx1288107xx></A><IMG height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_general.gif" 
                        width=16 valign="absmiddle"></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;select=1288107#xx1288107xx" 
                        name=1288107>Re: kernell mode keylogger</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=846502">Anton 
                        Bassov</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">15:22 
                        23 Nov '05 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=1288107_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 146px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Hi mate<BR><BR>That's it - this 
                                message finally revealed that you are full of 
                                shite. You have no idea what you are talking 
                                about, although you have a huge mouth. I am 
                                really sorry if it sounds rude - I hope that 
                                after having read this message you will 
                                understand my irritation with all your 
                                statements.<BR><BR><BR>First of all, yesterday I 
                                just did not really understand what you mean by 
                                saying that "all my code sits on top of HAL, so 
                                that it stands no chance against any advanced 
                                rootkit". Now I do - apparently, you believe 
                                that I never do anything "unsupported". You 
                                believe that I hook ISR which is implemented by 
                                i8042prt.sys, read data from the port by 
                                READ_PORT_UCHAR(),etc,etc,etc. This is not the 
                                case, believe me.<BR><BR>What I hook is 
                                interrupt handler, address of which is stored in 
                                IDT (this is just the stub that does not belong 
                                to any module - it just saves execution context 
                                of interrupted thread, and immediately transfers 
                                control to ntoskrnl.exe, which, in turn, calls 
                                ISR, which is implemented by i8042prt.sys). This 
                                is what I hook, and my hooking code does a good 
                                part of the work that is suppposed to be done by 
                                i8042prt.sys and kbdclass.sys. <BR><BR><BR>By 
                                the time execution reaches this system-provided 
                                stub, port is already empty, and data is already 
                                in keyboard input queue. As a result, when 
                                execution reaches ISR in i8042prt.sys, ISR tries 
                                to read data from the port, discovers that it is 
                                empty, and comes to the conclusion<BR>that 
                                interrupt has been raised by mistake. Therefore, 
                                it returns without doing anything. My code does 
                                not "sit on top of HAL", as you may think - it 
                                is 100% x86-specific (I even discover kbd 
                                interrupt vector directly from IOAPIC, rather 
                                than from KINTERRUPT object or from the 
                                registry).<BR><BR><BR>To summarize, in order to 
                                skip my software one has to read data from the 
                                port BEFORE(!!!) execution reaches interrupt 
                                handler, address of which I write to IDT. Are 
                                you able to do something like 
                                that????<BR><BR><BR><BR>I hope you already 
                                understand why I am so irritated with all your 
                                statements. Apparently, you believe that you are 
                                the only one who is that "bright", and IT 
                                security employs only morons who are unable to 
                                defeat anything but the most simplistic stuff. 
                                This is not the case, believe 
                                me<BR><BR><BR><BR>Your statement " there is no 
                                such thing as hardware rootkit" is just one more 
                                proof of your ignorance. For your further 
                                development, hardware rootkits exist - this is a 
                                brand-new type of rootkits that can survive 
                                system reinstall, as well as disk format. These 
                                rootkits overwrite BIOS, and save themselves in 
                                BIOS memory (the attacker needs<BR>to gain 
                                physical access to the target machine in order 
                                to install such rootkit - these rootkits are 
                                normally installed<BR>as BIOS upgrade). 
                                Designing ways of defeating such rootkits is a 
                                brand-new field of research for IT security 
                                industry, which you despise so much. To be 
                                honest, I thought that this is what you meant in 
                                your message of yesterday. However, as it turns 
                                out, you haven't got a slightest idea about the 
                                very existence of such rootkits.<BR><BR><BR>To 
                                summarize, I think you should change your 
                                attitudes to things and people - you seem to 
                                have a very low opinion on other people's 
                                skills, and to think of yourself as of some kind 
                                of mega-guru. I don't think you will ever get 
                                anywhere with such 
                                attitudes<BR><BR>Regards<BR><BR>Anton<BR><BR><BR><BR><BR><BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: top">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1288107&amp;floc=/KB/system/kernelspying.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1288107&amp;floc=/KB/system/kernelspying.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;sort=Position&amp;tid=1186793">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=38657&amp;msg=1288107">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=1288107&amp;obtid=3">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF1288107 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT language=Javascript 
type=text/javascript>
												MsgVoteForm(846502,1288107);
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 
                  src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\t(1).gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=1289131_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=156><A 
                        name=xx1289131xx></A><IMG height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_general.gif" 
                        width=16 valign="absmiddle"></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;select=1289131#xx1289131xx" 
                        name=1289131>Re: kernell mode keylogger</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=2464407">Medus</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">19:35 
                        24 Nov '05 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=1289131_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 156px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>&gt; Hi mate<BR>&gt;<BR>&gt; 
                                That's it - this message finally revealed that 
                                you are full of shite. You<BR>&gt; have no idea 
                                what you are talking about, although you have a 
                                huge mouth.<BR>&gt; I am really sorry if it 
                                sounds rude - I hope that after having read 
                                this<BR>&gt; message you will understand my 
                                irritation with all your statements.<BR><BR>I am 
                                opinionated and have a big mouth, thats true. 
                                But cussing is not the answer. I notice you have 
                                tacitly climbed down from your 'oh, surprising 
                                that you don't include a link' posture - is 
                                there anything else you'd like to call BS on? or 
                                is that your lot... cus I'm kinda dissappointed, 
                                I thought you were going to ridicule me more 
                                than you did... you were getting into such a 
                                great swing.<BR><BR>Now, if you've quite 
                                finished, lets move on...<BR><BR>&gt; First of 
                                all, yesterday I just did not really understand 
                                what you mean by<BR>&gt; saying that "all my 
                                code sits on top of HAL, so that it stands no 
                                chance<BR>&gt; against any advanced rootkit". 
                                Now I do - apparently, you believe that 
                                I<BR>&gt; never do anything "unsupported". You 
                                believe that I hook ISR which is<BR>&gt; 
                                implemented by i8042prt.sys, read data from the 
                                port by READ_PORT_UCHAR()<BR>&gt; ,etc,etc,etc. 
                                This is not the case, believe me.<BR><BR>No, I 
                                believe you bypass i8042prt.sys completely. You 
                                stated this quite clearly earlier...<BR><BR>&gt; 
                                What I hook is interrupt handler, address of 
                                which is stored in IDT (this<BR>&gt; is just the 
                                stub that does not belong to any module - it 
                                just saves execution<BR>&gt; context of 
                                interrupted thread, and immediately transfers 
                                control to ntoskrnl.exe,<BR>&gt; which, in turn, 
                                calls ISR, which is implemented by 
                                i8042prt.sys). This is what<BR>&gt; I hook, and 
                                my hooking code does a good part of the work 
                                that is suppposed to<BR>&gt; be done by 
                                i8042prt.sys and 
                                kbdclass.sys.<BR><BR>*sigh*<BR><BR>&gt; By the 
                                time execution reaches this system-provided 
                                stub, port is already empty,<BR>&gt; and data is 
                                already in keyboard input queue. As a result, 
                                when execution reaches<BR>&gt; ISR in 
                                i8042prt.sys, ISR tries to read data from the 
                                port, discovers that it is<BR>&gt; empty, and 
                                comes to the conclusion that interrupt has been 
                                raised by mistake.<BR>&gt; Therefore, it returns 
                                without doing anything. My code does not "sit on 
                                top of HAL",<BR>&gt; as you may think - it is 
                                100% x86-specific (I even discover kbd interrupt 
                                vector<BR>&gt; directly from IOAPIC, rather than 
                                from KINTERRUPT object or from the 
                                registry).<BR><BR>This clarifies things 
                                considerably, thank you. Whilst your approach is 
                                certainly stronger than most (And my hat is off 
                                to you there) we're both using IDT/VSR. Now, 
                                depending on the code one of us is likely to get 
                                unhooked. Our code is quite aggressive in how it 
                                maintains the IDT - so depending on your code 
                                you either cause an endless battle for the IDT 
                                -or- you're going to wind up in second 
                                place.<BR><BR>But regardless... You're not doing 
                                quite what you stated. You discouraged the OP 
                                from writing systemwide keyboard hooks because 
                                they didn't stand a chance ... I'm sorry, but I 
                                have to refer you to the points I raised in my 
                                last message regarding that statement. And also 
                                reiterate that you are quite wrong, you haven't 
                                solved the problem or damaged the effectiveness 
                                of systemwide hooks - you 'may' have prevented a 
                                single application from being intercepted - but 
                                thats not quite the same thing is it, and its 
                                certainly doesn't put you in a position to 
                                declare all keyboard hooking irrelevant and 
                                doomed to failure.<BR><BR>But anyway. Any chance 
                                you could throw in an advertising plug for your 
                                clients app ? I'd quite happily purchase it and 
                                see how it fares first hand <IMG 
                                src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/smiley_smile.gif" 
                                align=absMiddle><BR><BR>&gt; To summarize, in 
                                order to skip my software one has to read data 
                                from the port BEFORE(!!!)<BR>&gt; execution 
                                reaches interrupt handler, address of which I 
                                write to IDT. Are you able to do<BR>&gt; 
                                something like that????<BR><BR>I think we're 
                                going to see a fight for the IDT. Like I say, 
                                that depends on your code ... theres a chance 
                                you are not going to be able to install at all 
                                after the kit is in - it depends on how you're 
                                writing the IDT. Wether you'll STAY in depends 
                                on how aggressively you maintain 
                                it.<BR><BR>Still, you ain't quite convinced me 
                                that your code renders all systemwide keyboard 
                                hooking a worthless endeavour.<BR><BR>&gt; I 
                                hope you already understand why I am so 
                                irritated with all your statements. 
                                Apparently,<BR>&gt; you believe that you are the 
                                only one who is that "bright", and IT security 
                                employs only<BR>&gt; morons who are unable to 
                                defeat anything but the most simplistic stuff. 
                                This is not the<BR>&gt; case, believe 
                                me<BR><BR>No, I know a large number of VERY 
                                bright individuals on both sides of the security 
                                industry. And, I think most would agree that the 
                                'typical' state of 'secure' software is dire. As 
                                I said 'I have never seen your code 
                                but...'<BR><BR>&gt; Your statement " there is no 
                                such thing as hardware rootkit" is just one more 
                                proof of<BR>&gt; your ignorance. For your 
                                further development, hardware rootkits exist - 
                                this is a brand-new<BR>&gt; type of rootkits 
                                that can survive system reinstall, as well as 
                                disk format. These rootkits<BR>&gt; overwrite 
                                BIOS, and save themselves in BIOS 
                                memory<BR><BR>Again, you misread and misconstrue 
                                everything I say. I did EXPLICITLY exempt 
                                'firmware' from that category to save you such a 
                                mistake. But let me put it more bluntly - BIOS 
                                is FIRMWARE NOT HARDWARE.<BR><BR>Now, you've 
                                already 'called me out' once, and I obliged you 
                                - so let me do the same. Could you kindly point 
                                me to a 'hardware rootkit' ? Just post the link 
                                and I'll happily admit that I'm as ignorant as 
                                you maintain.<BR><BR>&gt; (the attacker needs to 
                                gain physical access to the target machine in 
                                order to install such<BR>&gt; rootkit - these 
                                rootkits are normally installed as BIOS 
                                upgrade).<BR><BR>Incorrect. Hacker 'may' require 
                                physical access. BIOS upgrading (and thus, 
                                infecting) is a software operation. The process 
                                SHOULD be inhibited by a jumper on the 
                                motherboard. Often the board is jumperless, 
                                sometimes the integrity of the update is 
                                protected by public-key crypto, sometimes the 
                                jumper is left in the wrong 
                                position...<BR><BR>And sometimes, with real 
                                mission critical equipment, there are no 
                                physical or cryptographic safeguards at all - 
                                such as the firmware in Cisco routers and 
                                switches. Although most professionals 
                                CCIE(Security)Certifications are unaware of 
                                this, you can compromise the IOS and BootBlock 
                                firmware and they don't have a hope in hell of 
                                finding it, the tools just ain't there... and 
                                you cannot very well take out the flash and 
                                perform an independent test. You have to rely on 
                                that same IOS telling the truth.<BR><BR>Now, you 
                                could think I'm being arrogant saying that Cisco 
                                security certified professionals don't have a 
                                clue... I've been CCIE(R&amp;S), I switched, and 
                                I now hold two CCIE specialisations, one being 
                                Security - So, I think I'm qualified to rate the 
                                certification.<BR><BR>You go on to say 
                                ...<BR><BR>&gt; Designing ways of defeating such 
                                rootkits is a brand-new field of research for IT 
                                security<BR>&gt; industry, which you despise so 
                                much.<BR><BR>As an GSE and CCIE(Security AND 
                                Voice) I think I qualify as being part of that 
                                set, don't you ? I don't despise it, I despise 
                                the laziness and box rhetoric that pervades the 
                                whole industry.<BR><BR>&gt; To be honest, I 
                                thought that this is what you meant in your 
                                message of yesterday. However,<BR>&gt; as it 
                                turns out, you haven't got a slightest idea 
                                about the very existence of such 
                                rootkits.<BR><BR>*sigh*<BR><BR>Actually, I do... 
                                And you are so wrong on so many counts that it 
                                actually beggars belief. For your information 
                                they are NOT new, They go right back to before 
                                the old cisco 2500 routers... Essentially, by 
                                flashing both the IOS and the BootBlock one 
                                could not only COMPLETELY own the router, but 
                                could even create virtual interfaces that were 
                                not visable from the console - You could even 
                                hop right through them (Despite any ACL's and 
                                routing information) and out of any interface of 
                                your choice with a whole new IP and MAC of your 
                                choosing. Upgrading the ISO would fail, except 
                                that the update screens and IOS version reported 
                                would appear to indicate success.<BR><BR>So 
                                we're talking about flash firmware dating back 
                                LONG before the user-flashable PC BIOS. Its NOT 
                                new at all ... and again, I know this far more 
                                intimately than you think. Most admins don't 
                                give the routing firmware a second thought - 
                                Check the Log, Check the running and startup 
                                configurations, everything fine! Occasionaly 
                                update the IOSVer ... <BR><BR>Still think 
                                remotely altering bootblocks, IOS firmware, BIOS 
                                firmware... or ANY code on FLASH/SRAM/Etc. is 
                                new? New? Its got flipping pedigree!<BR><BR>And 
                                if you want to restrict the argument to PC 
                                BIOSes only ... well, they've been being 
                                compromised since they first came out - and 
                                thats many many years ago now. moreso, because 
                                when they first came out many manufacturers 
                                didn't see the need for jumper 
                                protection.<BR><BR>&gt; To summarize, I think 
                                you should change your attitudes to things and 
                                people - you seem<BR>&gt; to have a very low 
                                opinion on other people's skills, and to think 
                                of yourself as of some<BR>&gt; kind of 
                                mega-guru. I don't think you will ever get 
                                anywhere with such attitudes<BR><BR>Maybe, I am 
                                certainly brash and outspoken - its been said of 
                                me many times before. I also freely admit that 
                                I'm NOT a people person and I lack tact and 
                                diplomacy more than most americans even. 
                                However, I've never consider telling someone NOT 
                                TO EVEN TRY because I'd written code which CURES 
                                the problem once and for all! Better people than 
                                either of us have said that, and been 
                                humbled.<BR><BR><BR>Of course, I HAVE gotten 
                                somewhere... I'm thirtysomething and retired. I 
                                wont bore you with my list of qualifications, or 
                                my excellent references on both sides of the 
                                security industry. I've moved from the UK and 
                                now live in Las Palmas de Gran Canaria with my 
                                beautiful spanish wife. <BR><BR>But yeah... 
                                you're right... I'm never going to get 
                                anywhere.<BR><BR>Personally, I think you owe the 
                                original poster an apology - but I won't hold my 
                                breath.<BR><BR><BR>&gt; Regards<BR>&gt;<BR>&gt; 
                                Anton<BR><BR>At this point I'm just going to 
                                back down and let you conclude unchallenged (as 
                                I'm being swallowed by a huge wave of apathy). 
                                feel free to make use of this opportunity to 
                                distort something I've said or to pass some 
                                comment about my dubious 
                                parentage.<BR><BR>You're convinced you're right. 
                                You're convinced I know nothing. You don't even 
                                seem to read what I say, or if you do, you 
                                deliberately distort it... it's not really worth 
                                continuing.<BR><BR>Damn, sure glad I didn't buy 
                                you that beer... bet you're a mean drunk : 
                                )<BR><BR><BR>Best 
                                wishes,<BR>-Medus<BR><BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: top">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1289131&amp;floc=/KB/system/kernelspying.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1289131&amp;floc=/KB/system/kernelspying.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;sort=Position&amp;tid=1186793">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=38657&amp;msg=1289131">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=1289131&amp;obtid=3">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF1289131 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT language=Javascript 
type=text/javascript>
												MsgVoteForm(2464407,1289131);
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 
                  src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\t(1).gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=1289252_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=161><A 
                        name=xx1289252xx></A><IMG height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_general.gif" 
                        width=16 valign="absmiddle"></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;select=1289252#xx1289252xx" 
                        name=1289252>Re: kernell mode keylogger</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=846502">Anton 
                        Bassov</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">23:39 
                        24 Nov '05 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=1289252_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 161px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Hi mate<BR><BR>For the first time 
                                ever you sound like someone with whom I can have 
                                a "civilized and orderly" discussion. First of 
                                all, I would like to apologize for my relatively 
                                harsh<BR>message of yesterday. In fact, I was 
                                just really annoyed<BR>by your attitudes - you 
                                were 100% sure that my software "sits on top of 
                                HAL", although you never had a chance to see it. 
                                How can someone make ANY(!!!) assumption about 
                                the internals of the program he has never 
                                seen???<BR><BR><BR>In fact, you have 
                                misinterpreted me - I never said that you don't 
                                know anything. The only thing I said is that you 
                                should not be so self-sure - in fact, ignorance 
                                and dismissive attitudes to other people's 
                                skills normally<BR>go hand in hand. After all, 
                                someone who does not want to listen to other 
                                people because he thinks that he knows 
                                everything is very unlikely to discover anything 
                                new for himself, don't you 
                                think???<BR><BR><BR>Now we are even, so let's 
                                proceed to our discussion. I am not going to 
                                take the piss out of you any more, but I still 
                                have to point you to something I disagree 
                                with.<BR><BR><BR><BR>&gt;And also reiterate that 
                                you are quite wrong, you haven't &gt;solved the 
                                problem or damaged the effectiveness of 
                                &gt;systemwide hooks - you 'may' have prevented 
                                a single &gt;application from being intercepted 
                                - but thats not quite &gt;the same thing is it, 
                                and its certainly doesn't put you in &gt;a 
                                position to declare all keyboard hooking 
                                irrelevant and &gt;doomed to 
                                failure.<BR><BR>Could you please explain this 
                                paragraph. On one hand you claim that your 
                                rootkit is able to record keystrokes on 
                                system-wide basis. On the other hand, you claim 
                                that my software is able to protect only some 
                                certain application.<BR>Where is the logic 
                                behind your statements??? You just don't seem to 
                                realize that my software is, esssentially, 
                                exactly the same thing as your rootkit. The only 
                                difference between them is that my software 
                                removes the scan code from the port(which gives 
                                my software the additional task of doing the job 
                                of both i8042prt.sys and kbdclass.sys, i.e. 
                                translating scan code into VK and inserting data 
                                into kbd input queue), while your rootkit puts 
                                it back, so that keystroke gets processed by the 
                                system in a way it is supposed to get processed. 
                                <BR><BR><BR>Now let's proceed to "hardware 
                                rootkits". If you don't mind, let me stick to 
                                this term, although, strictly speaking, it would 
                                be more appropriate to call them "firmware 
                                rootkits" or "embedded software rootkits". First 
                                of all, let's agree on the topic of our 
                                discussion.I am speaking ONLY (!!!)about PC - 
                                this is what I work with. I don't know ANYTHING 
                                (!!!) about Cisco routers and switches, so that 
                                you don't have to mention them.<BR><BR><BR><BR>I 
                                cannot point you to any hardware rootkit. As far 
                                as I am concerned, there is no publicly 
                                available hardware rootkit -this is why I say 
                                that this is brand-new development in the field 
                                of the IT security. Don't get me wrong - I am 
                                not speaking about compromising BIOS (this trick 
                                is not new)<BR>What I am speaking about is 
                                placing a ROOTKIT(!!!) into on-chip memory. 
                                Furthermore, although BIOS seems to be the most 
                                obvious target, theoretically rootkit may be 
                                placed into any programmable chip that has 
                                on-chip memory. <BR><BR>This is why I say that 
                                this is very new and complex topic -I hope there 
                                is no need to explain the difference between 
                                operating in stealth mode, i.e. the 
                                way<BR>rootkits are supposed to work, and making 
                                the machine unbootable. You mentioned "BIOS 
                                buffers" in your original poster, which made me 
                                believe that you claimed to be the author of 
                                such rootkit. This is why I took your statement 
                                with some certain degree of sceptisism, and 
                                asked you to post the code<BR><BR>In case if you 
                                have any idea in this field, I would be just 
                                delighted to hear from you - after all, you seem 
                                to know on-board stuff much better than I 
                                do<BR><BR>Regards<BR><BR>Anton 
                                <BR><BR><BR><BR><BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: top">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1289252&amp;floc=/KB/system/kernelspying.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1289252&amp;floc=/KB/system/kernelspying.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;sort=Position&amp;tid=1186793">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=38657&amp;msg=1289252">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=1289252&amp;obtid=3">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF1289252 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT language=Javascript 
type=text/javascript>
												MsgVoteForm(846502,1289252);
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 
                  src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\t(1).gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HiVote HdUnSel " id=1289595_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=166><A 
                        name=xx1289595xx></A><IMG height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_general.gif" 
                        width=16 valign="absmiddle"></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;select=1289595#xx1289595xx" 
                        name=1289595>Re: kernell mode keylogger</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=2464407">Medus</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">9:39 25 
                        Nov '05 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=1289595_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 166px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>&gt; Hi mate<BR>Hey<BR><BR>&gt; 
                                For the first time ever you sound like someone 
                                with whom I can have a "civilized and 
                                orderly"<BR>&gt; discussion. First of all, I 
                                would like to apologize for my relatively harsh 
                                message of<BR>&gt; yesterday. In fact, I was 
                                just really annoyed by your attitudes - you were 
                                100% sure that<BR>&gt; my software "sits on top 
                                of HAL", although you never had a chance to see 
                                it. How can someone<BR>&gt; make ANY(!!!) 
                                assumption about the internals of the program he 
                                has never seen???<BR><BR>I believe I said 'I 
                                haven't seen your code, but...' Upon reflection, 
                                and having been impressed by your approach, I'd 
                                have to say that I think theres very little room 
                                for two such apps operating correctly on one 
                                machine. I'm assuming that your code is only in 
                                place during the entry of 'sensitive' text, such 
                                as a passphrase. Since mine is agressively 
                                testing the IDT is in place your hook is going 
                                to be displaced rather quickly. Your hook will 
                                therefore be taken as the new trampolining 
                                destination and you would end up in second place 
                                (And hooked before). Conversely if we're BOTH 
                                aggressively maintaining the IDT then, well, it 
                                would be fun to watch - but ultimately, bad news 
                                for the PC operator.<BR><BR>&gt; In fact, you 
                                have misinterpreted me - I never said that you 
                                don't know anything. The only<BR>&gt; thing I 
                                said is that you should not be so self-sure - in 
                                fact, ignorance and dismissive<BR>&gt; attitudes 
                                to other people's skills normally go hand in 
                                hand. After all, someone who does<BR>&gt; not 
                                want to listen to other people because he thinks 
                                that he knows everything is very<BR>&gt; 
                                unlikely to discover anything new for himself, 
                                don't you think???<BR><BR>Absolutely. However, 
                                talking about being self-sure... The entire 
                                reason I posted here was that you were claiming 
                                to have made systemwide hooking (Using a 
                                keyboard filter driver) a worthless endeavour 
                                ... which, unless your code is going to be made 
                                a new system-wide approach in the next microsoft 
                                service pack, probably isn't quite 
                                true.<BR><BR>&gt; Now we are even, so let's 
                                proceed to our discussion. I am not going to 
                                take the piss out<BR>&gt; of you any more, but I 
                                still have to point you to something I disagree 
                                with.<BR><BR>&gt; &gt; And also reiterate that 
                                you are quite wrong, you haven't<BR>&gt; &gt; 
                                solved the problem or damaged the effectiveness 
                                of <BR>&gt; &gt; systemwide hooks - you 'may' 
                                have prevented a single <BR>&gt; &gt; 
                                application from being intercepted - but thats 
                                not quite<BR>&gt; &gt; the same thing is it, and 
                                its certainly doesn't put you in <BR>&gt; &gt; a 
                                position to declare all keyboard hooking 
                                irrelevant and <BR>&gt; &gt; doomed to 
                                failure.<BR>&gt;<BR>&gt; Could you please 
                                explain this paragraph. On one hand you claim 
                                that your rootkit is<BR>&gt; able to record 
                                keystrokes on system-wide basis. On the other 
                                hand, you claim that<BR>&gt; my software is able 
                                to protect only some certain 
                                application.<BR><BR>Absolutely<BR><BR>&gt; Where 
                                is the logic behind your statements??? You just 
                                don't seem to realize that my<BR>&gt; software 
                                is, esssentially, exactly the same thing as your 
                                rootkit. The only difference<BR>&gt; between 
                                them is that my software removes the scan code 
                                from the port(which gives my<BR>&gt; software 
                                the additional task of doing the job of both 
                                i8042prt.sys and kbdclass.sys,<BR>&gt; i.e. 
                                translating scan code into VK and inserting data 
                                into kbd input queue), while<BR>&gt; your 
                                rootkit puts it back, so that keystroke gets 
                                processed by the system in a way<BR>&gt; it is 
                                supposed to get processed.<BR><BR>Exactly that. 
                                Since I copy and then resume calling the 
                                original handlers, I would expect my method not 
                                to interfere with further processing - 
                                Applications using the 'standard mechanisms' 
                                still obtain their keypresses.<BR><BR>I am 
                                making two, possibly flawed assumptions....<BR>- 
                                That your code is passing keystrokes directly to 
                                a particular sensitive application<BR>without 
                                standard processing (As ANY standard processing 
                                would be a possible capture vector)<BR>- That 
                                your code is shipped WITH this sensitive 
                                application, and not as a 
                                seperate<BR>(systemwide security upgrade) which 
                                would have to integrate with standard 
                                processing<BR>in order to interoperate with 
                                applications working on the standard message 
                                pump.<BR><BR>Now, whilst I admit its possible 
                                that you may be attempting to erradicate ALL 
                                keylogging systemwide (Thus partially accounting 
                                for your negative statement to the original 
                                poster) this would open up a capture vector at 
                                the user-land side (Message delivery) ... as you 
                                still have to place the message into 
                                unsuspecting applications message loops - and, 
                                whilst you would effectively bypass keyboard 
                                filter drivers, you'd still be allowing for the 
                                interception to take place in user 
                                mode.<BR><BR>To be honest, I don't much care 
                                anymore <IMG 
                                src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/smiley_smile.gif" 
                                align=absMiddle> We both started out with some 
                                strong-minded assertions and its quite funny 
                                that we both did this on the basis of 
                                essentially the same strong techniques. However, 
                                I still doubt highly that Keystroke capture by 
                                way of kernel mode drivers or patching has been 
                                negated (as a systemwide concept) by your 
                                code.<BR><BR>&gt; Now let's proceed to "hardware 
                                rootkits". If you don't mind, let me stick to 
                                this term,<BR>&gt; although, strictly speaking, 
                                it would be more appropriate to call them 
                                "firmware rootkits"<BR>&gt; or "embedded 
                                software rootkits". First of all, let's agree on 
                                the topic of our discussion.<BR>&gt; I am 
                                speaking ONLY (!!!)about PC - this is what I 
                                work with. I don't know ANYTHING (!!!)<BR>&gt; 
                                about Cisco routers and switches, so that you 
                                don't have to mention them.<BR><BR>Shame though, 
                                they are far more interesting <IMG 
                                src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/smiley_wink.gif" 
                                align=absMiddle><BR><BR>&gt; I cannot point you 
                                to any hardware rootkit. As far as I am 
                                concerned, there is no<BR>&gt; publicly 
                                available hardware rootkit -this is why I say 
                                that this is brand-new development<BR>&gt; in 
                                the field of the IT security. Don't get me wrong 
                                - I am not speaking about compromising<BR>&gt; 
                                BIOS (this trick is not new)<BR><BR>I can show 
                                you at least one, possibly two. One was created 
                                by Lord and was crudely demonstrated at HOD in 
                                2003/4. It purportedly works by grabbing the 
                                original image and placing vectors around 
                                certain identifiable entrypoints. It apparently 
                                doesn't directly compromise the box, but rather 
                                reseeds the compromise by causing a small loader 
                                to be placed on the drive.<BR><BR>Thats not 
                                technically the same thing as a BIOS rootkit - 
                                but since a BIOS-only rootkit is of limited 
                                value, one could say that this is the most 
                                useable hybrid solution that is still 'hardware 
                                persistent'<BR><BR>Although well received I 
                                believe it has a number of problems being, by 
                                its nature, specific to certain ranges of bios, 
                                it is probably also OS specific (Having only 
                                seen it demonstrated against NT/2k) and I don't 
                                know if it support systems that boot from SATA 
                                or how it handles RAID volumes. Obviously, its 
                                not going to work on 100% of boxes and would 
                                probably result in an awful lot of mobo 
                                casualties if used indiscriminately in the 
                                wild.<BR><BR>I've never seen the code, as far as 
                                I am aware the code is still unavailable, 
                                however - I know I can hook you up with a 
                                demonstration. I know a few members of Lords 
                                group quite well although they do tend to be 
                                quite picky about which CONs they 
                                frequent.<BR><BR>The other I saw demonstrated 
                                was a demo of an addon for a russian rootkit. 
                                Unfortunately, I have even less details, but the 
                                demonstration was most impressive. I'll try to 
                                get a handle on the author for you.<BR><BR>&gt; 
                                What I am speaking about is placing a 
                                ROOTKIT(!!!) into on-chip memory. 
                                Furthermore,<BR>&gt; although BIOS seems to be 
                                the most obvious target, theoretically rootkit 
                                may be placed<BR>&gt; into any programmable chip 
                                that has on-chip 
                                memory.<BR><BR>Indeed.<BR><BR>&gt; This is why I 
                                say that this is very new and complex topic -I 
                                hope there is no need<BR>&gt; to explain the 
                                difference between operating in stealth mode, 
                                i.e. the way rootkits<BR>&gt; are supposed to 
                                work, and making the machine unbootable. You 
                                mentioned "BIOS buffers"<BR>&gt; in your 
                                original poster, which made me believe that you 
                                claimed to be the author of<BR>&gt; such 
                                rootkit. This is why I took your statement with 
                                some certain degree of sceptisism,<BR>&gt; and 
                                asked you to post the code<BR><BR>Our group has 
                                never written a BIOS exploit, either as a 
                                destructive payload or a backdooring 
                                mechanism... Our core experience as regards 
                                'firmware modification as a means of continued 
                                stealthy access' is Cisco, Juniper and 
                                CobaltRaq, mostly Cisco. Its the same principle, 
                                however, since the whole Operating System 
                                resides there (in the flash) its a great deal 
                                simpler. It is far less hardware specific, and 
                                IMHO is a far more effective cracking tool But 
                                then, you don't want to hear about that : 
                                )<BR><BR>Actually, until just recently - the 
                                number of arguments I've had with network admins 
                                about the ease of cracking and compromising 
                                routers has been astounding. I guess many will 
                                be eating their words now that they are starting 
                                to become public (some 5 years late)<BR><BR>&gt; 
                                In case if you have any idea in this field, I 
                                would be just delighted to hear from you<BR>&gt; 
                                - after all, you seem to know on-board stuff 
                                much better than I do<BR><BR>The best I could do 
                                is hook you up with at least one decent 
                                demonstration. I can't garauntee you're going to 
                                get any detailed discussion on HOW it works (I 
                                didn't) - but you're certainly going to come 
                                away with a firm knowledge of what is already 
                                available in some blackhat groups. Although, I 
                                doubt thats of any great help to you.<BR><BR>It 
                                will certainly be a good example of how the 
                                industry is chasing its own tail. Predominantly 
                                the security industry is reactive rather than 
                                proactive. You may think I'm arrogant in 
                                dismissing most developments in IT security, but 
                                its a billion-dollar baby and I doubt it's in 
                                anyones interests to actually try SOLVING The 
                                problems rather than incrementally REACTING to 
                                them as they occur.<BR><BR>On the other hand, I 
                                have a windows based PC on which modern exploits 
                                fail (I've never had it fall at a 
                                Capture-The-Flag competition - ever!). Every 
                                process is first bounds checked - not only 
                                profiled on file/library requirements (as in 
                                linux chroot jail) but down to individual 
                                imports. If any process steps beyond its bounds 
                                it can dump process memory (capturing the 
                                exploit in-situ: honeypot mode) and restart, or 
                                simply fail the call with a GUI warning (In 
                                stability mode). You simply couldn't get any 
                                service compromised in any useable way using a 
                                stock exploit, known or unknown. Its a 
                                high-granularity rights assignment that wraps 
                                the entire API at the level of individual 
                                exports (at some speed cost, granted) and even 
                                at the parameter level for certain 'risk' APIs. 
                                In fact, I ran IE4 unmnodified right through all 
                                the GodMessage days and I can keep an unpatched 
                                SP1 Win2k box online indefinately without 
                                infection.<BR><BR>Of course, the industry says I 
                                should use a FW and an AV subscription. This 
                                means playing the 'numbers' game and still being 
                                exploitable. Theres more than one way to skin a 
                                cat, and the industry is profiting greatly by 
                                doing it hair by hair.<BR><BR>&gt; 
                                Regards<BR>&gt; Anton<BR><BR>If you want to 
                                continue any aspects of this debate we can move 
                                it to a forum, and optionaly we can delete the 
                                messages here to improve your page loading time. 
                                If you just want me to try to arrange a 
                                demonstration of any 0-day blackhat techniques 
                                then mail me and I'll get in touch with 
                                Ascension, DaVinci and a few other mature groups 
                                and see what CONs they will be attending in the 
                                next few months.<BR><BR>Please respond by mail 
                                (You should find it in the topic-reply 
                                notifications)<BR><BR>Regards,<BR>-Medus<BR><BR>PS<BR><BR>The 
                                reason it would be so much fun to watch your 
                                product and mine try to coexist is because we 
                                SIDT the IDTR so we can trap without disturbing 
                                the old IDTs (which is how we make the transfer 
                                to complete the ISR with the default handling). 
                                Depending on if you recheck the IDT after 
                                setting it you could end up in second place when 
                                it comes to receiving control. Also, depending 
                                on whether you LIDT each time you check, you 
                                could just be aggressively maintaining the 
                                SECOND place rather than the actual hardware 
                                handler, due to the IDT translation. Finally, 
                                the kernel is forced into using the original 
                                IDT, which makes us far more robust to any 
                                checks from above and this may have a bearing on 
                                the result.<BR><BR>Interesting experiment, 
                                no?<BR><BR>I really would like to purchase the 
                                product you coded this for. It certainly has my 
                                commendation - Care to give it a free 
                                advertisement (Or mail me privately)? ... I'd be 
                                very interested to try it out. I won't reveal 
                                the result - And you can even NDA me to that if 
                                you wish.<BR><BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: top">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1289595&amp;floc=/KB/system/kernelspying.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1289595&amp;floc=/KB/system/kernelspying.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;sort=Position&amp;tid=1186793">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=38657&amp;msg=1289595">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=1289595&amp;obtid=3">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF1289595 
                                style="WHITE-SPACE: nowrap">5.00/5 (1 vote)
                                <SCRIPT language=Javascript 
type=text/javascript>
												MsgVoteForm(2464407,1289595);
											</SCRIPT>
                                 
                        </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 
                  src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\t(1).gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=1622863_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=171><A 
                        name=xx1622863xx></A><IMG height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_general.gif" 
                        width=16 valign="absmiddle"></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;select=1622863#xx1622863xx" 
                        name=1622863>Re: kernell mode keylogger</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=2483758">ivan 
                        françois</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">16:55 
                        12 Aug '06 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=1622863_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 171px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>You guys are really 
                                disturbed!<BR>But it was fun reading you and i 
                                think we all learnt a lot of things anyway. 
                                <BR><BR>Take care you nerds!<BR><BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: top">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1622863&amp;floc=/KB/system/kernelspying.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1622863&amp;floc=/KB/system/kernelspying.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;sort=Position&amp;tid=1186793">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=38657&amp;msg=1622863">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=1622863&amp;obtid=3">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF1622863 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT language=Javascript 
type=text/javascript>
												MsgVoteForm(2483758,1622863);
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgDivide><IMG height=1 
                  src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\t(1).gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd HdUnSel " id=2052867_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=176><A 
                        name=xx2052867xx></A><IMG height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_general.gif" 
                        width=16 valign="absmiddle"></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;select=2052867#xx2052867xx" 
                        name=2052867>Re: kernell mode keylogger</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=609533">_DmG_</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">15:34 
                        24 May '07 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=2052867_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 176px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>TOOOOOO FUNNY! .. I was dying 
                                after I read this.<BR><BR>Actually this was of 
                                the most interesting arguments I've read in a 
                                long time. I only wish I understood half the 
                                jargon they used. But in the end, all I could 
                                think was: "Damn these guys needa get 
                                outside".<BR><BR>Was like listening to an NSA 
                                employee vs some Russian Syndicate member. 
                                lol<BR>I consider everyone who has an account 
                                with codeproject to be a nerd, but damn, they 
                                took it to another level.<BR><BR>So guys. ... 
                                can I take a look at both ur source codes. <IMG 
                                src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/smiley_biggrin.gif" 
                                align=absMiddle> <BR><BR>
                                <DIV class=ForumSig>_DmG_</DIV><BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: top">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=2052867&amp;floc=/KB/system/kernelspying.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=2052867&amp;floc=/KB/system/kernelspying.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;sort=Position&amp;tid=1186793">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=38657&amp;msg=2052867">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=2052867&amp;obtid=3">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF2052867 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT language=Javascript 
type=text/javascript>
												MsgVoteForm(609533,2052867);
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgRtDivide><IMG height=1 
                  src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\t(1).gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd Rt HdUnSel " id=1152159_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=16><A 
                        name=xx1152159xx></A><IMG height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_general.gif" 
                        width=16 valign="absmiddle"></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;select=1152159#xx1152159xx" 
                        name=1152159>how to block USB</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=1101818">tungpn</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">18:38 1 
                        Jul '05 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=1152159_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 16px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>Hi everybody,<BR><BR>I used this 
                                demo to spy USB driver and it's OK. Now I want 
                                to prevent USB when user plug RAMDISK into 
                                port.<BR>Could you tell me what request for 
                                DeviceIOControl or any code to prevent 
                                USB?<BR>Thanks you. <BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: top">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1152159&amp;floc=/KB/system/kernelspying.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1152159&amp;floc=/KB/system/kernelspying.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;sort=Position&amp;tid=1152159">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=38657&amp;msg=1152159">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=1152159&amp;obtid=3">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF1152159 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT language=Javascript 
type=text/javascript>
												MsgVoteForm(1101818,1152159);
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR class=Quick>
                <TD class=Frm_MsgRtDivide><IMG height=1 
                  src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\t(1).gif" 
                  width=1 border=0></TD></TR><!-- Start Message head -->
              <TR class="MsgHd Rt HdUnSel " id=1144758_h0>
                <TD width="100%">
                  <TABLE class=QuickHd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent width=16><A 
                        name=xx1144758xx></A><IMG height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_general.gif" 
                        width=16 valign="absmiddle"></TD>
                      <TD class=Frm_MsgSubject><A id=DynMessLink 
                        href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;select=1144758#xx1144758xx" 
                        name=1144758>Locks up on XP</A></TD>
                      <TD style="WIDTH: 20px; WHITE-SPACE: nowrap"><IMG 
                        title=member height=16 
                        src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/member_sm.gif" 
                        border=0></TD>
                      <TD class=Frm_MsgAuthor><A 
                        href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=13155">Todd 
                        Smith</A></TD>
                      <TD class=Frm_MsgDate 
                      style="VERTICAL-ALIGN: top; WHITE-SPACE: nowrap">15:52 
                        23 Jun '05 &nbsp;</TD></TR></TBODY></TABLE></TD></TR><!-- End Message head -->
              <TR id=1144758_h1 style="DISPLAY: none">
                <TD style="WIDTH: 100%">
                  <TABLE class=QuickBd cellSpacing=0 cellPadding=0 width="100%" 
                  border=0>
                    <TBODY>
                    <TR>
                      <TD class=Frm_MsgIndent style="WIDTH: 16px"></TD>
                      <TD class="MsgBd BdSel ">
                        <TABLE cellSpacing=5 cellPadding=0 width="100%" 
border=0>
                          <TBODY>
                          <TR>
                            <TD>
                              <TABLE cellSpacing=0 cellPadding=0 width="100%" 
                              border=0>
                                <TBODY>
                                <TR>
                                <TD colSpan=2>I haven't tried testing this on 
                                older versions of NT/XP but with the current 
                                release of XP + updates I get a system reset 
                                when I try to spy on stuff like tcpip.sys, 
                                http.sys, kbdclass.sys, ws2ifsl.sys, etc. 
                                However it does work when I spy on cdrom.sys. 
                                <BR><BR><B>Todd Smith</B><BR></TD></TR>
                                <TR style="VERTICAL-ALIGN: top">
                                <TD class=Frm_MsgFt><A class=Frm_MHL title=Reply 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1144758&amp;floc=/KB/system/kernelspying.aspx&amp;fa=r">Reply</A>·<A 
                                class=Frm_MHL title=Email 
                                href="http://www.codeproject.com/script/Forums/Edit.aspx?fid=38657&amp;select=1144758&amp;floc=/KB/system/kernelspying.aspx&amp;fa=e">Email</A>·<A 
                                class=Frm_MHL title="View Thread" 
                                href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;sort=Position&amp;tid=1144758">View 
                                Thread</A>·<A class=Frm_MHL 
                                title="Get permanent link" 
                                href="http://www.codeproject.com/script/Forums/View.aspx?fid=38657&amp;msg=1144758">PermaLink</A>·<A 
                                class=Frm_MHL title="Bookmark this post" 
                                href="http://www.codeproject.com/script/Bookmarks/Add.aspx?&amp;obid=1144758&amp;obtid=3">Bookmark</A></TD>
                                <TD class=Frm_MsgFt 
                                style="TEXT-ALIGN: right"><SPAN id=MVF1144758 
                                style="WHITE-SPACE: nowrap">
                                <SCRIPT language=Javascript 
type=text/javascript>
												MsgVoteForm(13155,1144758);
											</SCRIPT>
                                </SPAN></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></TD></TR>
              <TR>
                <TD><IMG height=5 
                  src="E:\CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files\t(1).gif" 
                  width=1 border=0></TD></TR></TBODY></TABLE></TD></TR>
        <TR>
          <TD>
            <TABLE cellSpacing=0 cellPadding=2 width="100%">
              <TBODY>
              <TR class=Frm_Footer>
                <TD>Last Visit: Sunday, February 10, 2008 2:24 AM &nbsp; 
                  &nbsp; Page last updated: Sunday, February 10, 2008 3:43 AM</TD>
                <TD style="WHITE-SPACE: nowrap; TEXT-ALIGN: right"><B>1</B><A 
                  class=Frm_HL 
                  href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;fr=26#xx0xx" 
                  name=Frm_HoverNL>2</A> <A class=Frm_HL 
                  href="http://www.codeproject.com/KB/system/kernelspying.aspx?fid=38657&amp;df=90&amp;mpp=25&amp;noise=3&amp;sort=Position&amp;view=Quick&amp;fr=26#xx0xx" 
                  name=Frm_HoverNL>Next 
      »</A></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></DIV>
      <P class=SmallText><IMG height=16 
      src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_general.gif" 
      width=16 align=absMiddle> General &nbsp;&nbsp; <IMG height=16 
      src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_news.gif" 
      width=16 align=absMiddle> News &nbsp;&nbsp; <IMG height=16 
      src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_question.gif" 
      width=16 align=absMiddle> Question &nbsp;&nbsp; <IMG height=16 
      src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_answer.gif" 
      width=16 align=absMiddle> Answer &nbsp;&nbsp; <IMG height=16 
      src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_joke.gif" 
      width=16 align=absMiddle> Joke &nbsp;&nbsp; <IMG height=16 
      src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/msg_admin.gif" 
      width=16 align=absMiddle> Admin &nbsp;&nbsp; </P><!-- Forum End --></DIV>
      <TABLE width="100%">
        <TBODY>
        <TR vAlign=top>
          <TD class=TinyText align=left><A id=ctl00_PermaLink 
            href="http://www.codeproject.com/script/Articles/Article.aspx?aid=6805">PermaLink</A> 
            | <A id=ctl00_PrivacyLink 
            href="http://www.codeproject.com/info/privacy.aspx">Privacy </A>| <A 
            id=ctl00_TermsOfUseLink 
            href="http://www.codeproject.com/info/TermsOfUse.aspx">Terms of 
            Use</A> <BR>Last Updated: 21 Apr 2004<BR>Editor: <A 
            id=ctl00_ArticleEditor 
            href="http://www.codeproject.com/script/Membership/Profiles.aspx?mid=28970">Smitha 
            Vijayan</A><BR></TD>
          <TD class=TinyText vAlign=top align=right>Copyright 2004 by Anton 
            Bassov<BR>Everything else Copyright © <A 
            href="mailto:webmaster@codeproject.com">CodeProject</A>, 
            1999-2008<BR>Web15 | <A id=ctl00_AdvertiseLink 
            href="http://www.codeproject.com/info/MediaKit.aspx">Advertise on 
            the Code Project </A></TD></TR></TBODY></TABLE></TD></TR>
  <TR>
    <TD align=middle colSpan=2></TD></TR></TBODY></TABLE>
<SCRIPT language=Javascript 
src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/front.asp" 
type=text/javascript></SCRIPT>

<SCRIPT language=Javascript type=text/javascript><!--
if (document.all) try {window.attachEvent("oncopy",copyCode);}catch(e){};
--></SCRIPT>

<SCRIPT language=Javascript 
src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/TogglePre.js" 
type=text/javascript></SCRIPT>

<SCRIPT language=Javascript 
src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/menu132_com.js" 
type=text/javascript></SCRIPT>

<SCRIPT language=Javascript 
src="CodeProject Kernel-mode API spying - an ultimate hack_ Free source code and programming help_files/TopNavBar.js" 
type=text/javascript></SCRIPT>

<SCRIPT language=Javascript type=text/javascript><!--
new HVMenu(new menu_NavbarConfig());
--></SCRIPT>
</BODY></HTML>

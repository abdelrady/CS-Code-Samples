<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<HTML lang="en-us">
<HEAD>
<TITLE>Windows API Guide: RegQueryValueEx Function</TITLE>
<META content="vbapi@vbapi.com" name="author">
<META content="Information about the RegQueryValueEx function in the Windows API, geared towards the Visual Basic user." name="description">
<META content="Kuliniewicz,Windows,Windows 95,Windows NT,Windows 98,Windows CE,Windows 2000,API,Application Programming Interface,Programming,Visual Basic,Basic,VB,RegQueryValueEx" name="keywords">
<META content="Omicron HTML Editor" name="generator">
<LINK href="default.css" tppabs="http://www.vbapi.com/css/default.css" rel="stylesheet" type="text/css">
<LINK href="index-1.html" tppabs="http://www.vbapi.com/index.html" rel="home">
<LINK href="glossary.html" tppabs="http://www.vbapi.com/ref/glossary.html" rel="glossary">
<LINK href="copyrite.html" tppabs="http://www.vbapi.com/copyrite.html" rel="copyright">
</HEAD>
<BODY>

<!-- Begin Adslot1 -->
<CENTER>
<SCRIPT language="JAVASCRIPT">
<!-- hide from older browsers
now = new Date();
my_random = now.getTime();
document.write('<A href="http://adex3.flycast.com/server/socket/127.0.0.1:2800/click/VBWorldnet/VBAPI/' + my_random + '">');
document.write('<IMG width="468" height="60" border="1" src="http://adex3.flycast.com/server/socket/127.0.0.1:2800/ad/VBWorldnet/VBAPI/' + my_random + '"></A>');
// -->
</SCRIPT>
</CENTER>
<!-- End Adslot1 -->

<HR>

<H1>RegQueryValueEx Function</H1>

<P><CODE class="declare"><SPAN class="kw">Declare Function</SPAN> RegQueryValueEx <SPAN class="kw">Lib</SPAN> "advapi32.dll" <SPAN class="kw">Alias</SPAN> "RegQueryValueExA" (<SPAN class="kw">ByVal</SPAN> hKey <SPAN class="kw">As Long</SPAN>, <SPAN class="kw">ByVal</SPAN> lpValueName <SPAN class="kw">As String</SPAN>, <SPAN class="kw">ByVal</SPAN> lpReserved <SPAN class="kw">As Long</SPAN>, lpType <SPAN class="kw">As Long</SPAN>, lpData <SPAN class="kw">As Any</SPAN>, lpcbData <SPAN class="kw">As Long</SPAN>) <SPAN class="kw">As Long</SPAN></CODE></P>

<H2>Platforms</H2>
<P><UL>
<LI><B>Windows 95:</B> Supported.
<LI><B>Windows 98:</B> Supported.
<LI><B>Windows NT:</B> Requires Windows NT 3.1 or later.
<LI><B>Windows 2000:</B> Supported.
<LI><B>Windows CE:</B> Requires Windows CE 1.0 or later.
</UL></P>

<H2>Description &amp; Usage</H2>
<P><B>RegQueryValueEx</B> reads a value from a registry key.  It can read many different types of data, including integers, strings, and any other registry data types.  When calling the function, the program does not have to know what the data type of the value being read is.  Instead, the program receives information telling it what type of data was read.</P>

<H2>Return Value</H2>
<P>If an error occued, the function returns a non-zero error code.  If successful, the function returns 0.</P>

<H2>Visual Basic-Specific Issues</H2>
<P>When putting the data read from the registry into a string, the <VAR>lpData</VAR> parameter must be prefixed by the ByVal keyword.  The ByVal keyword is not necessary with any other data types passed as that parameter.</P>

<H2>Parameters</H2>
<P><DL>
<DT><VAR>hKey</VAR><DD>A <A class="def" href="glossary.html#handle" tppabs="http://www.vbapi.com/ref/glossary.html#handle" rel="glossary">handle</A> to the registry key to read the value from.  This could also be one of the following flags identifying one of the predefined registry base keys.  The flags have identical names to the registry base keys they specify.
<DL>
<DT>HKEY_CLASSES_ROOT
<DT>HKEY_CURRENT_CONFIG
<DT>HKEY_CURRENT_USER
<DT>HKEY_DYN_DATA <B>(Windows 95, 98 only)</B>
<DT>HKEY_LOCAL_MACHINE
<DT>HKEY_PERFORMANCE_DATA <B>(Windows NT, 2000 only)</B>
<DT>HKEY_USERS
</DL>
<DT><VAR>lpValueName</VAR><DD>The name of the value to read.
<DT><VAR>Reserved</VAR><DD>Reserved.  Set to 0.
<DT><VAR>lpType</VAR><DD>Receives one of the following flags identifying the data type of the data being read:
<DL>
<DT>REG_BINARY<DD>A non-text sequence of bytes.
<DT>REG_DWORD<DD>Same as REG_DWORD_LITTLE_ENDIAN.
<DT>REG_DWORD_BIG_ENDIAN<DD>A 32-bit integer stored in big-endian format.  This is the opposite of the way Intel-based computers normally store numbers -- the byte order is reversed.
<DT>REG_DWORD_LITTLE_ENDIAN<DD>A 32-bit integer stored in little-endian format.  This is the way Intel-based computers store numbers.
<DT>REG_EXPAND_SZ<DD>A null-terminated string which contains unexpanded environment variables.
<DT>REG_LINK<DD>A Unicode symbolic link.
<DT>REG_MULTI_SZ<DD>A series of strings, each separated by a null character and the entire set terminated by a two null characters.
<DT>REG_NONE<DD>No data type.
<DT>REG_RESOURCE_LIST<DD>A list of resources in the resource map.
<DT>REG_SZ<DD>A string terminated by a null character.
</DL>
<DT><VAR>lpData</VAR><DD>Variable, array, or some other object that receives the information read from the registry.
<DT><VAR>lpcbData</VAR><DD>Set this to the length in bytes of whatever was passed as <VAR>lpData</VAR> to receive the data read from the registry.  This parameter also receives the length in bytes of the data actually read from the registry.
</DL></P>

<H2>Constant Definitions</H2>
<P><PRE><CODE class="const"><SPAN class="kw">Const</SPAN> HKEY_CLASSES_ROOT = &amp;H80000000
<SPAN class="kw">Const</SPAN> HKEY_CURRENT_CONFIG = &amp;H80000005
<SPAN class="kw">Const</SPAN> HKEY_CURRENT_USER = &amp;H80000001
<SPAN class="kw">Const</SPAN> HKEY_DYN_DATA = &amp;H80000006
<SPAN class="kw">Const</SPAN> HKEY_LOCAL_MACHINE = &amp;H80000002
<SPAN class="kw">Const</SPAN> HKEY_PERFORMANCE_DATA = &amp;H80000004
<SPAN class="kw">Const</SPAN> HKEY_USERS = &amp;H80000003
<SPAN class="kw">Const</SPAN> REG_BINARY = 3
<SPAN class="kw">Const</SPAN> REG_DWORD = 4
<SPAN class="kw">Const</SPAN> REG_DWORD_BIG_ENDIAN = 5
<SPAN class="kw">Const</SPAN> REG_DWORD_LITTLE_ENDIAN = 4
<SPAN class="kw">Const</SPAN> REG_EXPAND_SZ = 2
<SPAN class="kw">Const</SPAN> REG_LINK = 6
<SPAN class="kw">Const</SPAN> REG_MULTI_SZ = 7
<SPAN class="kw">Const</SPAN> REG_NONE = 0
<SPAN class="kw">Const</SPAN> REG_RESOURCE_LIST = 8
<SPAN class="kw">Const</SPAN> REG_SZ = 1</CODE></PRE></P>

<H2>Example</H2>
<P>Open the registry key HKEY_CURRENT_USER\Software\MyCorp\MyProgram\Config and read the value named "username" stored in it.  The example given for the <A href="regsetvalueex.html" tppabs="http://www.vbapi.com/ref/r/regsetvalueex.html">RegSetValueEx</A> function creates this key and sets the value appropriately.  The example runs when button Command1 is pressed.  To run this example, you need to place a command button named Command1 inside a form window.

<P><PRE><CODE class="example"><SPAN class="com">' This code is licensed according to the terms and conditions listed <A href="copyrite.html#license" tppabs="http://www.vbapi.com/copyrite.html#license" rel="copyright">here</A>.</SPAN>

<SPAN class="com">' Declarations and such needed for the example:
' (Copy them to the (declarations) section of a module.)</SPAN>
<SPAN class="kw">Public Declare Function</SPAN> <A href="regopenkeyex.html" tppabs="http://www.vbapi.com/ref/r/regopenkeyex.html">RegOpenKeyEx</A> <SPAN class="kw">Lib</SPAN> "advapi32.dll" <SPAN class="kw">Alias</SPAN> "RegOpenKeyExA" (<SPAN class="kw">ByVal</SPAN> _
	hKey <SPAN class="kw">As Long</SPAN>, <SPAN class="kw">ByVal</SPAN> lpSubKey <SPAN class="kw">As String</SPAN>, <SPAN class="kw">ByVal</SPAN> ulOptions <SPAN class="kw">As Long</SPAN>, <SPAN class="kw">ByVal</SPAN> samDesired _
	<SPAN class="kw">As Long</SPAN>, phkResult <SPAN class="kw">As Long</SPAN>) <SPAN class="kw">As Long</SPAN>
<SPAN class="kw">Public Declare Function</SPAN> <B>RegQueryValueEx</B> <SPAN class="kw">Lib</SPAN> "advapi32.dll" <SPAN class="kw">Alias</SPAN> "RegQueryValueExA" _
	(<SPAN class="kw">ByVal</SPAN> hKey <SPAN class="kw">As Long</SPAN>, <SPAN class="kw">ByVal</SPAN> lpValueName <SPAN class="kw">As String</SPAN>, <SPAN class="kw">ByVal</SPAN> lpReserved <SPAN class="kw">As Long</SPAN>, _
	lpType <SPAN class="kw">As Long</SPAN>, lpData <SPAN class="kw">As Any</SPAN>, lpcbData <SPAN class="kw">As Long</SPAN>) <SPAN class="kw">As Long</SPAN>
<SPAN class="kw">Public Declare Function</SPAN> <A href="regclosekey.html" tppabs="http://www.vbapi.com/ref/r/regclosekey.html">RegCloseKey</A> <SPAN class="kw">Lib</SPAN> "advapi32.dll" (<SPAN class="kw">ByVal</SPAN> hKey <SPAN class="kw">As Long</SPAN>) <SPAN class="kw">As Long</SPAN>
<SPAN class="kw">Public Const</SPAN> HKEY_CURRENT_USER = &amp;H80000001
<SPAN class="kw">Public Const</SPAN> KEY_READ = &H20019
<SPAN class="kw">Public Const</SPAN> REG_SZ = 1

<SPAN class="com">' *** Place the following code inside the form window. ***</SPAN>

<SPAN class="kw">Private Sub</SPAN> Command1_Click()
	<SPAN class="kw">Dim</SPAN> hKey <SPAN class="kw">As Long</SPAN>  <SPAN class="com">' receives a handle to the newly created or opened registry key</SPAN>
	<SPAN class="kw">Dim</SPAN> subkey <SPAN class="kw">As String</SPAN>  <SPAN class="com">' name of the subkey to open</SPAN>
	<SPAN class="kw">Dim</SPAN> stringbuffer <SPAN class="kw">As String</SPAN>  <SPAN class="com">' receives data read from the registry</SPAN>
	<SPAN class="kw">Dim</SPAN> datatype <SPAN class="kw">As Long</SPAN>  <SPAN class="com">' receives data type of read value</SPAN>
	<SPAN class="kw">Dim</SPAN> slength <SPAN class="kw">As Long</SPAN>  <SPAN class="com">' receives length of returned data</SPAN>
	<SPAN class="kw">Dim</SPAN> retval <SPAN class="kw">As Long</SPAN>  <SPAN class="com">' return value</SPAN>

	<SPAN class="com">' Set the name of the new key and the default security settings</SPAN>
	subkey = "Software\MyCorp\MyProgram\Config"

	<SPAN class="com">' Create or open the registry key</SPAN>
	retval = <A href="regopenkeyex.html" tppabs="http://www.vbapi.com/ref/r/regopenkeyex.html">RegOpenKeyEx</A>(HKEY_CURRENT_USER, subkey, 0, KEY_READ, hKey)
	<SPAN class="kw">If</SPAN> retval &lt;&gt; 0 <SPAN class="kw">Then</SPAN>
		<SPAN class="kw">Debug</SPAN>.<SPAN class="kw">Print</SPAN> "ERROR: Unable to open registry key!"
		<SPAN class="kw">Exit Sub</SPAN>
	<SPAN class="kw">End If</SPAN>

	<SPAN class="com">' Make room in the buffer to receive the incoming data.</SPAN>
	stringbuffer = Space(255)
	slength = 255
	<SPAN class="com">' Read the "username" value from the registry key.</SPAN>
	retval = <B>RegQueryValueEx</B>(hKey, "username", 0, datatype, <SPAN class="kw">ByVal</SPAN> stringbuffer, slength)
	<SPAN class="com">' Only attempt to display the data if it is in fact a string.</SPAN>
	<SPAN class="kw">If</SPAN> datatype = REG_SZ <SPAN class="kw">Then</SPAN>
		<SPAN class="com">' Remove empty space from the buffer and display the result.</SPAN>
		stringbuffer = Left(stringbuffer, slength - 1)
		<SPAN class="kw">Debug</SPAN>.<SPAN class="kw">Print</SPAN> "Username: "; stringbuffer
	<SPAN class="kw">Else</SPAN>
		<SPAN class="com">' Don't bother trying to read any other data types.</SPAN>
		<SPAN class="kw">Debug</SPAN>.<SPAN class="kw">Print</SPAN> "Data not in string format.  Unable to interpret data."
	<SPAN class="kw">End If</SPAN>

	<SPAN class="com">' Close the registry key.</SPAN>
	retval = <A href="regclosekey.html" tppabs="http://www.vbapi.com/ref/r/regclosekey.html">RegCloseKey</A>(hKey)
<SPAN class="kw">End Sub</SPAN></CODE></PRE></P>

<H2>See Also</H2>
<P><A href="regdeletevalue.html" tppabs="http://www.vbapi.com/ref/r/regdeletevalue.html">RegDeleteValue</A>, <A href="regsetvalueex.html" tppabs="http://www.vbapi.com/ref/r/regsetvalueex.html">RegSetValueEx</A></P>

<H2>Category</H2>
<P><A href="funcc.html#registry" tppabs="http://www.vbapi.com/ref/funcc.html#registry">Registry</A></P>

<P><A href="funca.html" tppabs="http://www.vbapi.com/ref/funca.html">Go back to the Function listing.</A><BR>
<A href="index.html" tppabs="http://www.vbapi.com/ref/index.html">Go back to the Reference section index.</A></P>

<HR>

<P><B>Last Modified:</B> January 21, 2001<BR>
This page is copyright &copy; 2001 Paul Kuliniewicz.  
<A href="copyrite.html" tppabs="http://www.vbapi.com/copyrite.html" rel="copyright">Copyright Information</A>  <B>Revised October 29, 2000</B><BR>
<A href="index-1.html" tppabs="http://www.vbapi.com/index.html">Go back to the Windows API Guide home page.</A><BR>
E-mail: <A href="javascript:if(confirm('http://www.vbapi.com/email.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.vbapi.com/email.html'" tppabs="http://www.vbapi.com/email.html">vbapi@vbapi.com</A>  <A href="javascript:if(confirm('http://www.vbapi.com/email.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.vbapi.com/email.html#secure'" tppabs="http://www.vbapi.com/email.html#secure">Send Encrypted E-Mail</A><BR>
This page is at <A href="regqueryvalueex.html" tppabs="http://www.vbapi.com/ref/r/regqueryvalueex.html">http://www.vbapi.com/ref/r/regqueryvalueex.html</A></P>
</BODY>
</HTML>